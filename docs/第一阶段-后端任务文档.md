# 第一阶段 - 后端任务文档
## 珠子材料库管理后台 - 基础材料管理功能

### 阶段目标
实现基础的材料管理和分类管理API接口，提供完整的CRUD功能。

---

## 数据库设计

### 1. 材料表（materials）
```sql
{
  _id: ObjectId,
  materialId: String,      // 材料唯一标识
  name: String,           // 材料名称
  categoryId: String,     // 分类ID
  price: Number,          // 价格
  stock: Number,          // 库存数量
  description: String,    // 材料描述
  color: String,          // 颜色
  hardness: Number,       // 硬度(1-10)
  density: Number,        // 密度
  status: String,         // 状态：enabled/disabled
  createdAt: Date,        // 创建时间
  updatedAt: Date,        // 更新时间
  createdBy: String,      // 创建人
  updatedBy: String       // 更新人
}
```

### 2. 分类表（categories）
```sql
{
  _id: ObjectId,
  categoryId: String,     // 分类唯一标识
  name: String,           // 分类名称
  parentId: String,       // 父分类ID，null表示根分类
  description: String,    // 分类描述
  sortOrder: Number,      // 排序值
  level: Number,          // 层级深度
  path: String,           // 分类路径，如：/1/2/3
  materialCount: Number,  // 该分类下的材料数量
  status: String,         // 状态：enabled/disabled
  createdAt: Date,        // 创建时间
  updatedAt: Date,        // 更新时间
  createdBy: String,      // 创建人
  updatedBy: String       // 更新人
}
```

---

## API接口定义

### 1. 材料管理接口

#### 1.1 获取材料列表
**接口地址**：`POST /api/material/list`

**请求参数**：
```json
{
  "page": 1,              // 页码，必填，>= 1
  "pageSize": 20,         // 每页数量，必填，范围[10,20,50]
  "keyword": "",          // 搜索关键词，可选，最大长度50
  "categoryId": "",       // 分类ID，可选
  "status": ""            // 状态筛选，可选，值：enabled/disabled
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "materialId": "M001",
        "name": "红玛瑙",
        "categoryId": "C001",
        "categoryName": "宝石类",
        "price": 15.50,
        "stock": 100,
        "description": "天然红玛瑙",
        "color": "红色",
        "hardness": 7,
        "density": 2.65,
        "status": "enabled",
        "createdAt": "2024-01-01T00:00:00.000Z",
        "updatedAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

**字段校验规则**：
- page：必填，整数，>= 1
- pageSize：必填，整数，值必须为10、20或50
- keyword：可选，字符串，最大长度50
- categoryId：可选，字符串，必须是有效的分类ID
- status：可选，字符串，值为"enabled"或"disabled"

#### 1.2 获取材料详情
**接口地址**：`GET /api/material/detail`

**请求参数**：
```json
{
  "materialId": "M001"    // 材料ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "materialId": "M001",
    "name": "红玛瑙",
    "categoryId": "C001",
    "price": 15.50,
    "stock": 100,
    "description": "天然红玛瑙",
    "color": "红色",
    "hardness": 7,
    "density": 2.65,
    "status": "enabled",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID

#### 1.3 创建材料
**接口地址**：`POST /api/material/create`

**请求参数**：
```json
{
  "name": "红玛瑙",         // 材料名称，必填
  "categoryId": "C001",    // 分类ID，必填
  "price": 15.50,         // 价格，必填
  "stock": 100,           // 库存数量，必填
  "description": "天然红玛瑙", // 描述，可选
  "color": "红色",         // 颜色，可选
  "hardness": 7,          // 硬度，可选
  "density": 2.65,        // 密度，可选
  "status": "enabled"     // 状态，可选，默认enabled
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "materialId": "M001"
  }
}
```

**字段校验规则**：
- name：必填，字符串，长度2-50，不能包含特殊字符
- categoryId：必填，字符串，必须是有效的分类ID
- price：必填，数值，>= 0，最多2位小数
- stock：必填，整数，>= 0
- description：可选，字符串，最大长度500
- color：可选，字符串，长度1-20
- hardness：可选，数值，范围1-10
- density：可选，数值，> 0
- status：可选，字符串，值为"enabled"或"disabled"，默认"enabled"

#### 1.4 更新材料
**接口地址**：`POST /api/material/update`

**请求参数**：
```json
{
  "materialId": "M001",    // 材料ID，必填
  "name": "红玛瑙",         // 材料名称，必填
  "categoryId": "C001",    // 分类ID，必填
  "price": 15.50,         // 价格，必填
  "stock": 100,           // 库存数量，必填
  "description": "天然红玛瑙", // 描述，可选
  "color": "红色",         // 颜色，可选
  "hardness": 7,          // 硬度，可选
  "density": 2.65,        // 密度，可选
  "status": "enabled"     // 状态，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**字段校验规则**：与创建材料接口相同，另外：
- materialId：必填，字符串，必须是有效的材料ID

#### 1.5 删除材料
**接口地址**：`POST /api/material/delete`

**请求参数**：
```json
{
  "materialId": "M001"    // 材料ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID

#### 1.6 批量删除材料
**接口地址**：`POST /api/material/batch-delete`

**请求参数**：
```json
{
  "materialIds": ["M001", "M002", "M003"]  // 材料ID数组，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量删除成功",
  "data": {
    "successCount": 3,
    "failedCount": 0,
    "failedIds": []
  }
}
```

**字段校验规则**：
- materialIds：必填，数组，长度1-100，每个元素必须是有效的材料ID

#### 1.7 切换材料状态
**接口地址**：`POST /api/material/toggle-status`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "status": "disabled"    // 目标状态，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "状态更新成功",
  "data": null
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- status：必填，字符串，值为"enabled"或"disabled"

---

### 2. 分类管理接口

#### 2.1 获取分类树
**接口地址**：`GET /api/category/tree`

**请求参数**：无

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "categoryId": "C001",
      "name": "宝石类",
      "parentId": null,
      "description": "各种宝石材料",
      "sortOrder": 1,
      "level": 1,
      "materialCount": 25,
      "status": "enabled",
      "children": [
        {
          "categoryId": "C002",
          "name": "玛瑙",
          "parentId": "C001",
          "description": "玛瑙类宝石",
          "sortOrder": 1,
          "level": 2,
          "materialCount": 10,
          "status": "enabled",
          "children": []
        }
      ]
    }
  ]
}
```

#### 2.2 获取所有分类列表
**接口地址**：`GET /api/category/list-all`

**请求参数**：无

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "categoryId": "C001",
      "name": "宝石类",
      "parentId": null,
      "level": 1,
      "path": "/C001"
    },
    {
      "categoryId": "C002",
      "name": "玛瑙",
      "parentId": "C001",
      "level": 2,
      "path": "/C001/C002"
    }
  ]
}
```

#### 2.3 创建分类
**接口地址**：`POST /api/category/create`

**请求参数**：
```json
{
  "name": "水晶类",         // 分类名称，必填
  "parentId": "C001",      // 父分类ID，可选
  "description": "各种水晶材料", // 描述，可选
  "sortOrder": 1           // 排序值，可选，默认0
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "categoryId": "C003"
  }
}
```

**字段校验规则**：
- name：必填，字符串，长度2-30，同级分类名称不能重复
- parentId：可选，字符串，必须是有效的分类ID
- description：可选，字符串，最大长度200
- sortOrder：可选，整数，>= 0，默认0

#### 2.4 更新分类
**接口地址**：`POST /api/category/update`

**请求参数**：
```json
{
  "categoryId": "C003",    // 分类ID，必填
  "name": "水晶类",         // 分类名称，必填
  "parentId": "C001",      // 父分类ID，可选
  "description": "各种水晶材料", // 描述，可选
  "sortOrder": 1           // 排序值，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**字段校验规则**：与创建分类接口相同，另外：
- categoryId：必填，字符串，必须是有效的分类ID

#### 2.5 删除分类
**接口地址**：`POST /api/category/delete`

**请求参数**：
```json
{
  "categoryId": "C003"     // 分类ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**字段校验规则**：
- categoryId：必填，字符串，必须是有效的分类ID
- 业务规则：分类下不能有子分类和材料才能删除

#### 2.6 移动分类
**接口地址**：`POST /api/category/move`

**请求参数**：
```json
{
  "categoryId": "C003",    // 要移动的分类ID，必填
  "targetParentId": "C002", // 目标父分类ID，可选，null表示移动到根级
  "sortOrder": 2           // 新的排序值，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "移动成功",
  "data": null
}
```

**字段校验规则**：
- categoryId：必填，字符串，必须是有效的分类ID
- targetParentId：可选，字符串，必须是有效的分类ID，不能是自己或自己的子分类
- sortOrder：必填，整数，>= 0

---



## 单元测试要求

### 1. 材料管理测试用例

**测试账号**：
- 用户名：adminabaaaba
- 密码：xxx13579!

**测试用例**：
1. **创建材料测试**：
   - 正常创建材料
   - 必填字段为空的错误处理
   - 字段长度超限的错误处理
   - 价格和库存为负数的错误处理
   - 分类ID不存在的错误处理

2. **查询材料测试**：
   - 分页查询正常情况
   - 关键词搜索功能
   - 分类筛选功能
   - 状态筛选功能
   - 分页参数异常处理

3. **更新材料测试**：
   - 正常更新材料信息
   - 材料ID不存在的错误处理
   - 字段校验错误处理

4. **删除材料测试**：
   - 单个删除功能
   - 批量删除功能
   - 删除不存在材料的错误处理

5. **状态切换测试**：
   - 启用/禁用状态切换
   - 状态参数错误处理

### 2. 分类管理测试用例

**测试用例**：
1. **创建分类测试**：
   - 创建根分类
   - 创建子分类
   - 同级分类名称重复的错误处理
   - 父分类不存在的错误处理

2. **查询分类测试**：
   - 获取分类树结构
   - 获取所有分类列表

3. **更新分类测试**：
   - 正常更新分类信息
   - 分类ID不存在的错误处理

4. **删除分类测试**：
   - 删除空分类
   - 删除有子分类的分类（应该失败）
   - 删除有材料的分类（应该失败）

5. **移动分类测试**：
   - 正常移动分类
   - 移动到自己子分类的错误处理
   - 目标父分类不存在的错误处理

---

## 性能要求

1. **响应时间**：
   - 查询接口响应时间 < 500ms
   - 创建/更新接口响应时间 < 1000ms

2. **并发处理**：
   - 支持100个并发请求
   - 数据库连接池配置合理

3. **数据库索引**：
   - 材料表：name, categoryId, status, createdAt
   - 分类表：name, parentId, sortOrder

---

## 安全要求

1. **输入验证**：
   - 所有输入参数必须进行校验
   - 防止SQL注入和XSS攻击

2. **权限控制**：
   - 所有接口需要登录验证
   - 操作日志记录

3. **数据完整性**：
   - 关键操作使用事务处理
   - 外键约束检查