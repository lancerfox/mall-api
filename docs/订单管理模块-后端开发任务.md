## 后端任务开发文档

| 项目 | 说明 |
| :--- | :--- |
| 文档版本 | V1.0 |
| 编写人 | Qwen Code |
| 编写日期 | 2025-09-29 |
| 关联需求 | 订单管理模块PRD.md |
| 所属模块 | 订单中心 |
| 技术栈 | NestJS + TypeScript + PostgreSQL + TypeORM + Swagger + Jest |

### 任务总览

| 任务ID | 功能标题 | 任务类型 | 前置依赖 | 核心目标 | 优先级 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| TASK-BE-001 | 订单管理-列表查询接口 | 展示类 | - | 提供筛选查询订单列表 | 高 |
| TASK-BE-002 | 订单管理-详情查询接口 | 展示类 | - | 提供订单完整信息查询 | 高 |
| TASK-BE-006 | 订单管理-状态字典接口 | 展示类 | - | 提供订单状态枚举与中文描述映射 | 高 |
| TASK-BE-003 | 订单管理-发货接口 | 操作类 | - | 处理订单发货业务 | 高 |
| TASK-BE-004 | 订单管理-关闭订单接口 | 操作类 | - | 处理订单关闭业务 | 中 |
| TASK-BE-005 | 订单管理-修改地址接口 | 操作类 | - | 处理订单地址修改业务 | 低 |

---

### TASK-BE-001: 订单管理-列表查询接口

#### 1. 任务基础信息
- **任务ID**: TASK-BE-001
- **功能标题**: 订单管理-列表查询接口
- **任务类型**: 展示类
- **前置依赖**: -
- **关联任务**: TASK-FE-001

#### 2. 任务描述
- **功能目标**: 提供订单列表查询接口，支持按订单编号、用户信息、订单状态和下单时间等条件筛选。
- **适用场景**: 供前端订单列表页面调用，获取订单数据以供展示。

#### 3. 接口设计与关联 (API Design)
- **接口路径**: `GET /api/orders/list`
- **请求方法**: `GET`

##### 请求参数 (Request Params)
| 字段名 | 类型 | 是否必填 | 校验规则/说明 |
| :--- | :--- | :--- | :--- |
| `order_number` | String | 否 | 精确搜索订单编号 |
| `receiver_info` | String | 否 | 模糊搜索收货人姓名或手机号 |
| `status` | String | 否 | 订单状态筛选，枚举值：PENDING_PAYMENT, TO_BE_SHIPPED, SHIPPED, COMPLETED, CLOSED, AFTER_SALES |
| `start_time` | String | 否 | 下单时间范围-开始时间 |
| `end_time` | String | 否 | 下单时间范围-结束时间 |
| `page` | Number | 否 | 页码，默认为1 |
| `size` | Number | 否 | 每页数量，默认为10 |

##### 响应体 (Response Body)
```json
// 成功响应示例
{
  "code": 200,
  "message": "Success",
  "data": {
    "items": [
      {
        "id": "1",
        "order_number": "ORD202509290001",
        "customer_name": "张三",
        "customer_phone": "13800138000",
        "total_amount": 129.90,
        "status": "TO_BE_SHIPPED",
        "created_at": "2025-09-29 10:30:00",
        "product_info": [
          {
            "product_image": "https://example.com/product1.jpg",
            "product_name": "商品A",
            "sku_spec": "规格：XL 颜色：红色",
            "quantity": 1
          }
        ]
      }
    ],
    "total": 100,
    "current_page": 1,
    "page_size": 10
  }
}
```

#### 4. 核心业务逻辑 (Business Logic)
1. 校验输入参数的合法性
2. 根据查询条件构建数据库查询语句
3. 执行查询，获取订单列表数据
4. 格式化返回数据结构
5. 记录查询日志并返回结果

#### 5. 开发流程 (Development Process)
- **功能开发阶段**:
  - 实现订单列表查询接口功能
  - 完成参数校验逻辑
  - 实现数据库查询功能
  - 实现分页逻辑
  - 添加查询日志记录功能
- **单元测试阶段**:
  - **参数校验测试**:
    - 测试订单编号参数的格式校验
    - 测试用户信息参数的格式校验
    - 测试订单状态参数的枚举值校验
    - 测试时间范围参数的格式校验
    - 测试页码和页面大小参数的有效性校验
  - **正常流程测试**:
    - 测试无筛选条件时的查询功能
    - 测试按订单编号筛选的查询功能
    - 测试按用户信息筛选的查询功能
    - 测试按订单状态筛选的查询功能
    - 测试按下单时间范围筛选的查询功能
    - 测试分页功能的正确性
  - **边界条件测试**:
    - 测试空列表情况
    - 测试单页数据量边界
    - 测试页码超出范围情况
  - **异常流程测试**:
    - 测试无效参数输入
    - 测试数据库查询异常处理
    - 测试查询超时处理

---

### TASK-BE-002: 订单管理-详情查询接口

#### 1. 任务基础信息
- **任务ID**: TASK-BE-002
- **功能标题**: 订单管理-详情查询接口
- **任务类型**: 展示类
- **前置依赖**: -
- **关联任务**: TASK-FE-002

#### 2. 任务描述
- **功能目标**: 提供订单详情查询接口，返回订单的完整信息包括基本信息、商品清单、支付与物流信息等。
- **适用场景**: 供前端订单详情页面调用，获取单个订单的详细信息。

#### 3. 接口设计与关联 (API Design)
- **接口路径**: `GET /api/orders/detail`
- **请求方法**: `GET`

##### 请求参数 (Request Params)
| 字段名 | 类型 | 是否必填 | 校验规则/说明 |
| :--- | :--- | :--- | :--- |
| `id` | String | 是 | 订单ID |

##### 响应体 (Response Body)
```json
// 成功响应示例
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": "1",
    "order_number": "ORD202509290001",
    "status": "TO_BE_SHIPPED",
    "created_at": "2025-09-29 10:30:00",
    "paid_at": "2025-09-29 10:45:00",
    "shipped_at": null,
    "customer_info": {
      "name": "张三",
      "phone": "13800138000",
      "address": "北京市朝阳区xxx街道xxx号"
    },
    "items": [
      {
        "product_image": "https://example.com/product1.jpg",
        "product_name": "商品A",
        "sku_spec": "规格：XL 颜色：红色",
        "price": 129.90,
        "quantity": 1,
        "subtotal": 129.90
      }
    ],
    "payment_info": {
      "method": "微信支付",
      "transaction_id": "WX202509290001",
      "status": "已支付"
    },
    "shipping_info": {
      "company": "顺丰快递",
      "tracking_number": "SF1234567890",
      "tracking_details": [
        {
          "time": "2025-09-29 15:00:00",
          "status": "已揽收"
        }
      ]
    },
    "remark": "用户要求优先发货",
    "operation_log": [
      {
        "operator": "管理员A",
        "action": "将订单标记为已发货",
        "time": "2025-09-29 15:30:00"
      }
    ]
  }
}
```

#### 4. 核心业务逻辑 (Business Logic)
1. 校验订单ID参数的合法性
2. 查询订单主记录
3. 查询订单项信息
4. 查询支付信息
5. 查询物流信息及轨迹
6. 查询订单备注和操作日志
7. 整合所有信息并返回

#### 5. 开发流程 (Development Process)
- **功能开发阶段**:
  - 实现订单详情查询接口功能
  - 完成订单ID参数校验逻辑
  - 实现订单主记录查询功能
  - 实现订单项信息查询功能
  - 实现支付信息查询功能
  - 实现物流信息及轨迹查询功能
  - 实现订单备注和操作日志查询功能
  - 整合所有信息并返回
- **单元测试阶段**:
  - **参数校验测试**:
    - 测试订单ID为有效字符串格式的校验
    - 测试订单ID为无效格式的异常情况
    - 测试订单ID为非字符串格式的异常情况
  - **正常流程测试**:
    - 测试查询存在的订单详情
    - 测试返回完整的订单信息（基本信息、商品清单、支付信息、物流信息等）
    - 测试订单不存在时的处理
  - **数据完整性测试**:
    - 测试商品清单字段的完整性
    - 测试支付信息字段的完整性
    - 测试物流信息字段的完整性
    - 测试备注和操作日志字段的完整性
  - **异常流程测试**:
    - 测试订单ID不存在时的处理
    - 测试数据库查询异常处理
    - 测试订单项查询异常处理

---

### TASK-BE-003: 订单管理-发货接口

#### 1. 任务基础信息
- **任务ID**: TASK-BE-003
- **功能标题**: 订单管理-发货接口
- **任务类型**: 操作类
- **前置依赖**: -
- **关联任务**: TASK-FE-003

#### 2. 任务描述
- **功能目标**: 处理订单发货业务，更新物流信息并将订单状态从"待发货"变更为"已发货"。
- **适用场景**: 供前端发货操作调用，完成发货流程。

#### 3. 接口设计与关联 (API Design)
- **接口路径**: `POST /api/orders/ship`
- **请求方法**: `POST`

##### 请求参数 (Request Params)
| 字段名 | 类型 | 是否必填 | 校验规则/说明 |
| :--- | :--- | :--- | :--- |
| `id` | String | 是 | 订单ID，必须为有效的字符串格式 |
| `shipping_company` | String | 是 | 物流公司名称，长度2-50个字符 |
| `tracking_number` | String | 是 | 物流单号，长度5-50个字符，支持字母数字组合 |

##### 响应体 (Response Body)
```json
// 成功响应示例
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": "1",
    "order_number": "ORD202509290001",
    "status": "SHIPPED",
    "shipped_at": "2025-09-29 16:00:00"
  }
}
```

#### 4. 核心业务逻辑 (Business Logic)
1. 校验输入参数的合法性：
   - 订单ID：必须为有效的字符串格式
   - 物流公司名称：长度2-50个字符，不能为空
   - 物流单号：长度5-50个字符，不能为空，支持字母数字组合
2. 查询订单记录，检查当前状态是否为"TO_BE_SHIPPED"
3. 更新订单状态为"SHIPPED"，记录发货时间和物流信息
4. 记录操作日志
5. 返回更新后的订单信息

#### 5. 开发流程 (Development Process)
- **功能开发阶段**:
  - 实现订单发货接口功能
  - 完成输入参数校验逻辑（订单ID、物流公司名称、物流单号）
  - 实现订单状态检查逻辑（确保状态为TO_BE_SHIPPED）
  - 实现订单状态更新逻辑（更新为SHIPPED）
  - 实现发货时间和物流信息记录功能
  - 实现操作日志记录功能
  - 返回更新后的订单信息
- **单元测试阶段**:
  - **参数校验测试**:
    - 测试订单ID为有效字符串格式的校验
    - 测试订单ID为无效格式的异常情况
    - 测试物流公司名称长度校验（2-50字符）
    - 测试物流公司名称为空的异常情况
    - 测试物流单号长度校验（5-50字符）
    - 测试物流单号为空的异常情况
    - 测试物流单号格式校验（字母数字组合）
  - **状态校验测试**:
    - 测试订单状态为"TO_BE_SHIPPED"时的正常发货流程
    - 测试订单状态非"TO_BE_SHIPPED"时的异常处理（如PENDING_PAYMENT、SHIPPED等状态）
  - **业务逻辑测试**:
    - 测试订单状态正确更新为"SHIPPED"
    - 测试发货时间和物流信息正确记录
    - 测试操作日志正确记录
    - 测试返回数据格式的正确性
  - **异常流程测试**:
    - 测试订单不存在时的处理
    - 测试数据库更新异常处理
    - 测试并发情况下订单状态被更改的处理
  - **边界条件测试**:
    - 测试物流公司名称边界长度（2字符、50字符）
    - 测试物流单号边界长度（5字符、50字符）

---

### TASK-BE-004: 订单管理-关闭订单接口

#### 1. 任务基础信息
- **任务ID**: TASK-BE-004
- **功能标题**: 订单管理-关闭订单接口
- **任务类型**: 操作类
- **前置依赖**: -
- **关联任务**: TASK-FE-004

#### 2. 任务描述
- **功能目标**: 处理订单关闭业务，根据指定原因将订单状态变更为"CLOSED"，并释放占用的库存。
- **适用场景**: 供前端关闭订单操作调用，根据不同的关闭原因执行相应的业务逻辑。

#### 3. 接口设计与关联 (API Design)
- **接口路径**: `POST /api/orders/close`
- **请求方法**: `POST`

##### 请求参数 (Request Params)
| 字段名 | 类型 | 是否必填 | 校验规则/说明 |
| :--- | :--- | :--- | :--- |
| `id` | String | 是 | 订单ID，必须为有效的字符串格式 |
| `close_reason` | String | 是 | 关闭原因，枚举值：TIMEOUT_UNPAID, USER_CANCELLED, FRAUD_SUSPECTED, OUT_OF_STOCK, OTHER_REASON |
| `close_remark` | String | 否 | 关闭备注，长度0-200个字符 |

##### 响应体 (Response Body)
```json
// 成功响应示例
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": "1",
    "order_number": "ORD202509290001",
    "status": "CLOSED",
    "close_reason": "TIMEOUT_UNPAID",
    "close_remark": "订单超时未支付自动关闭"
  }
}
```

#### 4. 核心业务逻辑 (Business Logic)
1. 校验输入参数的合法性：
   - 订单ID：必须为有效的字符串格式
   - 关闭原因：必须为预定义枚举值之一（TIMEOUT_UNPAID, USER_CANCELLED, FRAUD_SUSPECTED, OUT_OF_STOCK, OTHER_REASON）
   - 关闭备注：长度0-200个字符，当关闭原因为OTHER_REASON时为必填
2. 查询订单记录，检查当前状态是否为"PENDING_PAYMENT"
3. 更新订单状态为"CLOSED"，记录关闭原因和备注
4. 释放该订单占用的商品库存
5. 记录操作日志，包含关闭原因
6. 返回更新后的订单信息

#### 5. 开发流程 (Development Process)
- **功能开发阶段**:
  - 实现订单关闭接口功能
  - 完成输入参数校验逻辑（订单ID、关闭原因、关闭备注）
  - 实现订单状态检查逻辑（确保状态为PENDING_PAYMENT）
  - 实现订单状态更新逻辑（更新为CLOSED）
  - 实现关闭原因和备注记录功能
  - 实现商品库存释放功能
  - 实现操作日志记录功能（包含关闭原因）
  - 返回更新后的订单信息
- **单元测试阶段**:
  - **参数校验测试**:
    - 测试订单ID为有效字符串格式的校验
    - 测试订单ID为无效格式的异常情况
    - 测试关闭原因为预定义枚举值的校验
    - 测试关闭原因非预定义枚举值的异常情况
    - 测试关闭备注长度校验（0-200字符）
    - 测试OTHER_REASON时备注为必填的校验
    - 测试OTHER_REASON时备注为空的异常情况
  - **状态校验测试**:
    - 测试订单状态为"PENDING_PAYMENT"时的正常关闭流程
    - 测试订单状态非"PENDING_PAYMENT"时的异常处理
  - **业务逻辑测试**:
    - 测试订单状态正确更新为"CLOSED"
    - 测试关闭原因和备注正确记录
    - 测试商品库存正确释放
    - 测试操作日志正确记录关闭原因
    - 测试返回数据格式的正确性
  - **不同关闭原因测试**:
    - 测试TIMEOUT_UNPAID关闭原因的处理
    - 测试USER_CANCELLED关闭原因的处理
    - 测试FRAUD_SUSPECTED关闭原因的处理
    - 测试OUT_OF_STOCK关闭原因的处理
    - 测试OTHER_REASON关闭原因的处理（包含备注）
  - **异常流程测试**:
    - 测试订单不存在时的处理
    - 测试数据库更新异常处理
    - 测试库存释放异常处理
    - 测试日志记录异常处理

---

### TASK-BE-006: 订单管理-状态字典接口

#### 1. 任务基础信息
- **任务ID**: TASK-BE-006
- **功能标题**: 订单管理-状态字典接口
- **任务类型**: 展示类
- **前置依赖**: -
- **关联任务**: TASK-FE-001, TASK-FE-002

#### 2. 任务描述
- **功能目标**: 提供订单状态枚举值与中文描述的映射关系，供前端展示使用。
- **适用场景**: 供前端获取状态值与用户友好名称的对应关系，将英文枚举值转换为中文显示。

#### 3. 接口设计与关联 (API Design)
- **接口路径**: `GET /api/orders/status-dictionary`
- **请求方法**: `GET`

##### 请求参数 (Request Params)
无

##### 响应体 (Response Body)
```json
// 成功响应示例
{
  "code": 200,
  "message": "Success",
  "data": [
    {
      "value": "PENDING_PAYMENT",
      "label": "待付款",
      "description": "用户已提交订单，但尚未完成支付"
    },
    {
      "value": "TO_BE_SHIPPED", 
      "label": "待发货",
      "description": "用户已完成支付，等待商家打包发货"
    },
    {
      "value": "SHIPPED",
      "label": "已发货", 
      "description": "商家已将商品交付物流，正在配送中"
    },
    {
      "value": "COMPLETED",
      "label": "已完成",
      "description": "用户已确认收货，或系统超时自动确认"
    },
    {
      "value": "CLOSED",
      "label": "已关闭",
      "description": "订单因超时未支付、用户取消或全额退款而关闭"
    },
    {
      "value": "AFTER_SALES",
      "label": "售后处理中",
      "description": "用户申请退/换货，等待商家处理"
    }
  ]
}
```

#### 4. 核心业务逻辑 (Business Logic)
1. 构建状态字典数据结构
2. 返回包含状态值、标签和描述的映射关系
3. 记录访问日志

#### 5. 单元测试 (Unit Tests)
- **正常流程测试**:
  - 测试返回完整的状态字典数据
  - 测试返回数据格式的正确性（value、label、description字段）
  - 测试所有预定义状态值都包含在返回结果中
- **数据完整性测试**:
  - 测试每个状态值都有对应的中文标签
  - 测试每个状态值都有对应的描述信息
  - 测试状态值格式的正确性（英文大写+下划线）
  - 测试中文标签的正确性
  - 测试描述信息的准确性
- **异常流程测试**:
  - 测试数据构建异常的处理
  - 测试日志记录异常的处理
- **性能测试**:
  - 测试接口响应时间（应为毫秒级）
  - 测试高并发访问时的性能表现

---

### TASK-BE-005: 订单管理-修改地址接口

#### 1. 任务基础信息
- **任务ID**: TASK-BE-005
- **功能标题**: 订单管理-修改地址接口
- **任务类型**: 操作类
- **前置依赖**: -
- **关联任务**: TASK-FE-005, TASK-BE-006

#### 2. 任务描述
- **功能目标**: 处理订单地址修改业务，仅在订单状态为"待发货"时允许修改。
- **适用场景**: 供前端修改地址操作调用。

#### 3. 接口设计与关联 (API Design)
- **接口路径**: `POST /api/orders/modify_address`
- **请求方法**: `POST`

##### 请求参数 (Request Params)
| 字段名 | 类型 | 是否必填 | 校验规则/说明 |
| :--- | :--- | :--- | :--- |
| `id` | String | 是 | 订单ID，必须为有效的字符串格式 |
| `name` | String | 是 | 收货人姓名，长度2-20个字符，仅支持中文、英文字母和数字 |
| `phone` | String | 是 | 收货人电话，必须符合手机号格式，如13800138000 |
| `address` | String | 是 | 详细收货地址，长度5-200个字符 |

##### 响应体 (Response Body)
```json
// 成功响应示例
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": "1",
    "order_number": "ORD202509290001",
    "customer_info": {
      "name": "张三",
      "phone": "13800138000",
      "address": "北京市海淀区xxx街道xxx号"
    }
  }
}
```

#### 4. 核心业务逻辑 (Business Logic)
1. 校验输入参数的合法性：
   - 订单ID：必须为有效的字符串格式
   - 收货人姓名：长度2-20个字符，仅支持中文、英文字母和数字
   - 收货人电话：必须符合手机号格式，如13800138000
   - 详细收货地址：长度5-200个字符
2. 查询订单记录，检查当前状态是否为"TO_BE_SHIPPED"
3. 更新订单的收货人信息
4. 记录操作日志
5. 返回更新后的订单信息

#### 5. 单元测试 (Unit Tests)
- **参数校验测试**:
  - 测试订单ID为有效字符串格式的校验
  - 测试订单ID为无效格式的异常情况
  - 测试收货人姓名长度校验（2-20字符）
  - 测试收货人姓名字符格式校验（中文、英文字母、数字）
  - 测试收货人姓名包含非法字符的异常情况
  - 测试收货人电话格式校验（手机号格式）
  - 测试收货人电话格式错误的异常情况
  - 测试详细收货地址长度校验（5-200字符）
  - 测试详细收货地址长度不足的异常情况
- **状态校验测试**:
  - 测试订单状态为"TO_BE_SHIPPED"时的正常修改流程
  - 测试订单状态非"TO_BE_SHIPPED"时的异常处理（如PENDING_PAYMENT、SHIPPED等状态）
- **业务逻辑测试**:
  - 测试收货人信息正确更新到数据库
  - 测试操作日志正确记录地址修改信息
  - 测试返回数据中地址信息的正确性
  - 测试部分字段更新时其他字段保持不变
- **数据完整性测试**:
  - 测试收货人姓名更新后正确保存
  - 测试收货人电话更新后正确保存
  - 测试收货人地址更新后正确保存
  - 测试订单其他信息在地址修改后保持不变
- **异常流程测试**:
  - 测试订单不存在时的处理
  - 测试数据库更新异常处理
  - 测试并发情况下订单状态被更改的处理
- **边界条件测试**:
  - 测试收货人姓名边界长度（2字符、20字符）
  - 测试收货地址边界长度（5字符、200字符）

---

## 通用补充说明
- **依赖规则定义**: 前后端任务可并行开发，但在联调阶段需要对方完成
- **接口复用说明**: 本模块接口仅用于订单管理功能，不与其他模块复用
- **异常交互统一**: 所有错误响应遵循统一格式，包含错误码和错误信息

### 订单状态枚举定义
| 状态值 | 中文描述 | 说明 |
| :--- | :--- | :--- |
| `PENDING_PAYMENT` | 待付款 | 用户已提交订单，但尚未完成支付 |
| `TO_BE_SHIPPED` | 待发货 | 用户已完成支付，等待商家打包发货 |
| `SHIPPED` | 已发货 | 商家已将商品交付物流，正在配送中 |
| `COMPLETED` | 已完成 | 用户已确认收货，或系统超时自动确认 |
| `CLOSED` | 已关闭 | 订单因超时未支付、用户取消或全额退款而关闭 |
| `AFTER_SALES` | 售后处理中 | 用户申请退/换货，等待商家处理 |

### 业务规则说明
1. **状态流转规则**:
   - 订单创建后状态为`PENDING_PAYMENT`
   - 用户支付成功后状态变更为`TO_BE_SHIPPED`
   - 商家发货后状态变更为`SHIPPED`
   - 用户确认收货或达到自动确认条件后状态变更为`COMPLETED`
   - 特定条件下订单可能变更为`CLOSED`或`AFTER_SALES`

2. **操作权限规则**:
   - 只有状态为`TO_BE_SHIPPED`的订单才能执行发货操作
   - 只有状态为`PENDING_PAYMENT`的订单才能执行关闭操作
   - 只有状态为`TO_BE_SHIPPED`的订单才能修改收货地址

3. **订单关闭原因枚举定义**:
   - `TIMEOUT_UNPAID` (超时未支付)：订单超过支付时限自动关闭
   - `USER_CANCELLED` (用户主动取消)：用户主动取消订单
   - `FRAUD_SUSPECTED` (疑似欺诈)：系统检测到订单存在欺诈风险
   - `OUT_OF_STOCK` (库存不足)：商品库存不足无法发货
   - `OTHER_REASON` (其他原因)：其他未分类的关闭原因

4. **数据验证规则**:
   - 订单ID必须为有效的字符串格式
   - 物流公司名称长度为2-50个字符，不能为空
   - 物流单号长度为5-50个字符，不能为空，支持字母数字组合
   - 关闭原因必须为预定义枚举值之一
   - 关闭备注长度为0-200个字符，当关闭原因为OTHER_REASON时为必填
   - 收货人姓名长度为2-20个字符，仅支持中文、英文字母和数字
   - 收货人电话必须符合手机号格式
   - 详细收货地址长度为5-200个字符
   - 金额字段必须为有效的数值类型