# 第三阶段 - 后端任务文档
## 珠子材料库管理后台 - 库存管理系统

### 阶段目标
实现完整的库存管理系统后端API，包括库存监控、出入库操作、预警系统、统计报表等功能。

---

## 数据库设计

### 1. 库存记录表（inventory_records）
```sql
{
  _id: ObjectId,
  recordId: String,       // 库存记录唯一标识
  materialId: String,     // 材料ID
  currentStock: Number,   // 当前库存数量
  availableStock: Number, // 可用库存数量（扣除预留）
  reservedStock: Number,  // 预留库存数量
  alertThreshold: Number, // 预警阈值
  lastInboundAt: Date,    // 最后入库时间
  lastOutboundAt: Date,   // 最后出库时间
  totalInbound: Number,   // 累计入库数量
  totalOutbound: Number,  // 累计出库数量
  stockValue: Number,     // 库存价值（数量 * 单价）
  status: String,         // 库存状态：normal/warning/critical/out_of_stock
  createdAt: Date,        // 创建时间
  updatedAt: Date,        // 更新时间
  updatedBy: String       // 更新人
}
```

### 2. 库存操作记录表（inventory_operations）
```sql
{
  _id: ObjectId,
  operationId: String,    // 操作唯一标识
  materialId: String,     // 材料ID
  operationType: String,  // 操作类型：inbound/outbound/adjust
  quantity: Number,       // 操作数量（正数为入库，负数为出库）
  beforeStock: Number,    // 操作前库存
  afterStock: Number,     // 操作后库存
  unitPrice: Number,      // 单价（入库时记录）
  totalValue: Number,     // 总价值
  reason: String,         // 操作原因
  supplier: String,       // 供应商（入库时）
  customer: String,       // 客户（出库时）
  notes: String,          // 操作备注
  operationDate: Date,    // 操作日期
  batchId: String,        // 批次ID（批量操作时）
  status: String,         // 操作状态：pending/completed/cancelled
  createdAt: Date,        // 创建时间
  createdBy: String,      // 操作人
  approvedBy: String,     // 审批人（如需要）
  approvedAt: Date        // 审批时间
}
```

### 3. 库存预警规则表（inventory_alert_rules）
```sql
{
  _id: ObjectId,
  ruleId: String,         // 规则唯一标识
  ruleName: String,       // 规则名称
  scope: String,          // 适用范围：global/category/material
  targetId: String,       // 目标ID（分类ID或材料ID）
  warningThreshold: Number, // 警告阈值
  criticalThreshold: Number, // 严重阈值
  notificationMethods: Array, // 通知方式：['system', 'email', 'sms']
  priority: Number,       // 优先级（数值越大优先级越高）
  status: String,         // 规则状态：enabled/disabled
  description: String,    // 规则描述
  createdAt: Date,        // 创建时间
  updatedAt: Date,        // 更新时间
  createdBy: String,      // 创建人
  updatedBy: String       // 更新人
}
```

### 4. 库存预警记录表（inventory_alerts）
```sql
{
  _id: ObjectId,
  alertId: String,        // 预警唯一标识
  materialId: String,     // 材料ID
  ruleId: String,         // 触发的规则ID
  alertLevel: String,     // 预警级别：warning/critical
  currentStock: Number,   // 当前库存
  threshold: Number,      // 预警阈值
  alertTime: Date,        // 预警时间
  status: String,         // 处理状态：pending/processing/resolved/ignored
  handledBy: String,      // 处理人
  handledAt: Date,        // 处理时间
  handleNotes: String,    // 处理备注
  notificationSent: Boolean, // 是否已发送通知
  notificationMethods: Array, // 已发送的通知方式
  createdAt: Date         // 创建时间
}
```

### 5. 库存统计表（inventory_statistics）
```sql
{
  _id: ObjectId,
  statisticId: String,    // 统计唯一标识
  date: Date,             // 统计日期
  materialId: String,     // 材料ID（可选，为空表示全局统计）
  categoryId: String,     // 分类ID（可选）
  openingStock: Number,   // 期初库存
  closingStock: Number,   // 期末库存
  totalInbound: Number,   // 当日入库总量
  totalOutbound: Number,  // 当日出库总量
  averageStock: Number,   // 平均库存
  stockValue: Number,     // 库存价值
  turnoverRate: Number,   // 周转率
  stockDays: Number,      // 库存天数
  createdAt: Date,        // 创建时间
  updatedAt: Date         // 更新时间
}
```

---

## API接口定义

### 1. 库存监控接口

#### 1.1 获取库存仪表盘数据
**接口地址**：`GET /api/inventory/dashboard`

**请求参数**：无

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "summary": {
      "totalValue": 1250000.50,      // 库存总价值
      "totalQuantity": 5000,         // 材料总数量
      "lowStockCount": 15,           // 低库存材料数
      "outOfStockCount": 3,          // 缺货材料数
      "monthlyInbound": 500,         // 本月入库总量
      "monthlyOutbound": 300         // 本月出库总量
    },
    "categoryDistribution": [        // 分类库存分布
      {
        "categoryId": "C001",
        "categoryName": "宝石类",
        "stockQuantity": 2000,
        "stockValue": 800000.00,
        "percentage": 64.0
      }
    ],
    "recentAlerts": [               // 最近预警
      {
        "alertId": "A001",
        "materialId": "M001",
        "materialName": "红玛瑙",
        "alertLevel": "warning",
        "currentStock": 5,
        "threshold": 10,
        "alertTime": "2024-01-01T00:00:00.000Z"
      }
    ]
  }
}
```

#### 1.2 获取库存趋势数据
**接口地址**：`GET /api/inventory/trend`

**请求参数**：
```json
{
  "days": 30,             // 天数，可选，默认30天
  "materialId": "M001",   // 材料ID，可选，为空表示全局趋势
  "categoryId": "C001"    // 分类ID，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "stockTrend": [               // 库存趋势
      {
        "date": "2024-01-01",
        "stock": 1000,
        "value": 15000.00
      }
    ],
    "operationTrend": [           // 出入库趋势
      {
        "date": "2024-01-01",
        "inbound": 50,
        "outbound": 30,
        "net": 20
      }
    ]
  }
}
```

**字段校验规则**：
- days：可选，整数，范围7-365，默认30
- materialId：可选，字符串，必须是有效的材料ID
- categoryId：可选，字符串，必须是有效的分类ID

#### 1.3 获取低库存预警列表
**接口地址**：`GET /api/inventory/low-stock-alert`

**请求参数**：
```json
{
  "limit": 10             // 返回数量限制，可选，默认10
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "materialId": "M001",
      "materialName": "红玛瑙",
      "categoryName": "宝石类",
      "currentStock": 5,
      "alertThreshold": 10,
      "alertLevel": "warning",
      "stockValue": 75.00,
      "lastUpdatedAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

**字段校验规则**：
- limit：可选，整数，范围1-100，默认10

---

### 2. 库存列表管理接口

#### 2.1 获取库存列表
**接口地址**：`POST /api/inventory/list`

**请求参数**：
```json
{
  "page": 1,              // 页码，必填
  "pageSize": 20,         // 每页数量，必填
  "keyword": "",          // 搜索关键词，可选
  "categoryId": "",       // 分类ID，可选
  "stockStatus": "",      // 库存状态，可选：normal/warning/critical/out_of_stock
  "stockMin": 0,          // 最小库存，可选
  "stockMax": 1000,       // 最大库存，可选
  "valueMin": 0.0,        // 最小价值，可选
  "valueMax": 10000.0,    // 最大价值，可选
  "sortBy": "currentStock", // 排序字段，可选
  "sortOrder": "desc"     // 排序方向，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "materialId": "M001",
        "materialName": "红玛瑙",
        "categoryId": "C001",
        "categoryName": "宝石类",
        "currentStock": 100,
        "availableStock": 95,
        "reservedStock": 5,
        "alertThreshold": 20,
        "stockStatus": "normal",
        "stockValue": 1500.00,
        "unitPrice": 15.00,
        "lastInboundAt": "2024-01-01T00:00:00.000Z",
        "lastOutboundAt": "2024-01-01T00:00:00.000Z",
        "updatedAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

**字段校验规则**：
- page：必填，整数，>= 1
- pageSize：必填，整数，范围[10, 20, 50, 100]
- keyword：可选，字符串，最大长度50
- categoryId：可选，字符串，必须是有效的分类ID
- stockStatus：可选，字符串，值为normal/warning/critical/out_of_stock
- stockMin/stockMax：可选，整数，>= 0，stockMin <= stockMax
- valueMin/valueMax：可选，数值，>= 0，valueMin <= valueMax
- sortBy：可选，字符串，允许值：materialName/currentStock/stockValue/updatedAt
- sortOrder：可选，字符串，值为asc/desc

#### 2.2 库存调整
**接口地址**：`POST /api/inventory/adjust`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "adjustType": "add",    // 调整类型，必填：add/subtract/set
  "quantity": 10,         // 调整数量，必填
  "reason": "入库",       // 调整原因，必填
  "notes": "采购入库",    // 调整备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选，默认当前日期
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "库存调整成功",
  "data": {
    "operationId": "OP001",
    "beforeStock": 90,
    "afterStock": 100,
    "adjustQuantity": 10
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- adjustType：必填，字符串，值为add/subtract/set
- quantity：必填，整数，> 0，subtract时不能超过当前库存，set时为目标库存数量
- reason：必填，字符串，长度2-50
- notes：可选，字符串，最大长度500
- operationDate：可选，日期格式YYYY-MM-DD，不能晚于当前日期

#### 2.3 批量库存调整
**接口地址**：`POST /api/inventory/batch-adjust`

**请求参数**：
```json
{
  "adjustments": [        // 调整列表，必填
    {
      "materialId": "M001",
      "adjustType": "add",
      "quantity": 10,
      "reason": "入库",
      "notes": "批量入库"
    }
  ],
  "batchNotes": "批量调整操作", // 批次备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量调整完成",
  "data": {
    "batchId": "BATCH001",
    "successCount": 5,
    "failedCount": 1,
    "successList": [
      {
        "materialId": "M001",
        "operationId": "OP001",
        "beforeStock": 90,
        "afterStock": 100
      }
    ],
    "failedList": [
      {
        "materialId": "M002",
        "error": "库存不足"
      }
    ]
  }
}
```

**字段校验规则**：
- adjustments：必填，数组，长度1-1000
- 数组元素校验规则与单个调整接口相同
- batchNotes：可选，字符串，最大长度500
- operationDate：可选，日期格式

---

### 3. 出入库操作接口

#### 3.1 入库操作
**接口地址**：`POST /api/inventory/inbound`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "quantity": 100,        // 入库数量，必填
  "unitPrice": 15.50,     // 入库单价，可选
  "supplier": "供应商A",   // 供应商，可选
  "reason": "采购",       // 入库原因，必填
  "notes": "新采购的红玛瑙", // 备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "入库成功",
  "data": {
    "operationId": "OP001",
    "beforeStock": 50,
    "afterStock": 150,
    "totalValue": 1550.00
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- quantity：必填，正整数
- unitPrice：可选，数值，>= 0
- supplier：可选，字符串，最大长度50
- reason：必填，字符串，从预定义列表选择：采购/退货/调拨/盘盈/其他
- notes：可选，字符串，最大长度500
- operationDate：可选，日期格式，不能晚于当前日期

#### 3.2 出库操作
**接口地址**：`POST /api/inventory/outbound`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "quantity": 50,         // 出库数量，必填
  "customer": "客户A",     // 客户，可选
  "reason": "销售",       // 出库原因，必填
  "notes": "销售给客户A",  // 备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "出库成功",
  "data": {
    "operationId": "OP002",
    "beforeStock": 150,
    "afterStock": 100,
    "totalValue": 775.00
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- quantity：必填，正整数，不能超过可用库存
- customer：可选，字符串，最大长度50
- reason：必填，字符串，从预定义列表选择：销售/损耗/调拨/盘亏/其他
- notes：可选，字符串，最大长度500
- operationDate：可选，日期格式，不能晚于当前日期

#### 3.3 批量入库
**接口地址**：`POST /api/inventory/batch-inbound`

**请求参数**：
```json
{
  "operations": [         // 入库操作列表，必填
    {
      "materialId": "M001",
      "quantity": 100,
      "unitPrice": 15.50,
      "supplier": "供应商A",
      "reason": "采购",
      "notes": "批量采购"
    }
  ],
  "batchNotes": "批量入库操作", // 批次备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量入库完成",
  "data": {
    "batchId": "BATCH002",
    "successCount": 5,
    "failedCount": 0,
    "totalQuantity": 500,
    "totalValue": 7750.00,
    "successList": [
      {
        "materialId": "M001",
        "operationId": "OP003",
        "quantity": 100,
        "value": 1550.00
      }
    ],
    "failedList": []
  }
}
```

**字段校验规则**：
- operations：必填，数组，长度1-1000
- 数组元素校验规则与单个入库接口相同
- batchNotes：可选，字符串，最大长度500
- operationDate：可选，日期格式

#### 3.4 批量出库
**接口地址**：`POST /api/inventory/batch-outbound`

**请求参数**：
```json
{
  "operations": [         // 出库操作列表，必填
    {
      "materialId": "M001",
      "quantity": 50,
      "customer": "客户A",
      "reason": "销售",
      "notes": "批量销售"
    }
  ],
  "batchNotes": "批量出库操作", // 批次备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量出库完成",
  "data": {
    "batchId": "BATCH003",
    "successCount": 3,
    "failedCount": 2,
    "totalQuantity": 150,
    "totalValue": 2325.00,
    "successList": [
      {
        "materialId": "M001",
        "operationId": "OP004",
        "quantity": 50,
        "value": 775.00
      }
    ],
    "failedList": [
      {
        "materialId": "M002",
        "error": "库存不足"
      }
    ]
  }
}
```

**字段校验规则**：
- operations：必填，数组，长度1-1000
- 数组元素校验规则与单个出库接口相同
- batchNotes：可选，字符串，最大长度500
- operationDate：可选，日期格式

#### 3.5 获取出入库记录列表
**接口地址**：`GET /api/inventory/operation-list`

**请求参数**：
```json
{
  "page": 1,              // 页码，必填
  "pageSize": 20,         // 每页数量，必填
  "materialId": "",       // 材料ID，可选
  "operationType": "",    // 操作类型，可选：inbound/outbound/adjust
  "reason": "",           // 操作原因，可选
  "dateStart": "2024-01-01", // 开始日期，可选
  "dateEnd": "2024-01-31",   // 结束日期，可选
  "createdBy": "",        // 操作人，可选
  "sortBy": "createdAt",  // 排序字段，可选
  "sortOrder": "desc"     // 排序方向，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "operationId": "OP001",
        "materialId": "M001",
        "materialName": "红玛瑙",
        "operationType": "inbound",
        "quantity": 100,
        "beforeStock": 50,
        "afterStock": 150,
        "unitPrice": 15.50,
        "totalValue": 1550.00,
        "reason": "采购",
        "supplier": "供应商A",
        "notes": "新采购的红玛瑙",
        "operationDate": "2024-01-01",
        "createdAt": "2024-01-01T00:00:00.000Z",
        "createdBy": "admin"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

**字段校验规则**：
- page：必填，整数，>= 1
- pageSize：必填，整数，范围[10, 20, 50, 100]
- materialId：可选，字符串，必须是有效的材料ID
- operationType：可选，字符串，值为inbound/outbound/adjust
- reason：可选，字符串
- dateStart/dateEnd：可选，日期格式，dateStart <= dateEnd
- createdBy：可选，字符串
- sortBy：可选，字符串，允许值：operationDate/createdAt/quantity/totalValue
- sortOrder：可选，字符串，值为asc/desc

---

### 4. 库存预警管理接口

#### 4.1 获取预警规则列表
**接口地址**：`GET /api/inventory/alert-rules`

**请求参数**：
```json
{
  "page": 1,              // 页码，可选，默认1
  "pageSize": 20,         // 每页数量，可选，默认20
  "scope": "",            // 适用范围，可选
  "status": ""            // 规则状态，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "ruleId": "R001",
        "ruleName": "全局低库存预警",
        "scope": "global",
        "targetId": null,
        "targetName": "全局",
        "warningThreshold": 10,
        "criticalThreshold": 5,
        "notificationMethods": ["system", "email"],
        "priority": 1,
        "status": "enabled",
        "description": "全局库存预警规则",
        "createdAt": "2024-01-01T00:00:00.000Z",
        "createdBy": "admin"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  }
}
```

**字段校验规则**：
- page：可选，整数，>= 1，默认1
- pageSize：可选，整数，范围[10, 20, 50]，默认20
- scope：可选，字符串，值为global/category/material
- status：可选，字符串，值为enabled/disabled

#### 4.2 创建预警规则
**接口地址**：`POST /api/inventory/alert-rule/create`

**请求参数**：
```json
{
  "ruleName": "宝石类低库存预警", // 规则名称，必填
  "scope": "category",     // 适用范围，必填
  "targetId": "C001",      // 目标ID，可选
  "warningThreshold": 20,  // 警告阈值，必填
  "criticalThreshold": 10, // 严重阈值，必填
  "notificationMethods": ["system", "email"], // 通知方式，必填
  "priority": 2,           // 优先级，可选，默认1
  "status": "enabled",     // 规则状态，可选，默认enabled
  "description": "宝石类材料库存预警" // 规则描述，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "ruleId": "R002"
  }
}
```

**字段校验规则**：
- ruleName：必填，字符串，长度2-50，不能重复
- scope：必填，字符串，值为global/category/material
- targetId：当scope不为global时必填，必须是有效的分类ID或材料ID
- warningThreshold：必填，正整数
- criticalThreshold：必填，正整数，必须小于warningThreshold
- notificationMethods：必填，数组，至少包含一个值，允许值：system/email/sms
- priority：可选，整数，>= 1，默认1
- status：可选，字符串，值为enabled/disabled，默认enabled
- description：可选，字符串，最大长度200

#### 4.3 更新预警规则
**接口地址**：`POST /api/inventory/alert-rule/update`

**请求参数**：
```json
{
  "ruleId": "R002",        // 规则ID，必填
  "ruleName": "宝石类低库存预警", // 规则名称，必填
  "scope": "category",     // 适用范围，必填
  "targetId": "C001",      // 目标ID，可选
  "warningThreshold": 25,  // 警告阈值，必填
  "criticalThreshold": 15, // 严重阈值，必填
  "notificationMethods": ["system", "email", "sms"], // 通知方式，必填
  "priority": 3,           // 优先级，可选
  "status": "enabled",     // 规则状态，必填
  "description": "更新后的宝石类材料库存预警" // 规则描述，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**字段校验规则**：与创建预警规则接口相同，另外：
- ruleId：必填，字符串，必须是有效的规则ID

#### 4.4 删除预警规则
**接口地址**：`POST /api/inventory/alert-rule/delete`

**请求参数**：
```json
{
  "ruleId": "R002"         // 规则ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**字段校验规则**：
- ruleId：必填，字符串，必须是有效的规则ID

#### 4.5 获取预警信息列表
**接口地址**：`GET /api/inventory/alerts`

**请求参数**：
```json
{
  "page": 1,              // 页码，可选，默认1
  "pageSize": 20,         // 每页数量，可选，默认20
  "alertLevel": "",       // 预警级别，可选
  "status": "",           // 处理状态，可选
  "materialId": "",       // 材料ID，可选
  "dateStart": "2024-01-01", // 开始日期，可选
  "dateEnd": "2024-01-31"    // 结束日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "alertId": "A001",
        "materialId": "M001",
        "materialName": "红玛瑙",
        "categoryName": "宝石类",
        "ruleId": "R001",
        "ruleName": "全局低库存预警",
        "alertLevel": "warning",
        "currentStock": 8,
        "threshold": 10,
        "alertTime": "2024-01-01T00:00:00.000Z",
        "status": "pending",
        "handledBy": null,
        "handledAt": null,
        "handleNotes": null,
        "notificationSent": true
      }
    ],
    "total": 15,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  }
}
```

**字段校验规则**：
- page：可选，整数，>= 1，默认1
- pageSize：可选，整数，范围[10, 20, 50]，默认20
- alertLevel：可选，字符串，值为warning/critical
- status：可选，字符串，值为pending/processing/resolved/ignored
- materialId：可选，字符串，必须是有效的材料ID
- dateStart/dateEnd：可选，日期格式，dateStart <= dateEnd

#### 4.6 处理预警信息
**接口地址**：`POST /api/inventory/alert/handle`

**请求参数**：
```json
{
  "alertId": "A001",      // 预警ID，必填
  "action": "resolved",   // 处理动作，必填：processing/resolved/ignored
  "handleNotes": "已补充库存" // 处理备注，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "处理成功",
  "data": null
}
```

**字段校验规则**：
- alertId：必填，字符串，必须是有效的预警ID
- action：必填，字符串，值为processing/resolved/ignored
- handleNotes：可选，字符串，最大长度500

---

### 5. 库存统计报表接口

#### 5.1 库存汇总报表
**接口地址**：`POST /api/inventory/report/stock-summary`

**请求参数**：
```json
{
  "dateStart": "2024-01-01", // 开始日期，必填
  "dateEnd": "2024-01-31",   // 结束日期，必填
  "categoryIds": ["C001"],   // 分类ID数组，可选
  "materialIds": ["M001"],   // 材料ID数组，可选
  "dimension": "day"         // 统计维度，可选：day/week/month
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "summary": {
      "openingStock": 1000,     // 期初库存
      "closingStock": 1200,     // 期末库存
      "averageStock": 1100,     // 平均库存
      "totalInbound": 500,      // 总入库
      "totalOutbound": 300,     // 总出库
      "netChange": 200,         // 净变化
      "turnoverRate": 0.27,     // 周转率
      "stockDays": 365          // 库存天数
    },
    "details": [
      {
        "date": "2024-01-01",
        "openingStock": 1000,
        "closingStock": 1050,
        "inbound": 100,
        "outbound": 50,
        "stockValue": 15750.00
      }
    ],
    "categoryBreakdown": [      // 分类汇总
      {
        "categoryId": "C001",
        "categoryName": "宝石类",
        "openingStock": 800,
        "closingStock": 960,
        "totalInbound": 400,
        "totalOutbound": 240,
        "stockValue": 14400.00
      }
    ]
  }
}
```

**字段校验规则**：
- dateStart：必填，日期格式YYYY-MM-DD
- dateEnd：必填，日期格式YYYY-MM-DD，不能早于dateStart，不能晚于当前日期
- categoryIds：可选，字符串数组，每个ID必须有效
- materialIds：可选，字符串数组，每个ID必须有效
- dimension：可选，字符串，值为day/week/month，默认day

#### 5.2 出入库汇总报表
**接口地址**：`POST /api/inventory/report/operation-summary`

**请求参数**：
```json
{
  "dateStart": "2024-01-01", // 开始日期，必填
  "dateEnd": "2024-01-31",   // 结束日期，必填
  "operationType": "",       // 操作类型，可选
  "categoryIds": ["C001"],   // 分类ID数组，可选
  "dimension": "day"         // 统计维度，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "summary": {
      "totalInboundCount": 50,    // 入库次数
      "totalInboundQuantity": 500, // 入库总量
      "totalInboundValue": 7500.00, // 入库总价值
      "totalOutboundCount": 30,    // 出库次数
      "totalOutboundQuantity": 300, // 出库总量
      "totalOutboundValue": 4500.00, // 出库总价值
      "netQuantity": 200,          // 净数量
      "netValue": 3000.00          // 净价值
    },
    "trend": [
      {
        "date": "2024-01-01",
        "inboundCount": 2,
        "inboundQuantity": 20,
        "inboundValue": 300.00,
        "outboundCount": 1,
        "outboundQuantity": 10,
        "outboundValue": 150.00
      }
    ],
    "reasonBreakdown": [          // 按原因分组
      {
        "reason": "采购",
        "operationType": "inbound",
        "count": 30,
        "quantity": 300,
        "value": 4500.00
      }
    ]
  }
}
```

**字段校验规则**：
- dateStart：必填，日期格式YYYY-MM-DD
- dateEnd：必填，日期格式YYYY-MM-DD，不能早于dateStart
- operationType：可选，字符串，值为inbound/outbound
- categoryIds：可选，字符串数组，每个ID必须有效
- dimension：可选，字符串，值为day/week/month，默认day

#### 5.3 库存价值分析报表
**接口地址**：`POST /api/inventory/report/value-analysis`

**请求参数**：
```json
{
  "dateStart": "2024-01-01", // 开始日期，必填
  "dateEnd": "2024-01-31",   // 结束日期，必填
  "categoryIds": ["C001"],   // 分类ID数组，可选
  "topN": 10                 // 排行榜数量，可选，默认10
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "valueTrend": [             // 价值趋势
      {
        "date": "2024-01-01",
        "totalValue": 15000.00,
        "changeValue": 500.00,
        "changePercent": 3.45
      }
    ],
    "categoryDistribution": [   // 分类价值分布
      {
        "categoryId": "C001",
        "categoryName": "宝石类",
        "stockValue": 12000.00,
        "percentage": 80.0,
        "materialCount": 50
      }
    ],
    "topValueMaterials": [      // 高价值材料排行
      {
        "materialId": "M001",
        "materialName": "红玛瑙",
        "currentStock": 100,
        "unitPrice": 15.00,
        "stockValue": 1500.00,
        "rank": 1
      }
    ],
    "valueChangeAnalysis": {    // 价值变化分析
      "totalValueChange": 2000.00,
      "increaseValue": 2500.00,
      "decreaseValue": 500.00,
      "increaseCount": 30,
      "decreaseCount": 10
    }
  }
}
```

**字段校验规则**：
- dateStart：必填，日期格式YYYY-MM-DD
- dateEnd：必填，日期格式YYYY-MM-DD，不能早于dateStart
- categoryIds：可选，字符串数组，每个ID必须有效
- topN：可选，整数，范围5-50，默认10

#### 5.4 库存周转分析报表
**接口地址**：`POST /api/inventory/report/turnover-analysis`

**请求参数**：
```json
{
  "dateStart": "2024-01-01", // 开始日期，必填
  "dateEnd": "2024-01-31",   // 结束日期，必填
  "categoryIds": ["C001"],   // 分类ID数组，可选
  "topN": 10                 // 排行榜数量，可选，默认10
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "overallTurnover": {        // 整体周转情况
      "averageTurnoverRate": 0.25,
      "averageStockDays": 365,
      "fastMovingCount": 15,    // 快销材料数量
      "slowMovingCount": 8,     // 滞销材料数量
      "noMovingCount": 3        // 无销售材料数量
    },
    "turnoverRanking": [        // 周转率排行
      {
        "materialId": "M001",
        "materialName": "红玛瑙",
        "turnoverRate": 0.5,
        "stockDays": 182,
        "averageStock": 100,
        "totalOutbound": 50,
        "rank": 1,
        "category": "fast_moving"
      }
    ],
    "slowMovingMaterials": [    // 滞销材料
      {
        "materialId": "M010",
        "materialName": "黑曜石",
        "turnoverRate": 0.05,
        "stockDays": 730,
        "currentStock": 200,
        "lastOutboundAt": "2023-12-01T00:00:00.000Z",
        "stockValue": 1000.00
      }
    ],
    "categoryTurnover": [       // 分类周转分析
      {
        "categoryId": "C001",
        "categoryName": "宝石类",
        "averageTurnoverRate": 0.3,
        "averageStockDays": 304,
        "totalStockValue": 15000.00
      }
    ]
  }
}
```

**字段校验规则**：
- dateStart：必填，日期格式YYYY-MM-DD
- dateEnd：必填，日期格式YYYY-MM-DD，不能早于dateStart，时间跨度至少30天
- categoryIds：可选，字符串数组，每个ID必须有效
- topN：可选，整数，范围5-50，默认10

#### 5.5 导出报表
**接口地址**：`POST /api/inventory/report/export`

**请求参数**：
```json
{
  "reportType": "stock-summary", // 报表类型，必填
  "format": "xlsx",           // 导出格式，可选，默认xlsx
  "params": {                 // 报表参数，必填，根据报表类型传入对应参数
    "dateStart": "2024-01-01",
    "dateEnd": "2024-01-31",
    "categoryIds": ["C001"]
  }
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "导出成功",
  "data": {
    "fileUrl": "/exports/stock_summary_20240101_123456.xlsx",
    "fileName": "库存汇总报表_20240101_123456.xlsx",
    "fileSize": 2048000,
    "expiresAt": "2024-01-08T00:00:00.000Z"
  }
}
```

**字段校验规则**：
- reportType：必填，字符串，值为stock-summary/operation-summary/value-analysis/turnover-analysis
- format：可选，字符串，值为xlsx/pdf，默认xlsx
- params：必填，对象，根据reportType传入对应的参数

---

## 定时任务设计

### 1. 库存统计任务
- **执行频率**：每日凌晨2点
- **任务内容**：
  - 计算前一日的库存统计数据
  - 更新inventory_statistics表
  - 计算周转率和库存天数

### 2. 预警检查任务
- **执行频率**：每小时
- **任务内容**：
  - 检查所有材料库存状态
  - 根据预警规则生成预警信息
  - 发送预警通知

### 3. 数据清理任务
- **执行频率**：每周日凌晨3点
- **任务内容**：
  - 清理过期的导出文件
  - 清理已处理的预警记录（保留3个月）
  - 清理临时数据

---

## 性能优化

### 1. 数据库索引
```javascript
// 库存记录表索引
db.inventory_records.createIndex({"materialId": 1})
db.inventory_records.createIndex({"status": 1})
db.inventory_records.createIndex({"updatedAt": -1})

// 库存操作记录表索引
db.inventory_operations.createIndex({"materialId": 1, "createdAt": -1})
db.inventory_operations.createIndex({"operationType": 1, "operationDate": -1})
db.inventory_operations.createIndex({"createdBy": 1, "createdAt": -1})
db.inventory_operations.createIndex({"batchId": 1})

// 预警规则表索引
db.inventory_alert_rules.createIndex({"scope": 1, "targetId": 1})
db.inventory_alert_rules.createIndex({"status": 1, "priority": -1})

// 预警记录表索引
db.inventory_alerts.createIndex({"materialId": 1, "alertTime": -1})
db.inventory_alerts.createIndex({"status": 1, "alertTime": -1})
db.inventory_alerts.createIndex({"alertLevel": 1, "status": 1})

// 库存统计表索引
db.inventory_statistics.createIndex({"date": -1, "materialId": 1})
db.inventory_statistics.createIndex({"date": -1, "categoryId": 1})
```

### 2. 缓存策略
- **Redis缓存**：
  - 库存仪表盘数据：缓存5分钟
  - 预警规则：缓存30分钟
  - 统计报表数据：缓存1小时
  - 分类库存分布：缓存15分钟

### 3. 查询优化
- 使用聚合管道优化复杂统计查询
- 分页查询使用游标分页（大数据量时）
- 报表查询使用预计算的统计表

---

## 单元测试要求

### 1. 库存管理测试用例

**测试账号**：
- 用户名：adminabaaaba
- 密码：xxx13579!

**测试用例**：
1. **库存监控测试**：
   - 获取库存仪表盘数据
   - 库存趋势数据准确性
   - 低库存预警列表
   - 实时数据更新

2. **库存调整测试**：
   - 单个库存调整（增加/减少/设置）
   - 批量库存调整
   - 调整后库存状态更新
   - 调整记录生成

3. **出入库操作测试**：
   - 入库操作和库存更新
   - 出库操作和库存检查
   - 批量出入库操作
   - 操作记录完整性

4. **预警系统测试**：
   - 预警规则创建和管理
   - 预警触发机制
   - 预警通知发送
   - 预警处理流程

5. **统计报表测试**：
   - 各类报表数据准确性
   - 报表导出功能
   - 时间范围筛选
   - 分类和材料筛选

---

## 安全要求

### 1. 数据安全
- 库存操作记录不可删除，只能标记状态
- 关键操作需要审批流程
- 敏感数据加密存储

### 2. 操作安全
- 库存调整操作日志记录
- 批量操作数量限制
- 异常操作监控和告警

### 3. 接口安全
- 库存调整接口需要特殊权限
- 批量操作频率限制
- 数据导出权限控制

### 4. 业务安全
- 库存不能为负数
- 出库数量不能超过可用库存
- 预警阈值合理性检查