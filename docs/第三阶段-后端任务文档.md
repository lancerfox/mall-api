# 第三阶段 - 后端任务文档
## 珠子材料库管理后台 - 库存管理系统

### 阶段目标
实现完整的库存管理系统后端API，包括库存列表、出入库操作等功能。

---

## 数据库设计

### 1. 库存记录表（inventory_records）
```sql
{
  _id: ObjectId,
  recordId: String,       // 库存记录唯一标识
  materialId: String,     // 材料ID
  currentStock: Number,   // 当前库存数量
  availableStock: Number, // 可用库存数量（扣除预留）
  reservedStock: Number,  // 预留库存数量
  alertThreshold: Number, // 预警阈值
  lastInboundAt: Date,    // 最后入库时间
  lastOutboundAt: Date,   // 最后出库时间
  totalInbound: Number,   // 累计入库数量
  totalOutbound: Number,  // 累计出库数量
  stockValue: Number,     // 库存价值（数量 * 单价）
  status: String,         // 库存状态：normal/warning/critical/out_of_stock
  createdAt: Date,        // 创建时间
  updatedAt: Date,        // 更新时间
  updatedBy: String       // 更新人
}
```

### 2. 库存操作记录表（inventory_operations）
```sql
{
  _id: ObjectId,
  operationId: String,    // 操作唯一标识
  materialId: String,     // 材料ID
  operationType: String,  // 操作类型：inbound/outbound/adjust
  quantity: Number,       // 操作数量（正数为入库，负数为出库）
  beforeStock: Number,    // 操作前库存
  afterStock: Number,     // 操作后库存
  unitPrice: Number,      // 单价（入库时记录）
  totalValue: Number,     // 总价值
  reason: String,         // 操作原因
  supplier: String,       // 供应商（入库时）
  customer: String,       // 客户（出库时）
  notes: String,          // 操作备注
  operationDate: Date,    // 操作日期
  batchId: String,        // 批次ID（批量操作时）
  status: String,         // 操作状态：pending/completed/cancelled
  createdAt: Date,        // 创建时间
  createdBy: String,      // 操作人
  approvedBy: String,     // 审批人（如需要）
  approvedAt: Date        // 审批时间
}
```
---

## API接口定义



### 1. 库存列表管理接口

#### 1.1 获取库存列表
**接口地址**：`POST /api/inventory/list`

**请求参数**：
```json
{
  "page": 1,              // 页码，必填
  "pageSize": 20,         // 每页数量，必填
  "keyword": "",          // 搜索关键词，可选
  "categoryId": "",       // 分类ID，可选
  "stockStatus": "",      // 库存状态，可选：normal/warning/critical/out_of_stock
  "stockMin": 0,          // 最小库存，可选
  "stockMax": 1000,       // 最大库存，可选
  "valueMin": 0.0,        // 最小价值，可选
  "valueMax": 10000.0,    // 最大价值，可选
  "sortBy": "currentStock", // 排序字段，可选
  "sortOrder": "desc"     // 排序方向，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "materialId": "M001",
        "materialName": "红玛瑙",
        "categoryId": "C001",
        "categoryName": "宝石类",
        "currentStock": 100,
        "availableStock": 95,
        "reservedStock": 5,
        "alertThreshold": 20,
        "stockStatus": "normal",
        "stockValue": 1500.00,
        "unitPrice": 15.00,
        "lastInboundAt": "2024-01-01T00:00:00.000Z",
        "lastOutboundAt": "2024-01-01T00:00:00.000Z",
        "updatedAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

**字段校验规则**：
- page：必填，整数，>= 1
- pageSize：必填，整数，范围[10, 20, 50, 100]
- keyword：可选，字符串，最大长度50
- categoryId：可选，字符串，必须是有效的分类ID
- stockStatus：可选，字符串，值为normal/warning/critical/out_of_stock
- stockMin/stockMax：可选，整数，>= 0，stockMin <= stockMax
- valueMin/valueMax：可选，数值，>= 0，valueMin <= valueMax
- sortBy：可选，字符串，允许值：materialName/currentStock/stockValue/updatedAt
- sortOrder：可选，字符串，值为asc/desc

#### 1.2 库存调整
**接口地址**：`POST /api/inventory/adjust`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "adjustType": "add",    // 调整类型，必填：add/subtract/set
  "quantity": 10,         // 调整数量，必填
  "reason": "入库",       // 调整原因，必填
  "notes": "采购入库",    // 调整备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选，默认当前日期
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "库存调整成功",
  "data": {
    "operationId": "OP001",
    "beforeStock": 90,
    "afterStock": 100,
    "adjustQuantity": 10
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- adjustType：必填，字符串，值为add/subtract/set
- quantity：必填，整数，> 0，subtract时不能超过当前库存，set时为目标库存数量
- reason：必填，字符串，长度2-50
- notes：可选，字符串，最大长度500
- operationDate：可选，日期格式YYYY-MM-DD，不能晚于当前日期

#### 1.3 批量库存调整
**接口地址**：`POST /api/inventory/batch-adjust`

**请求参数**：
```json
{
  "adjustments": [        // 调整列表，必填
    {
      "materialId": "M001",
      "adjustType": "add",
      "quantity": 10,
      "reason": "入库",
      "notes": "批量入库"
    }
  ],
  "batchNotes": "批量调整操作", // 批次备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量调整完成",
  "data": {
    "batchId": "BATCH001",
    "successCount": 5,
    "failedCount": 1,
    "successList": [
      {
        "materialId": "M001",
        "operationId": "OP001",
        "beforeStock": 90,
        "afterStock": 100
      }
    ],
    "failedList": [
      {
        "materialId": "M002",
        "error": "库存不足"
      }
    ]
  }
}
```

**字段校验规则**：
- adjustments：必填，数组，长度1-1000
- 数组元素校验规则与单个调整接口相同
- batchNotes：可选，字符串，最大长度500
- operationDate：可选，日期格式

---

### 2. 出入库操作接口

#### 2.1 入库操作
**接口地址**：`POST /api/inventory/inbound`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "quantity": 100,        // 入库数量，必填
  "unitPrice": 15.50,     // 入库单价，可选
  "supplier": "供应商A",   // 供应商，可选
  "reason": "采购",       // 入库原因，必填
  "notes": "新采购的红玛瑙", // 备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "入库成功",
  "data": {
    "operationId": "OP001",
    "beforeStock": 50,
    "afterStock": 150,
    "totalValue": 1550.00
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- quantity：必填，正整数
- unitPrice：可选，数值，>= 0
- supplier：可选，字符串，最大长度50
- reason：必填，字符串，从预定义列表选择：采购/退货/调拨/盘盈/其他
- notes：可选，字符串，最大长度500
- operationDate：可选，日期格式，不能晚于当前日期

#### 2.2 出库操作
**接口地址**：`POST /api/inventory/outbound`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "quantity": 50,         // 出库数量，必填
  "customer": "客户A",     // 客户，可选
  "reason": "销售",       // 出库原因，必填
  "notes": "销售给客户A",  // 备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "出库成功",
  "data": {
    "operationId": "OP002",
    "beforeStock": 150,
    "afterStock": 100,
    "totalValue": 775.00
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- quantity：必填，正整数，不能超过可用库存
- customer：可选，字符串，最大长度50
- reason：必填，字符串，从预定义列表选择：销售/损耗/调拨/盘亏/其他
- notes：可选，字符串，最大长度500
- operationDate：可选，日期格式，不能晚于当前日期

#### 2.3 批量入库
**接口地址**：`POST /api/inventory/batch-inbound`

**请求参数**：
```json
{
  "operations": [         // 入库操作列表，必填
    {
      "materialId": "M001",
      "quantity": 100,
      "unitPrice": 15.50,
      "supplier": "供应商A",
      "reason": "采购",
      "notes": "批量采购"
    }
  ],
  "batchNotes": "批量入库操作", // 批次备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量入库完成",
  "data": {
    "batchId": "BATCH002",
    "successCount": 5,
    "failedCount": 0,
    "totalQuantity": 500,
    "totalValue": 7750.00,
    "successList": [
      {
        "materialId": "M001",
        "operationId": "OP003",
        "quantity": 100,
        "value": 1550.00
      }
    ],
    "failedList": []
  }
}
```

**字段校验规则**：
- operations：必填，数组，长度1-1000
- 数组元素校验规则与单个入库接口相同
- batchNotes：可选，字符串，最大长度500
- operationDate：可选，日期格式

#### 2.4 批量出库
**接口地址**：`POST /api/inventory/batch-outbound`

**请求参数**：
```json
{
  "operations": [         // 出库操作列表，必填
    {
      "materialId": "M001",
      "quantity": 50,
      "customer": "客户A",
      "reason": "销售",
      "notes": "批量销售"
    }
  ],
  "batchNotes": "批量出库操作", // 批次备注，可选
  "operationDate": "2024-01-01" // 操作日期，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量出库完成",
  "data": {
    "batchId": "BATCH003",
    "successCount": 3,
    "failedCount": 2,
    "totalQuantity": 150,
    "totalValue": 2325.00,
    "successList": [
      {
        "materialId": "M001",
        "operationId": "OP004",
        "quantity": 50,
        "value": 775.00
      }
    ],
    "failedList": [
      {
        "materialId": "M002",
        "error": "库存不足"
      }
    ]
  }
}
```

**字段校验规则**：
- operations：必填，数组，长度1-1000
- 数组元素校验规则与单个出库接口相同
- batchNotes：可选，字符串，最大长度500
- operationDate：可选，日期格式

#### 2.5 获取出入库记录列表
**接口地址**：`GET /api/inventory/operation-list`

**请求参数**：
```json
{
  "page": 1,              // 页码，必填
  "pageSize": 20,         // 每页数量，必填
  "materialId": "",       // 材料ID，可选
  "operationType": "",    // 操作类型，可选：inbound/outbound/adjust
  "reason": "",           // 操作原因，可选
  "dateStart": "2024-01-01", // 开始日期，可选
  "dateEnd": "2024-01-31",   // 结束日期，可选
  "createdBy": "",        // 操作人，可选
  "sortBy": "createdAt",  // 排序字段，可选
  "sortOrder": "desc"     // 排序方向，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "operationId": "OP001",
        "materialId": "M001",
        "materialName": "红玛瑙",
        "operationType": "inbound",
        "quantity": 100,
        "beforeStock": 50,
        "afterStock": 150,
        "unitPrice": 15.50,
        "totalValue": 1550.00,
        "reason": "采购",
        "supplier": "供应商A",
        "notes": "新采购的红玛瑙",
        "operationDate": "2024-01-01",
        "createdAt": "2024-01-01T00:00:00.000Z",
        "createdBy": "admin"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

**字段校验规则**：
- page：必填，整数，>= 1
- pageSize：必填，整数，范围[10, 20, 50, 100]
- materialId：可选，字符串，必须是有效的材料ID
- operationType：可选，字符串，值为inbound/outbound/adjust
- reason：可选，字符串
- dateStart/dateEnd：可选，日期格式，dateStart <= dateEnd
- createdBy：可选，字符串
- sortBy：可选，字符串，允许值：operationDate/createdAt/quantity/totalValue
- sortOrder：可选，字符串，值为asc/desc

---





## 性能优化

### 1. 数据库索引
```javascript
// 库存记录表索引
db.inventory_records.createIndex({"materialId": 1})
db.inventory_records.createIndex({"status": 1})
db.inventory_records.createIndex({"updatedAt": -1})

// 库存操作记录表索引
db.inventory_operations.createIndex({"materialId": 1, "createdAt": -1})
db.inventory_operations.createIndex({"operationType": 1, "operationDate": -1})
db.inventory_operations.createIndex({"createdBy": 1, "createdAt": -1})
db.inventory_operations.createIndex({"batchId": 1})

```

### 2. 查询优化
- 使用聚合管道优化复杂统计查询
- 分页查询使用游标分页（大数据量时）

---
## 安全要求

### 1. 数据安全
- 库存操作记录不可删除，只能标记状态
- 关键操作需要审批流程
- 敏感数据加密存储

### 2. 操作安全
- 库存调整操作日志记录
- 批量操作数量限制

### 3. 接口安全
- 库存调整接口需要特殊权限
- 批量操作频率限制
- 数据导出权限控制

### 4. 业务安全
- 库存不能为负数
- 出库数量不能超过可用库存