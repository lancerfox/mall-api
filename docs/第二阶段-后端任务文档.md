# 第二阶段 - 后端任务文档
## 珠子材料库管理后台 - 高级材料管理功能

### 阶段目标
在第一阶段基础上，实现图片上传管理、高级搜索、批量操作等功能的后端API支持。

---

## 数据库设计扩展

### 1. 材料图片表（material_images）
```sql
{
  _id: ObjectId,
  imageId: String,        // 图片唯一标识
  materialId: String,     // 关联的材料ID
  fileName: String,       // 原始文件名
  filePath: String,       // 文件存储路径
  fileSize: Number,       // 文件大小（字节）
  mimeType: String,       // 文件类型
  width: Number,          // 图片宽度
  height: Number,         // 图片高度
  sortOrder: Number,      // 排序值，0为主图
  isMain: Boolean,        // 是否为主图
  thumbnailPath: String,  // 缩略图路径
  status: String,         // 状态：active/deleted
  createdAt: Date,        // 创建时间
  updatedAt: Date,        // 更新时间
  createdBy: String       // 创建人
}
```

### 2. 搜索条件表（search_conditions）
```sql
{
  _id: ObjectId,
  conditionId: String,    // 搜索条件唯一标识
  userId: String,         // 用户ID
  name: String,           // 搜索条件名称
  conditions: Object,     // 搜索条件JSON
  isDefault: Boolean,     // 是否为默认条件
  useCount: Number,       // 使用次数
  lastUsedAt: Date,       // 最后使用时间
  createdAt: Date,        // 创建时间
  updatedAt: Date         // 更新时间
}
```

### 3. 操作日志表（operation_logs）
```sql
{
  _id: ObjectId,
  logId: String,          // 日志唯一标识
  userId: String,         // 操作用户ID
  operation: String,      // 操作类型：create/update/delete/batch_update等
  targetType: String,     // 操作对象类型：material/category/image
  targetId: String,       // 操作对象ID
  oldData: Object,        // 操作前数据
  newData: Object,        // 操作后数据
  description: String,    // 操作描述
  ipAddress: String,      // 操作IP地址
  userAgent: String,      // 用户代理
  createdAt: Date         // 操作时间
}
```

---

## API接口定义

### 1. 图片管理接口

#### 1.1 上传单张图片
**接口地址**：`POST /api/upload/image`

**请求参数**：
```
Content-Type: multipart/form-data
materialId: String      // 材料ID，必填
file: File              // 图片文件，必填
sortOrder: Number       // 排序值，可选，默认为当前最大值+1
```

**响应数据**：
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "imageId": "IMG001",
    "fileName": "red_agate.jpg",
    "filePath": "/uploads/materials/M001/IMG001.jpg",
    "thumbnailPath": "/uploads/materials/M001/thumb_IMG001.jpg",
    "fileSize": 1024000,
    "width": 800,
    "height": 600,
    "sortOrder": 1,
    "isMain": false
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- file：必填，文件类型限制为jpg/jpeg/png/webp，大小不超过5MB
- sortOrder：可选，整数，>= 0

#### 1.2 批量上传图片
**接口地址**：`POST /api/upload/batch-images`

**请求参数**：
```
Content-Type: multipart/form-data
materialId: String      // 材料ID，必填
files: File[]           // 图片文件数组，必填，最多10个文件
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量上传完成",
  "data": {
    "successCount": 3,
    "failedCount": 1,
    "successList": [
      {
        "imageId": "IMG001",
        "fileName": "image1.jpg",
        "filePath": "/uploads/materials/M001/IMG001.jpg"
      }
    ],
    "failedList": [
      {
        "fileName": "image4.jpg",
        "error": "文件格式不支持"
      }
    ]
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- files：必填，文件数组，最多10个文件，每个文件大小不超过5MB

#### 1.3 删除图片
**接口地址**：`POST /api/upload/delete-image`

**请求参数**：
```json
{
  "imageId": "IMG001"     // 图片ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**字段校验规则**：
- imageId：必填，字符串，必须是有效的图片ID

#### 1.4 获取材料图片列表
**接口地址**：`GET /api/upload/image-list`

**请求参数**：
```json
{
  "materialId": "M001"    // 材料ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "imageId": "IMG001",
      "fileName": "red_agate.jpg",
      "filePath": "/uploads/materials/M001/IMG001.jpg",
      "thumbnailPath": "/uploads/materials/M001/thumb_IMG001.jpg",
      "fileSize": 1024000,
      "width": 800,
      "height": 600,
      "sortOrder": 0,
      "isMain": true,
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID

#### 1.5 设置主图
**接口地址**：`POST /api/upload/set-main-image`

**请求参数**：
```json
{
  "imageId": "IMG001"     // 图片ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "设置成功",
  "data": null
}
```

**字段校验规则**：
- imageId：必填，字符串，必须是有效的图片ID

#### 1.6 调整图片排序
**接口地址**：`POST /api/upload/sort-images`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "imageIds": ["IMG001", "IMG002", "IMG003"]  // 图片ID数组，按新顺序排列
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "排序成功",
  "data": null
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- imageIds：必填，字符串数组，所有ID必须属于指定材料

---

### 2. 高级搜索接口

#### 2.1 高级搜索
**接口地址**：`POST /api/material/advanced-search`

**请求参数**：
```json
{
  "page": 1,              // 页码，必填
  "pageSize": 20,         // 每页数量，必填
  "conditions": {
    "name": "玛瑙",         // 材料名称，可选
    "categoryIds": ["C001", "C002"], // 分类ID数组，可选
    "priceMin": 10.0,      // 最低价格，可选
    "priceMax": 100.0,     // 最高价格，可选
    "stockMin": 0,         // 最低库存，可选
    "stockMax": 1000,      // 最高库存，可选
    "colors": ["红色", "蓝色"], // 颜色数组，可选
    "hardnessMin": 1,      // 最低硬度，可选
    "hardnessMax": 10,     // 最高硬度，可选
    "densityMin": 1.0,     // 最低密度，可选
    "densityMax": 5.0,     // 最高密度，可选
    "dateStart": "2024-01-01", // 开始日期，可选
    "dateEnd": "2024-12-31",   // 结束日期，可选
    "status": ["enabled", "disabled"] // 状态数组，可选
  },
  "sortBy": "createdAt",  // 排序字段，可选
  "sortOrder": "desc"     // 排序方向，可选：asc/desc
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "materialId": "M001",
        "name": "红玛瑙",
        "categoryId": "C001",
        "categoryName": "宝石类",
        "price": 15.50,
        "stock": 100,
        "color": "红色",
        "hardness": 7,
        "density": 2.65,
        "status": "enabled",
        "mainImage": "/uploads/materials/M001/thumb_IMG001.jpg",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 20,
    "totalPages": 3,
    "searchTime": 120  // 搜索耗时（毫秒）
  }
}
```

**字段校验规则**：
- page：必填，整数，>= 1
- pageSize：必填，整数，范围[10, 20, 50, 100]
- conditions.name：可选，字符串，最大长度50
- conditions.categoryIds：可选，字符串数组，每个ID必须有效
- conditions.priceMin/priceMax：可选，数值，>= 0，priceMin <= priceMax
- conditions.stockMin/stockMax：可选，整数，>= 0，stockMin <= stockMax
- conditions.colors：可选，字符串数组
- conditions.hardnessMin/hardnessMax：可选，数值，范围1-10，hardnessMin <= hardnessMax
- conditions.densityMin/densityMax：可选，数值，> 0，densityMin <= densityMax
- conditions.dateStart/dateEnd：可选，日期格式YYYY-MM-DD，dateStart <= dateEnd
- conditions.status：可选，字符串数组，值为["enabled", "disabled"]
- sortBy：可选，字符串，允许值：name/price/stock/createdAt/updatedAt
- sortOrder：可选，字符串，值为"asc"或"desc"

#### 2.2 保存搜索条件
**接口地址**：`POST /api/search/save-condition`

**请求参数**：
```json
{
  "name": "高价值宝石",     // 搜索条件名称，必填
  "conditions": {         // 搜索条件，必填
    "categoryIds": ["C001"],
    "priceMin": 50.0,
    "status": ["enabled"]
  },
  "isDefault": false      // 是否设为默认，可选
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "保存成功",
  "data": {
    "conditionId": "SC001"
  }
}
```

**字段校验规则**：
- name：必填，字符串，长度2-50，用户下名称不能重复
- conditions：必填，对象，搜索条件JSON
- isDefault：可选，布尔值，默认false

#### 2.3 获取保存的搜索条件列表
**接口地址**：`GET /api/search/condition-list`

**请求参数**：无

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "conditionId": "SC001",
      "name": "高价值宝石",
      "conditions": {
        "categoryIds": ["C001"],
        "priceMin": 50.0,
        "status": ["enabled"]
      },
      "isDefault": false,
      "useCount": 5,
      "lastUsedAt": "2024-01-01T00:00:00.000Z",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

#### 2.4 删除搜索条件
**接口地址**：`POST /api/search/delete-condition`

**请求参数**：
```json
{
  "conditionId": "SC001"  // 搜索条件ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**字段校验规则**：
- conditionId：必填，字符串，必须是有效的搜索条件ID

---

### 3. 批量操作接口

#### 3.1 批量更新材料
**接口地址**：`POST /api/material/batch-update`

**请求参数**：
```json
{
  "materialIds": ["M001", "M002", "M003"], // 材料ID数组，必填
  "updateData": {         // 要更新的数据，必填
    "categoryId": "C002", // 可选，新分类ID
    "price": {            // 可选，价格调整
      "type": "multiply", // 调整类型：multiply(乘以)/add(增加)/set(设置)
      "value": 1.1        // 调整值
    },
    "stock": {            // 可选，库存调整
      "type": "add",      // 调整类型：add(增加)/subtract(减少)/set(设置)
      "value": 10         // 调整值
    },
    "status": "enabled"   // 可选，新状态
  }
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量更新完成",
  "data": {
    "successCount": 2,
    "failedCount": 1,
    "successIds": ["M001", "M002"],
    "failedList": [
      {
        "materialId": "M003",
        "error": "材料不存在"
      }
    ]
  }
}
```

**字段校验规则**：
- materialIds：必填，字符串数组，长度1-1000，每个ID必须有效
- updateData：必填，对象，至少包含一个更新字段
- updateData.categoryId：可选，字符串，必须是有效的分类ID
- updateData.price.type：可选，字符串，值为"multiply"/"add"/"set"
- updateData.price.value：可选，数值，multiply时范围0.1-10，add时可为负数，set时>= 0
- updateData.stock.type：可选，字符串，值为"add"/"subtract"/"set"
- updateData.stock.value：可选，整数，>= 0（set时），其他情况可为负数但结果不能小于0
- updateData.status：可选，字符串，值为"enabled"或"disabled"

#### 3.2 批量移动分类
**接口地址**：`POST /api/material/batch-move-category`

**请求参数**：
```json
{
  "materialIds": ["M001", "M002", "M003"], // 材料ID数组，必填
  "targetCategoryId": "C002"               // 目标分类ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "批量移动完成",
  "data": {
    "successCount": 3,
    "failedCount": 0,
    "successIds": ["M001", "M002", "M003"],
    "failedList": []
  }
}
```

**字段校验规则**：
- materialIds：必填，字符串数组，长度1-1000，每个ID必须有效
- targetCategoryId：必填，字符串，必须是有效的分类ID

#### 3.3 批量导出材料数据
**接口地址**：`POST /api/material/batch-export`

**请求参数**：
```json
{
  "materialIds": ["M001", "M002"],  // 材料ID数组，可选，为空则导出所有
  "fields": [               // 导出字段，可选，为空则导出所有字段
    "name", "categoryName", "price", "stock", "status"
  ],
  "format": "xlsx"          // 导出格式，可选，默认xlsx
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "导出成功",
  "data": {
    "fileUrl": "/exports/materials_20240101_123456.xlsx",
    "fileName": "materials_20240101_123456.xlsx",
    "fileSize": 1024000,
    "recordCount": 100
  }
}
```

**字段校验规则**：
- materialIds：可选，字符串数组，每个ID必须有效
- fields：可选，字符串数组，字段名必须有效
- format：可选，字符串，目前仅支持"xlsx"

#### 3.4 导入材料数据
**接口地址**：`POST /api/material/import`

**请求参数**：
```
Content-Type: multipart/form-data
file: File              // Excel文件，必填
mode: String            // 导入模式：create(仅创建)/update(仅更新)/upsert(创建或更新)
```

**响应数据**：
```json
{
  "code": 200,
  "message": "导入完成",
  "data": {
    "totalCount": 100,
    "successCount": 95,
    "failedCount": 5,
    "createdCount": 80,
    "updatedCount": 15,
    "failedList": [
      {
        "row": 2,
        "data": {"name": "测试材料", "price": "abc"},
        "errors": ["价格必须为数值"]
      }
    ]
  }
}
```

**字段校验规则**：
- file：必填，Excel文件(.xlsx)，大小不超过10MB
- mode：可选，字符串，值为"create"/"update"/"upsert"，默认"upsert"

---

### 4. 材料详情增强接口

#### 4.1 获取增强的材料详情
**接口地址**：`GET /api/material/detail-enhanced`

**请求参数**：
```json
{
  "materialId": "M001"    // 材料ID，必填
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "materialId": "M001",
    "name": "红玛瑙",
    "categoryId": "C001",
    "categoryName": "宝石类",
    "categoryPath": "宝石类/玛瑙",
    "price": 15.50,
    "stock": 100,
    "description": "天然红玛瑙",
    "color": "红色",
    "hardness": 7,
    "density": 2.65,
    "status": "enabled",
    "images": [
      {
        "imageId": "IMG001",
        "filePath": "/uploads/materials/M001/IMG001.jpg",
        "thumbnailPath": "/uploads/materials/M001/thumb_IMG001.jpg",
        "isMain": true,
        "sortOrder": 0
      }
    ],
    "stats": {
      "viewCount": 150,     // 查看次数
      "editCount": 5,       // 编辑次数
      "lastViewAt": "2024-01-01T00:00:00.000Z",
      "lastEditAt": "2024-01-01T00:00:00.000Z"
    },
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z",
    "createdBy": "admin",
    "updatedBy": "admin"
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID

#### 4.2 获取相关材料推荐
**接口地址**：`GET /api/material/related`

**请求参数**：
```json
{
  "materialId": "M001",   // 材料ID，必填
  "limit": 6              // 推荐数量，可选，默认6
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "sameCategory": [      // 同分类材料
      {
        "materialId": "M002",
        "name": "蓝玛瑙",
        "price": 18.00,
        "mainImage": "/uploads/materials/M002/thumb_IMG001.jpg"
      }
    ],
    "similarPrice": [      // 相似价格材料
      {
        "materialId": "M003",
        "name": "绿松石",
        "price": 16.50,
        "mainImage": "/uploads/materials/M003/thumb_IMG001.jpg"
      }
    ],
    "similarProperties": [ // 相似属性材料
      {
        "materialId": "M004",
        "name": "红碧玺",
        "price": 25.00,
        "mainImage": "/uploads/materials/M004/thumb_IMG001.jpg"
      }
    ]
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- limit：可选，整数，范围1-20，默认6

#### 4.3 复制材料
**接口地址**：`POST /api/material/copy`

**请求参数**：
```json
{
  "materialId": "M001",   // 源材料ID，必填
  "newName": "红玛瑙(副本)", // 新材料名称，可选，默认在原名称后加"(副本)"
  "copyImages": true      // 是否复制图片，可选，默认true
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "复制成功",
  "data": {
    "materialId": "M005",
    "name": "红玛瑙(副本)"
  }
}
```

**字段校验规则**：
- materialId：必填，字符串，必须是有效的材料ID
- newName：可选，字符串，长度2-50，不能与现有材料名称重复
- copyImages：可选，布尔值，默认true

---

## 文件存储策略

### 1. 目录结构
```
/uploads/
  /materials/
    /20240101/        // 按年月日分目录
      /M001/            // 材料ID目录
        /IMG001.jpg     // 原图
        /thumb_IMG001.jpg // 缩略图
        /medium_IMG001.jpg // 中等尺寸图
    /20240102/
      /M002/
        /IMG002.jpg
        /thumb_IMG002.jpg
  /exports/             // 导出文件目录
    /materials_20240101_123456.xlsx
  /imports/             // 导入文件临时目录
    /temp_20240101_123456.xlsx
```

### 2. 图片处理规则
- **原图**：保持原始尺寸，压缩质量90%
- **缩略图**：150x150像素，压缩质量80%
- **中等尺寸图**：500x500像素，压缩质量85%
- **支持格式**：jpg, jpeg, png, webp
- **命名规则**：材料ID_图片ID_尺寸.扩展名

### 3. 文件清理策略
- **按材料清理**：删除材料时，同时删除相关图片文件
- **导出文件**：保留7天后自动清理
- **导入临时文件**：处理完成后立即清理
- **清理机制**：每日凌晨执行清理任务，按日期目录批量删除过期文件

---

## 性能优化

### 1. 数据库索引优化
```javascript
// 材料表索引
db.materials.createIndex({"name": "text", "description": "text"}) // 全文搜索
db.materials.createIndex({"categoryId": 1, "status": 1})
db.materials.createIndex({"price": 1})
db.materials.createIndex({"stock": 1})
db.materials.createIndex({"createdAt": -1})

// 图片表索引
db.material_images.createIndex({"materialId": 1, "sortOrder": 1})
db.material_images.createIndex({"status": 1})

// 搜索条件表索引
db.search_conditions.createIndex({"userId": 1, "lastUsedAt": -1})

// 操作日志表索引
db.operation_logs.createIndex({"userId": 1, "createdAt": -1})
db.operation_logs.createIndex({"targetType": 1, "targetId": 1})
```


### 2. 查询优化
- 高级搜索使用聚合管道优化
- 分页查询使用游标分页（大数据量时）
- 图片列表查询只返回必要字段

## 安全要求增强

### 1. 文件上传安全
- 文件类型白名单验证
- 文件内容检测（防止恶意文件）
- 文件大小限制
- 上传频率限制
- 文件存储路径安全

### 2. 批量操作安全
- 操作数量限制
- 权限验证
- 操作日志记录
- 事务处理保证数据一致性

### 3. 数据导入导出安全
- 文件格式验证
- 数据内容校验
- 导出权限控制
- 敏感数据脱敏

### 4. API安全
- 请求频率限制
- 参数校验增强
- SQL注入防护
- XSS攻击防护