# 项目运行流程说明

## 项目概述

这是一个基于 NestJS 框架开发的商城后台管理系统 API，采用 TypeScript 语言编写。项目包含用户管理、角色管理、权限管理、菜单管理、商品管理、订单管理、图片管理和操作日志等功能模块。

## 项目架构

项目采用了经典的 MVC（Model-View-Controller）架构模式，结合了 NestJS 的模块化设计：

- **Controller（控制器）**：处理 HTTP 请求，负责接收用户输入并返回响应
- **Service（服务）**：处理业务逻辑
- **Entity（实体）**：数据模型，对应数据库表结构
- **DTO（数据传输对象）**：定义数据格式和验证规则
- **Module（模块）**：组织代码，管理依赖关系

## 项目运行流程

### 1. 应用启动流程

1. **main.ts 启动**：
   - 通过 `NestFactory.create(AppModule)` 创建应用实例
   - 配置跨域策略（CORS）
   - 设置全局路由前缀为 `/api`
   - 注册全局管道（ValidationPipe）和过滤器（HttpExceptionFilter）
   - 配置 Swagger API 文档
   - 启动服务并监听指定端口

2. **AppModule 加载**：
   - 配置 PostgreSQL 数据库连接
   - 注册全局守卫（JwtAuthGuard、RolesGuard）
   - 注册全局拦截器（TransformInterceptor）
   - 注册全局过滤器（HttpExceptionFilter）
   - 加载各个业务模块（UserModule、AuthModule 等）

### 2. HTTP 请求处理流程

当客户端发送 HTTP 请求时，请求会经过以下步骤：

1. **路由匹配**：NestJS 根据 URL 和 HTTP 方法匹配到对应的 Controller 和方法
2. **全局守卫（Guards）**：
   - 检查请求是否需要认证（JWT 验证）
   - 验证用户权限
3. **管道（Pipes）**：
   - 验证请求数据格式
   - 转换请求数据到 DTO 对象
4. **控制器（Controller）**：
   - 接收请求参数
   - 调用对应的服务方法
5. **服务（Service）**：
   - 执行业务逻辑
   - 与数据库交互
6. **拦截器（Interceptors）**：
   - 格式化响应数据
   - 统一响应格式
7. **响应返回**：将处理结果返回给客户端

## 接口调用详细流程示例（以用户登录为例）

### 1. 接口地址
`POST /api/auth/login`

### 2. Controller 层 - AuthController

```typescript
@Public()
@Post('login')
async login(
  @Body() loginDto: LoginDto,
  @Ip() ip: string,
): Promise<ILoginResponse> {
  const user = await this.authService.validateUser(
    loginDto.username,
    loginDto.password,
    ip,
  );
  return this.authService.login(user, ip);
}
```

**功能说明**：
- 接收客户端发送的登录数据（用户名和密码）
- 调用 AuthService 的 `validateUser` 方法验证用户凭据
- 调用 AuthService 的 `login` 方法生成 JWT 令牌
- 返回包含访问令牌的响应

### 3. Service 层 - AuthService

`validateUser` 方法：
```typescript
async validateUser(
  username: string,
  password: string,
  ip?: string,
): Promise<IUserWithoutPassword> {
  // 1. 检查账户是否被锁定
  if (ip && this.securityService.isAccountLocked(username, ip)) {
    // ...
  }

  // 2. 从数据库查询用户信息
  const user = await this.userService.findOne(username);

  // 3. 验证用户状态和密码
  let isValid = false;
  if (user) {
    if (user.status === 'locked') {
      throw new BusinessException(ERROR_CODES.ACCOUNT_LOCKED);
    }
    
    if (user.status === 'inactive') {
      throw new BusinessException(ERROR_CODES.ACCOUNT_DISABLED);
    }
    
    // 使用 bcrypt 比较密码
    isValid = await bcrypt.compare(password, user.password);
  }

  // 4. 记录登录尝试
  if (ip) {
    this.securityService.recordLoginAttempt(username, ip, isValid);
  }

  if (user && isValid) {
    const { password, ...result } = user;
    const profile = await this.getProfile(user.id);
    return {
      ...result,
      permissions: profile.permissions,
    };
  }

  throw new BusinessException(ERROR_CODES.AUTH_INVALID_CREDENTIALS);
}
```

`login` 方法：
```typescript
async login(
  user: IUserWithoutPassword,
  ip?: string,
): Promise<ILoginResponse> {
  // 1. 更新最后登录时间
  await this.userService.updateLastLogin(user.id, ip);

  // 2. 生成 JWT 令牌
  const accessTokenPayload: IJwtPayload = {
    username: user.username,
    sub: user.id,
    role: user.roles && user.roles.length > 0 ? user.roles[0].name : '',
  };

  const accessToken = this.jwtService.sign(accessTokenPayload, {
    secret: this.configService.get('JWT_SECRET'),
    expiresIn: this.configService.get('JWT_EXPIRES_IN', '1h'),
  });

  return {
    access_token: accessToken,
    expires_in: this.parseExpiresIn(this.configService.get('JWT_EXPIRES_IN', '1h')),
  };
}
```

**功能说明**：
- 验证用户凭据（用户名和密码）
- 检查账户状态（是否被锁定、禁用）
- 记录登录尝试（用于安全统计）
- 生成 JWT 令牌
- 更新用户的最后登录时间

### 4. Service 层 - UserService

`updateLastLogin` 方法：
```typescript
async updateLastLogin(id: string, ip?: string): Promise<void> {
  const updateData: { lastLoginTime: Date; lastLoginIp?: string } = {
    lastLoginTime: new Date(),
  };

  if (ip) {
    updateData.lastLoginIp = ip;
  }

  await this.userRepository.update(id, updateData);
}
```

`findOne` 方法：
```typescript
async findOne(username: string): Promise<User | null> {
  return this.userRepository.findOne({
    where: { username },
    relations: ['roles', 'roles.permissions'],
  });
}
```

**功能说明**：
- 与数据库交互，查询用户信息
- 更新用户最后登录时间和 IP

## 项目核心组件

### 1. 全局守卫（Guards）

- **JwtAuthGuard**：验证 JWT 令牌，确保只有经过认证的用户才能访问受保护的接口
- **RolesGuard**：验证用户权限，确保用户具有执行特定操作的权限

### 2. 全局管道（Pipes）

- **ValidationPipe**：验证请求数据格式，确保数据符合 DTO 定义

### 3. 全局拦截器（Interceptors）

- **TransformInterceptor**：统一格式化响应数据，确保所有 API 响应都遵循相同的结构

### 4. 全局过滤器（Filters）

- **HttpExceptionFilter**：统一处理异常，返回标准化的错误响应

## 项目运行命令

- 启动开发环境：`npm run start:dev`
- 启动生产环境：`npm run start:prod`
- 运行测试：`npm test`
- 构建项目：`npm run build`

## 数据库

项目使用 PostgreSQL 作为数据库，通过 TypeORM 进行数据库操作。数据库配置在环境变量中定义。

## API 文档

项目集成了 Swagger，API 文档可以在 `http://localhost:3000/api/docs` 访问（端口号根据实际配置可能不同）。