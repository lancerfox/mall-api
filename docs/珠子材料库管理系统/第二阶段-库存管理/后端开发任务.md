# 第二阶段 - 库存管理后端开发任务

## 任务概述

实现珠子材料库存管理功能，包括出入库操作、库存变更记录、库存预警机制等核心功能。

## 开发任务

### 任务1: 扩展数据模型 (预估时间: 2小时)

#### 1.1 库存变更记录Schema完善
**文件**: `src/modules/bead-material/inventory/schemas/inventory-record.schema.ts`

**字段结构**:
```typescript
InventoryRecord {
  _id: ObjectId
  material_id: ObjectId           // 材料ID
  change_type: 'in' | 'out' | 'adjust'  // 变更类型
  quantity: number                // 变更数量
  old_quantity: number           // 变更前数量
  new_quantity: number           // 变更后数量
  reason?: string                // 变更原因
  operator: ObjectId             // 操作人ID
  batch_id?: string              // 批次ID
  created_at: Date               // 创建时间
}
```

**索引设计**:
- 复合索引：material_id + created_at
- 复合索引：change_type + created_at
- 单字段索引：operator
- 单字段索引：batch_id

### 任务2: 创建库存管理DTO (预估时间: 1小时)

#### 2.1 库存操作DTO
**文件**: `src/modules/bead-material/inventory/dto/stock-operation.dto.ts`

**需要创建的DTO**:
- `StockInDto` - 入库操作参数
- `StockOutDto` - 出库操作参数
- `StockAdjustDto` - 库存调整参数
- `InventoryHistoryQueryDto` - 库存历史查询参数

#### 2.2 入库操作DTO验证规则
```typescript
export class StockInDto {
  @IsMongoId({ message: '材料ID格式不正确' })
  @IsNotEmpty({ message: '材料ID不能为空' })
  material_id: string;

  @IsNumber({}, { message: '入库数量必须是数字' })
  @IsInt({ message: '入库数量必须是整数' })
  @Min(1, { message: '入库数量不能小于1' })
  @Max(999999, { message: '入库数量不能大于999999' })
  @Type(() => Number)
  quantity: number;

  @IsOptional()
  @IsString({ message: '入库原因必须是字符串' })
  @MaxLength(200, { message: '入库原因不能超过200个字符' })
  @Transform(({ value }) => value?.trim() || '')
  reason?: string;
}
```

#### 2.3 出库操作DTO验证规则
```typescript
export class StockOutDto {
  @IsMongoId({ message: '材料ID格式不正确' })
  @IsNotEmpty({ message: '材料ID不能为空' })
  material_id: string;

  @IsNumber({}, { message: '出库数量必须是数字' })
  @IsInt({ message: '出库数量必须是整数' })
  @Min(1, { message: '出库数量不能小于1' })
  @Max(999999, { message: '出库数量不能大于999999' })
  @Type(() => Number)
  quantity: number;

  @IsOptional()
  @IsString({ message: '出库原因必须是字符串' })
  @MaxLength(200, { message: '出库原因不能超过200个字符' })
  @Transform(({ value }) => value?.trim() || '')
  reason?: string;
}
```

#### 2.4 库存调整DTO验证规则
```typescript
export class StockAdjustDto {
  @IsMongoId({ message: '材料ID格式不正确' })
  @IsNotEmpty({ message: '材料ID不能为空' })
  material_id: string;

  @IsNumber({}, { message: '新库存数量必须是数字' })
  @IsInt({ message: '新库存数量必须是整数' })
  @Min(0, { message: '新库存数量不能小于0' })
  @Max(999999, { message: '新库存数量不能大于999999' })
  @Type(() => Number)
  new_quantity: number;

  @IsOptional()
  @IsString({ message: '调整原因必须是字符串' })
  @MaxLength(200, { message: '调整原因不能超过200个字符' })
  @Transform(({ value }) => value?.trim() || '')
  reason?: string;
}
```

#### 2.5 库存历史查询DTO验证规则
```typescript
export class InventoryHistoryQueryDto extends PaginationDto {
  @IsOptional()
  @IsMongoId({ message: '材料ID格式不正确' })
  material_id?: string;

  @IsOptional()
  @IsDateString({}, { message: '开始日期格式不正确' })
  start_date?: string;

  @IsOptional()
  @IsDateString({}, { message: '结束日期格式不正确' })
  end_date?: string;

  @IsOptional()
  @IsEnum(['in', 'out', 'adjust'], { message: '变更类型不正确' })
  change_type?: 'in' | 'out' | 'adjust';

  @IsOptional()
  @IsMongoId({ message: '操作人ID格式不正确' })
  operator?: string;

  @IsOptional()
  @IsString({ message: '批次ID必须是字符串' })
  @MaxLength(50, { message: '批次ID不能超过50个字符' })
  batch_id?: string;
}
```

#### 2.6 批量库存操作DTO验证规则
```typescript
export class BatchStockOperationDto {
  @IsEnum(['in', 'out', 'adjust'], { message: '操作类型不正确' })
  operation_type: 'in' | 'out' | 'adjust';

  @IsOptional()
  @IsString({ message: '批次ID必须是字符串' })
  @MaxLength(50, { message: '批次ID不能超过50个字符' })
  @Matches(/^[a-zA-Z0-9_]+$/, { message: '批次ID只能包含字母、数字和下划线' })
  batch_id?: string;

  @IsArray({ message: '操作列表必须是数组' })
  @ValidateNested({ each: true })
  @Type(() => BatchOperationItemDto)
  @ArrayMinSize(1, { message: '操作列表不能为空' })
  @ArrayMaxSize(1000, { message: '单次批量操作不能超过1000条' })
  operations: BatchOperationItemDto[];

  @IsOptional()
  @IsString({ message: '操作备注必须是字符串' })
  @MaxLength(500, { message: '操作备注不能超过500个字符' })
  operator_notes?: string;
}

export class BatchOperationItemDto {
  @IsMongoId({ message: '材料ID格式不正确' })
  material_id: string;

  @IsNumber({}, { message: '数量必须是数字' })
  @IsInt({ message: '数量必须是整数' })
  @Min(1, { message: '数量不能小于1' })
  @Max(999999, { message: '数量不能大于999999' })
  @Type(() => Number)
  quantity: number;

  @IsOptional()
  @IsString({ message: '原因必须是字符串' })
  @MaxLength(200, { message: '原因不能超过200个字符' })
  reason?: string;
}
```

### 任务3: 实现库存服务 (预估时间: 6小时)

#### 3.1 库存操作服务
**文件**: `src/modules/bead-material/inventory/inventory.service.ts`

**需要实现的方法**:

**入库操作**:
- `stockIn(stockInDto, userId)` - 处理入库操作
- 验证材料是否存在
- 更新材料库存数量
- 记录库存变更历史
- 更新库存状态

**出库操作**:
- `stockOut(stockOutDto, userId)` - 处理出库操作
- 验证材料是否存在
- 验证库存是否充足
- 更新材料库存数量
- 记录库存变更历史
- 更新库存状态

**库存调整**:
- `adjustStock(adjustDto, userId)` - 处理库存调整
- 验证材料是否存在
- 计算调整数量
- 更新材料库存数量
- 记录库存变更历史
- 更新库存状态

**库存历史查询**:
- `getInventoryHistory(queryDto)` - 获取库存变更记录
- 支持按材料筛选
- 支持按时间范围筛选
- 支持按变更类型筛选
- 支持分页查询

**库存统计**:
- `getInventoryStats(materialId)` - 获取材料库存统计
- 当前库存数量
- 近期出入库统计
- 库存变化趋势

### 任务4: 实现库存控制器 (预估时间: 3小时)

#### 4.1 库存操作控制器
**文件**: `src/modules/bead-material/inventory/inventory.controller.ts`

**API端点**:

**入库接口**:
- `POST /api/bead-material/inventory/stock-in`
- 接收入库参数
- 调用入库服务
- 返回操作结果

**出库接口**:
- `POST /api/bead-material/inventory/stock-out`
- 接收出库参数
- 调用出库服务
- 返回操作结果

**库存调整接口**:
- `POST /api/bead-material/inventory/adjust`
- 接收调整参数
- 调用调整服务
- 返回操作结果

**库存历史接口**:
- `POST /api/bead-material/inventory/history`
- 接收查询参数
- 调用历史查询服务
- 返回分页结果

**库存统计接口**:
- `POST /api/bead-material/inventory/stats`
- 接收材料ID
- 调用统计服务
- 返回统计数据

### 任务5: 实现库存预警机制 (预估时间: 4小时)

#### 5.1 预警服务
**文件**: `src/modules/bead-material/inventory/alert.service.ts`

**预警功能**:
- `checkLowStockAlerts()` - 检查低库存预警
- `checkOutOfStockAlerts()` - 检查缺货预警
- `generateAlertReport()` - 生成预警报告
- `sendAlertNotifications()` - 发送预警通知

**预警级别**:
- normal - 正常库存
- warning - 低库存预警
- critical - 严重缺货

**预警规则**:
- 当库存数量 <= 最低库存预警值时触发warning
- 当库存数量 = 0时触发critical
- 支持自定义预警阈值

#### 5.2 预警数据模型
**文件**: `src/modules/bead-material/inventory/schemas/stock-alert.schema.ts`

**字段结构**:
```typescript
StockAlert {
  _id: ObjectId
  material_id: ObjectId          // 材料ID
  alert_level: 'warning' | 'critical'  // 预警级别
  current_quantity: number       // 当前库存
  min_stock_level: number        // 最低库存预警值
  alert_message: string          // 预警消息
  is_resolved: boolean           // 是否已解决
  created_at: Date               // 创建时间
  resolved_at?: Date             // 解决时间
}
```

### 任务6: 批量库存操作 (预估时间: 3小时)

#### 6.1 批量操作服务
**文件**: `src/modules/bead-material/inventory/batch-inventory.service.ts`

**批量操作功能**:
- `batchStockIn(batchData, userId)` - 批量入库
- `batchStockOut(batchData, userId)` - 批量出库
- `batchStockAdjust(batchData, userId)` - 批量调整

**批量操作参数**:
```typescript
BatchStockOperation {
  batch_id: string               // 批次ID
  operations: Array<{
    material_id: string
    quantity: number
    reason?: string
  }>
  operator_notes?: string        // 操作备注
}
```

**批量操作结果**:
```typescript
BatchOperationResult {
  batch_id: string
  total_count: number
  success_count: number
  failed_count: number
  failed_items: Array<{
    material_id: string
    error_message: string
  }>
}
```

### 任务7: 库存报表功能 (预估时间: 4小时)

#### 7.1 报表服务
**文件**: `src/modules/bead-material/reports/inventory-report.service.ts`

**报表功能**:
- `generateStockValueReport(dateRange)` - 库存价值报表
- `generateInOutDetailReport(dateRange)` - 出入库明细报表
- `generateLowStockReport()` - 低库存报表
- `generateInventoryTrendReport(dateRange)` - 库存趋势报表

**报表数据结构**:
```typescript
StockValueReport {
  report_date: string
  total_materials: number
  total_stock_value: number
  category_breakdown: Array<{
    category_name: string
    material_count: number
    stock_value: number
  }>
}

InOutDetailReport {
  date_range: { start: string, end: string }
  total_in_quantity: number
  total_out_quantity: number
  net_change: number
  details: Array<{
    material_name: string
    in_quantity: number
    out_quantity: number
    net_change: number
  }>
}
```

### 任务8: 库存数据同步 (预估时间: 2小时)

#### 8.1 数据同步服务
**文件**: `src/modules/bead-material/inventory/sync.service.ts`

**同步功能**:
- `syncMaterialStockStatus()` - 同步材料库存状态
- `recalculateStockQuantities()` - 重新计算库存数量
- `validateInventoryData()` - 验证库存数据一致性

**数据一致性检查**:
- 检查库存记录与材料库存是否一致
- 检查库存状态是否正确
- 修复数据不一致问题

### 任务9: 单元测试 (预估时间: 5小时)

#### 9.1 库存服务测试
**文件**: `src/modules/bead-material/inventory/inventory.service.spec.ts`

**测试用例**:
- 入库操作测试
- 出库操作测试（正常和库存不足情况）
- 库存调整测试
- 库存历史查询测试
- 库存统计测试

#### 9.2 预警服务测试
**文件**: `src/modules/bead-material/inventory/alert.service.spec.ts`

**测试用例**:
- 低库存预警检查
- 缺货预警检查
- 预警通知发送
- 预警解决处理

#### 9.3 批量操作测试
**文件**: `src/modules/bead-material/inventory/batch-inventory.service.spec.ts`

**测试用例**:
- 批量入库测试
- 批量出库测试
- 批量调整测试
- 部分失败处理测试

### 任务10: 集成测试 (预估时间: 3小时)

#### 10.1 API端点测试
**文件**: `test/inventory.e2e-spec.ts`

**测试场景**:
- 完整的出入库流程测试
- 库存预警触发测试
- 批量操作端到端测试
- 报表生成测试

## 使用的接口规范

### 入库接口
```
POST /api/bead-material/inventory/stock-in
Body: {
  material_id: string
  quantity: number
  reason?: string
}
Response: {
  code: 0,
  message: "入库成功",
  data: {
    material_id: string,
    material_name: string,
    old_quantity: number,
    new_quantity: number,
    change_quantity: number,
    change_type: "in",
    reason: string,
    operator: string,
    created_at: string
  }
}
```

### 出库接口
```
POST /api/bead-material/inventory/stock-out
Body: {
  material_id: string
  quantity: number
  reason?: string
}
Response: {
  code: 0,
  message: "出库成功",
  data: {
    material_id: string,
    material_name: string,
    old_quantity: number,
    new_quantity: number,
    change_quantity: number,
    change_type: "out",
    reason: string,
    operator: string,
    created_at: string
  }
}
```

### 库存调整接口
```
POST /api/bead-material/inventory/adjust
Body: {
  material_id: string
  new_quantity: number
  reason?: string
}
Response: {
  code: 0,
  message: "库存调整成功",
  data: {
    material_id: string,
    material_name: string,
    old_quantity: number,
    new_quantity: number,
    change_quantity: number,
    change_type: "adjust",
    reason: string,
    operator: string,
    created_at: string
  }
}
```

### 库存历史接口
```
POST /api/bead-material/inventory/history
Body: {
  material_id?: string
  page?: number
  page_size?: number
  start_date?: string
  end_date?: string
  change_type?: string
}
Response: {
  code: 0,
  message: "获取成功",
  data: Array<InventoryRecord>,
  pagination: PaginationInfo
}
```

## 验收标准

### 功能验收
1. ✅ 出入库操作正常，库存数量准确更新
2. ✅ 库存调整功能正常
3. ✅ 库存变更记录完整准确
4. ✅ 库存预警机制正常工作
5. ✅ 批量操作功能正常
6. ✅ 库存报表数据准确

### 数据一致性验收
1. ✅ 库存记录与材料库存数据一致
2. ✅ 库存状态计算准确
3. ✅ 并发操作数据安全
4. ✅ 事务处理完整

### 性能验收
1. ✅ 库存操作响应时间 < 300ms
2. ✅ 批量操作支持 > 1000条记录
3. ✅ 报表生成时间合理
4. ✅ 数据库查询优化

## 预估总时间

**总计：33小时**

- 扩展数据模型：2小时
- 创建库存管理DTO：1小时
- 实现库存服务：6小时
- 实现库存控制器：3小时
- 实现库存预警机制：4小时
- 批量库存操作：3小时
- 库存报表功能：4小时
- 库存数据同步：2小时
- 单元测试：5小时
- 集成测试：3小时