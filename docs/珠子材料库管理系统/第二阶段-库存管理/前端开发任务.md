# 第二阶段 - 库存管理前端开发任务

## 任务概述

实现珠子材料库存管理的前端功能，包括出入库操作界面、库存变更记录查看、库存预警展示等功能。

## 项目结构扩展

```
admin-mall/src/
├── views/bead-material/
│   ├── inventory/                        # 库存管理模块
│   │   ├── index.vue                    # 库存管理主页面
│   │   ├── history.vue                  # 库存变更历史页面
│   │   ├── alerts.vue                   # 库存预警页面
│   │   └── components/                  # 库存相关组件
│   │       ├── StockInDialog.vue        # 入库弹窗组件
│   │       ├── StockOutDialog.vue       # 出库弹窗组件
│   │       ├── StockAdjustDialog.vue    # 库存调整弹窗组件
│   │       ├── BatchStockDialog.vue     # 批量库存操作弹窗
│   │       ├── InventoryChart.vue       # 库存图表组件
│   │       ├── AlertCard.vue            # 预警卡片组件
│   │       └── StockHistoryTable.vue    # 库存历史表格组件
│   └── dashboard/                       # 仪表盘模块
│       ├── index.vue                    # 仪表盘主页面
│       └── components/                  # 仪表盘组件
│           ├── StockOverview.vue        # 库存概览组件
│           ├── StockTrend.vue           # 库存趋势图
│           ├── CategoryStats.vue        # 分类统计组件
│           └── RecentActivity.vue       # 最近活动组件
├── api/bead-material/
│   ├── inventory.ts                     # 库存管理接口
│   ├── dashboard.ts                     # 仪表盘接口
│   └── reports.ts                       # 报表接口
└── stores/modules/
    ├── inventory.ts                     # 库存状态管理
    └── dashboard.ts                     # 仪表盘状态管理
```

## 详细开发任务

### 任务1: 扩展API接口层 (预估时间: 3小时)

#### 1.1 库存管理接口
**文件**: `src/api/bead-material/inventory.ts`

**需要实现的接口**:
- `stockInApi()` - 入库操作
- `stockOutApi()` - 出库操作
- `adjustStockApi()` - 库存调整
- `getInventoryHistoryApi()` - 获取库存变更历史
- `batchStockOperationApi()` - 批量库存操作
- `getInventoryStatsApi()` - 获取库存统计

**使用的后端接口**:
- `POST /api/bead-material/inventory/stock-in`
- `POST /api/bead-material/inventory/stock-out`
- `POST /api/bead-material/inventory/adjust`
- `POST /api/bead-material/inventory/history`
- `POST /api/bead-material/inventory/batch`
- `POST /api/bead-material/inventory/stats`

#### 1.2 仪表盘接口
**文件**: `src/api/bead-material/dashboard.ts`

**需要实现的接口**:
- `getDashboardStatsApi()` - 获取仪表盘统计数据
- `getStockAlertsApi()` - 获取库存预警列表
- `getStockTrendApi()` - 获取库存趋势数据
- `getCategoryStatsApi()` - 获取分类统计数据

**使用的后端接口**:
- `POST /api/bead-material/dashboard/stats`
- `POST /api/bead-material/dashboard/alerts`
- `POST /api/bead-material/dashboard/trend`
- `POST /api/bead-material/dashboard/category-stats`

#### 1.3 类型定义扩展
**文件**: `src/api/bead-material/types.ts`

**新增类型定义**:
```typescript
// 库存操作相关
interface StockOperation {
  material_id: string
  quantity: number
  reason?: string
}

interface InventoryRecord {
  _id: string
  material_id: string
  material_name: string
  change_type: 'in' | 'out' | 'adjust'
  quantity: number
  old_quantity: number
  new_quantity: number
  reason?: string
  operator: string
  created_at: string
}

// 库存预警相关
interface StockAlert {
  material_id: string
  material_name: string
  current_quantity: number
  min_stock_level: number
  alert_level: 'warning' | 'critical'
  alert_message: string
  last_alert_time: string
}

// 仪表盘统计相关
interface DashboardStats {
  total_materials: number
  total_categories: number
  total_stock_value: number
  low_stock_materials: number
  out_of_stock_materials: number
  today_in_quantity: number
  today_out_quantity: number
  monthly_in_quantity: number
  monthly_out_quantity: number
}
```

### 任务2: 创建库存状态管理 (预估时间: 2小时)

#### 2.1 库存Store
**文件**: `src/stores/modules/inventory.ts`

**状态管理内容**:
- 库存操作记录列表
- 库存预警列表
- 当前选中的材料库存信息
- 批量操作状态
- 加载状态管理

**需要实现的方法**:
- `stockIn()` - 入库操作
- `stockOut()` - 出库操作
- `adjustStock()` - 库存调整
- `fetchInventoryHistory()` - 获取库存历史
- `fetchStockAlerts()` - 获取库存预警
- `batchStockOperation()` - 批量库存操作
- `getInventoryStats()` - 获取库存统计

#### 2.2 仪表盘Store
**文件**: `src/stores/modules/dashboard.ts`

**状态管理内容**:
- 仪表盘统计数据
- 库存趋势数据
- 分类统计数据
- 最近活动记录

**需要实现的方法**:
- `fetchDashboardStats()` - 获取仪表盘数据
- `fetchStockTrend()` - 获取库存趋势
- `fetchCategoryStats()` - 获取分类统计
- `refreshDashboard()` - 刷新仪表盘数据

### 任务3: 扩展路由配置 (预估时间: 1小时)

#### 3.1 新增路由
**文件**: `src/router/modules/beadMaterial.ts`

**新增路由**:
- `/bead-material/dashboard` - 仪表盘页面
- `/bead-material/inventory` - 库存管理页面
- `/bead-material/inventory/history` - 库存历史页面
- `/bead-material/inventory/alerts` - 库存预警页面

### 任务4: 创建仪表盘页面 (预估时间: 6小时)

#### 4.1 仪表盘主页面
**文件**: `src/views/bead-material/dashboard/index.vue`

**页面功能**:
- 关键指标卡片展示
- 库存趋势图表
- 分类分布图表
- 库存预警列表
- 最近活动记录

**关键指标卡片**:
- 材料总数
- 分类总数
- 库存总价值
- 低库存材料数量
- 缺货材料数量
- 今日出入库数量

**使用的接口**:
- 获取仪表盘统计数据
- 获取库存预警列表
- 获取库存趋势数据

#### 4.2 库存概览组件
**文件**: `src/views/bead-material/dashboard/components/StockOverview.vue`

**组件功能**:
- 库存总览卡片
- 库存状态分布
- 库存价值统计
- 快速操作入口

#### 4.3 库存趋势图组件
**文件**: `src/views/bead-material/dashboard/components/StockTrend.vue`

**组件功能**:
- 库存变化趋势图（ECharts）
- 时间范围选择
- 出入库对比图表
- 数据导出功能

**图表类型**:
- 折线图：库存数量趋势
- 柱状图：出入库对比
- 面积图：库存价值变化

#### 4.4 分类统计组件
**文件**: `src/views/bead-material/dashboard/components/CategoryStats.vue`

**组件功能**:
- 分类材料数量统计
- 分类库存价值统计
- 饼图展示分类分布
- 分类详情跳转

### 任务5: 创建库存管理页面 (预估时间: 8小时)

#### 5.1 库存管理主页面
**文件**: `src/views/bead-material/inventory/index.vue`

**页面功能**:
- 材料库存列表展示
- 库存操作按钮（入库、出库、调整）
- 批量库存操作
- 库存搜索和筛选
- 库存状态标签显示

**表格字段**:
- 材料名称
- 分类名称
- 当前库存数量
- 最低库存预警值
- 库存状态（正常/低库存/缺货）
- 最后更新时间
- 操作按钮

**筛选条件**:
- 分类筛选
- 库存状态筛选
- 关键词搜索

**使用的接口**:
- 获取材料列表（包含库存信息）
- 库存操作接口

#### 5.2 入库弹窗组件
**文件**: `src/views/bead-material/inventory/components/StockInDialog.vue`

**组件功能**:
- 材料选择（下拉搜索）
- 入库数量输入
- 入库原因输入
- 表单验证
- 提交处理

**表单字段及验证规则**:

| 字段 | 类型 | 必填 | 验证规则 | Element Plus验证规则 |
|------|------|------|----------|---------------------|
| material_id | String | 是 | 有效的ObjectId | `[{ required: true, message: '请选择材料', trigger: 'change' }, { validator: validateObjectId, trigger: 'change' }]` |
| quantity | Number | 是 | 正整数，1-999999 | `[{ required: true, message: '请输入入库数量', trigger: 'blur' }, { type: 'integer', min: 1, max: 999999, message: '入库数量必须是1-999999的整数', trigger: 'blur' }]` |
| reason | String | 否 | 最大200字符 | `[{ max: 200, message: '入库原因不能超过200个字符', trigger: 'blur' }]` |

**自定义验证函数**:
```typescript
// ObjectId格式验证
const validateObjectId = (rule: any, value: any, callback: any) => {
  if (!value || !/^[0-9a-fA-F]{24}$/.test(value)) {
    callback(new Error('材料ID格式不正确'));
  } else {
    callback();
  }
};
```

**使用的接口**:
- 入库操作接口

#### 5.3 出库弹窗组件
**文件**: `src/views/bead-material/inventory/components/StockOutDialog.vue`

**组件功能**:
- 材料选择（下拉搜索）
- 当前库存显示
- 出库数量输入（不能超过当前库存）
- 出库原因输入
- 表单验证

**表单字段及验证规则**:

| 字段 | 类型 | 必填 | 验证规则 | Element Plus验证规则 |
|------|------|------|----------|---------------------|
| material_id | String | 是 | 有效的ObjectId | `[{ required: true, message: '请选择材料', trigger: 'change' }, { validator: validateObjectId, trigger: 'change' }]` |
| quantity | Number | 是 | 正整数，不超过当前库存 | `[{ required: true, message: '请输入出库数量', trigger: 'blur' }, { type: 'integer', min: 1, message: '出库数量必须是正整数', trigger: 'blur' }, { validator: validateStockQuantity, trigger: 'blur' }]` |
| reason | String | 否 | 最大200字符 | `[{ max: 200, message: '出库原因不能超过200个字符', trigger: 'blur' }]` |

**自定义验证函数**:
```typescript
// 库存数量验证
const validateStockQuantity = (rule: any, value: any, callback: any) => {
  const currentStock = formData.current_stock || 0;
  if (value && value > currentStock) {
    callback(new Error(`出库数量不能超过当前库存${currentStock}`));
  } else {
    callback();
  }
};
```

**使用的接口**:
- 出库操作接口
- 获取材料库存信息

#### 5.4 库存调整弹窗组件
**文件**: `src/views/bead-material/inventory/components/StockAdjustDialog.vue`

**组件功能**:
- 材料选择
- 当前库存显示
- 新库存数量输入
- 调整原因输入
- 调整数量自动计算显示

**表单字段及验证规则**:

| 字段 | 类型 | 必填 | 验证规则 | Element Plus验证规则 |
|------|------|------|----------|---------------------|
| material_id | String | 是 | 有效的ObjectId | `[{ required: true, message: '请选择材料', trigger: 'change' }, { validator: validateObjectId, trigger: 'change' }]` |
| new_quantity | Number | 是 | 非负整数，0-999999 | `[{ required: true, message: '请输入新库存数量', trigger: 'blur' }, { type: 'integer', min: 0, max: 999999, message: '库存数量必须是0-999999的整数', trigger: 'blur' }]` |
| reason | String | 否 | 最大200字符 | `[{ max: 200, message: '调整原因不能超过200个字符', trigger: 'blur' }]` |

**计算字段**:
- `adjustment_quantity` - 调整数量（自动计算：new_quantity - current_quantity）
- `adjustment_type` - 调整类型（自动判断：增加/减少/无变化）

**使用的接口**:
- 库存调整接口

#### 5.5 批量库存操作弹窗
**文件**: `src/views/bead-material/inventory/components/BatchStockDialog.vue`

**组件功能**:
- 批量材料选择
- 操作类型选择（入库/出库/调整）
- 批量数据输入（表格形式）
- 操作进度显示
- 结果统计显示

**批量操作字段及验证规则**:

| 字段 | 类型 | 必填 | 验证规则 | Element Plus验证规则 |
|------|------|------|----------|---------------------|
| operation_type | String | 是 | 枚举值：in/out/adjust | `[{ required: true, message: '请选择操作类型', trigger: 'change' }, { validator: validateOperationType, trigger: 'change' }]` |
| batch_id | String | 否 | 最大50字符，字母数字下划线 | `[{ max: 50, message: '批次ID不能超过50个字符', trigger: 'blur' }, { pattern: /^[a-zA-Z0-9_]+$/, message: '批次ID只能包含字母、数字和下划线', trigger: 'blur' }]` |
| operator_notes | String | 否 | 最大500字符 | `[{ max: 500, message: '操作备注不能超过500个字符', trigger: 'blur' }]` |

**批量操作项验证规则**:

| 字段 | 类型 | 必填 | 验证规则 | 表格内验证规则 |
|------|------|------|----------|----------------|
| material_id | String | 是 | 有效的ObjectId | 下拉选择验证 |
| quantity | Number | 是 | 正整数，1-999999 | 数字输入验证 |
| reason | String | 否 | 最大200字符 | 文本输入验证 |

**自定义验证函数**:
```typescript
// 操作类型验证
const validateOperationType = (rule: any, value: any, callback: any) => {
  const validTypes = ['in', 'out', 'adjust'];
  if (!validTypes.includes(value)) {
    callback(new Error('操作类型不正确'));
  } else {
    callback();
  }
};

// 批量数据验证
const validateBatchData = (batchItems: any[]) => {
  const errors: string[] = [];
  batchItems.forEach((item, index) => {
    if (!item.material_id) {
      errors.push(`第${index + 1}行：请选择材料`);
    }
    if (!item.quantity || item.quantity <= 0) {
      errors.push(`第${index + 1}行：请输入有效的数量`);
    }
  });
  return errors;
};
```

**使用的接口**:
- 批量库存操作接口

### 任务6: 创建库存历史页面 (预估时间: 4小时)

#### 6.1 库存历史主页面
**文件**: `src/views/bead-material/inventory/history.vue`

**页面功能**:
- 库存变更记录列表
- 高级筛选功能
- 记录详情查看
- 数据导出功能

**表格字段**:
- 材料名称
- 操作类型（入库/出库/调整）
- 变更数量
- 变更前库存
- 变更后库存
- 操作原因
- 操作人
- 操作时间

**筛选条件**:
- 材料筛选
- 操作类型筛选
- 时间范围筛选
- 操作人筛选

**使用的接口**:
- 获取库存变更历史

#### 6.2 库存历史表格组件
**文件**: `src/views/bead-material/inventory/components/StockHistoryTable.vue`

**组件功能**:
- 历史记录表格展示
- 分页功能
- 排序功能
- 记录详情弹窗

### 任务7: 创建库存预警页面 (预估时间: 4小时)

#### 7.1 库存预警主页面
**文件**: `src/views/bead-material/inventory/alerts.vue`

**页面功能**:
- 预警列表展示
- 预警级别筛选
- 预警处理操作
- 预警统计信息

**预警列表字段**:
- 材料名称
- 当前库存
- 最低库存预警值
- 预警级别（警告/严重）
- 预警消息
- 最后预警时间
- 处理操作

**预警级别**:
- warning - 低库存预警（橙色标签）
- critical - 严重缺货（红色标签）

**使用的接口**:
- 获取库存预警列表
- 处理预警（标记已解决）

#### 7.2 预警卡片组件
**文件**: `src/views/bead-material/inventory/components/AlertCard.vue`

**组件功能**:
- 预警信息卡片展示
- 预警级别颜色区分
- 快速处理按钮
- 材料详情跳转

### 任务8: 创建库存图表组件 (预估时间: 3小时)

#### 8.1 库存图表组件
**文件**: `src/views/bead-material/inventory/components/InventoryChart.vue`

**组件功能**:
- 库存趋势图表（ECharts）
- 出入库对比图表
- 库存分布图表
- 图表交互功能

**图表类型**:
- 折线图：库存数量变化趋势
- 柱状图：每日出入库对比
- 饼图：库存状态分布
- 雷达图：分类库存对比

### 任务9: 优化现有页面 (预估时间: 3小时)

#### 9.1 材料管理页面优化
**文件**: `src/views/bead-material/materials/index.vue`

**新增功能**:
- 库存信息显示
- 库存状态标签
- 快速库存操作按钮
- 库存预警提示

#### 9.2 材料详情页面优化
**文件**: `src/views/bead-material/materials/detail.vue`

**新增功能**:
- 库存信息详细展示
- 库存变更历史
- 库存操作按钮
- 库存统计图表

## Mock数据字段

### 库存操作记录Mock数据
```json
{
  "_id": "507f1f77bcf86cd799439013",
  "material_id": "507f1f77bcf86cd799439012",
  "material_name": "白水晶",
  "change_type": "in",
  "quantity": 100,
  "old_quantity": 50,
  "new_quantity": 150,
  "reason": "采购入库",
  "operator": "admin",
  "batch_id": "BATCH_20240101_001",
  "created_at": "2024-01-01T10:00:00.000Z"
}
```

### 库存预警Mock数据
```json
{
  "material_id": "507f1f77bcf86cd799439012",
  "material_name": "白水晶",
  "current_quantity": 8,
  "min_stock_level": 10,
  "alert_level": "warning",
  "alert_message": "库存低于预警水平",
  "last_alert_time": "2024-01-01T15:00:00.000Z"
}
```

### 仪表盘统计Mock数据
```json
{
  "total_materials": 150,
  "total_categories": 20,
  "total_stock_value": 125000.50,
  "low_stock_materials": 15,
  "out_of_stock_materials": 5,
  "today_in_quantity": 200,
  "today_out_quantity": 150,
  "monthly_in_quantity": 5000,
  "monthly_out_quantity": 4500,
  "stock_value_trend": [
    {"date": "2024-01-01", "value": 120000},
    {"date": "2024-01-02", "value": 121500},
    {"date": "2024-01-03", "value": 123000}
  ],
  "category_distribution": [
    {"category_id": "1", "category_name": "水晶类", "material_count": 25, "percentage": 16.67},
    {"category_id": "2", "category_name": "玛瑙类", "material_count": 20, "percentage": 13.33}
  ]
}
```

## 验收标准

### 功能验收
1. ✅ 库存出入库操作界面完整
2. ✅ 库存调整功能正常
3. ✅ 批量库存操作功能正常
4. ✅ 库存历史记录查看功能完整
5. ✅ 库存预警展示和处理功能正常
6. ✅ 仪表盘数据展示完整
7. ✅ 图表展示美观且交互良好

### 界面验收
1. ✅ 库存状态标签颜色区分明确
2. ✅ 操作流程简洁明了
3. ✅ 数据展示清晰易读
4. ✅ 图表样式统一美观
5. ✅ 响应式适配良好

### 用户体验验收
1. ✅ 操作反馈及时准确
2. ✅ 错误提示友好明确
3. ✅ 加载状态提示完整
4. ✅ 数据刷新及时
5. ✅ 快捷操作便利

## 预估总时间

**总计：34小时**

- 扩展API接口层：3小时
- 创建库存状态管理：2小时
- 扩展路由配置：1小时
- 创建仪表盘页面：6小时
- 创建库存管理页面：8小时
- 创建库存历史页面：4小时
- 创建库存预警页面：4小时
- 创建库存图表组件：3小时
- 优化现有页面：3小时

## 开发注意事项

1. **数据实时性**: 库存数据要及时更新，操作后立即刷新相关数据
2. **操作安全性**: 出库操作要验证库存充足，防止负库存
3. **用户体验**: 批量操作要有进度提示，大数据量要分页处理
4. **图表性能**: 大量数据的图表要做性能优化，支持数据采样
5. **预警及时性**: 库存预警要醒目显示，支持实时更新
6. **操作记录**: 所有库存操作都要有详细的操作记录
7. **权限控制**: 不同角色的库存操作权限要做好控制