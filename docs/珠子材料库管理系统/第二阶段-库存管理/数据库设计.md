# 第二阶段 - 库存管理数据库设计

## MongoDB 集合设计

### 1. 库存变更记录集合 (inventory_records)

```typescript
interface InventoryRecord {
  _id: ObjectId;                    // 记录ID
  material_id: ObjectId;            // 材料ID (引用bead_materials)
  material_name: string;            // 材料名称 (冗余字段，便于查询)
  change_type: 'in' | 'out' | 'adjust';  // 变更类型：入库/出库/调整
  quantity_before: number;          // 变更前数量
  quantity_change: number;          // 变更数量 (正数为增加，负数为减少)
  quantity_after: number;           // 变更后数量
  reason: string;                   // 变更原因
  batch_id?: string;                // 批次ID (批量操作时使用)
  operator: ObjectId;               // 操作人ID
  operator_name: string;            // 操作人姓名 (冗余字段)
  operation_time: Date;             // 操作时间
  created_at: Date;                 // 创建时间
  updated_at: Date;                 // 更新时间
}
```

#### 1.1 字段验证规则

**material_id (材料ID)**
```javascript
material_id: {
  type: mongoose.Schema.Types.ObjectId,
  ref: 'BeadMaterial',
  required: [true, '材料ID不能为空'],
  validate: {
    validator: mongoose.Types.ObjectId.isValid,
    message: '材料ID格式不正确'
  },
  index: true
}
```

**material_name (材料名称)**
```javascript
material_name: {
  type: String,
  required: [true, '材料名称不能为空'],
  trim: true,
  maxlength: [100, '材料名称不能超过100个字符'],
  index: true
}
```

**change_type (变更类型)**
```javascript
change_type: {
  type: String,
  required: [true, '变更类型不能为空'],
  enum: {
    values: ['in', 'out', 'adjust'],
    message: '变更类型必须是 in、out 或 adjust'
  },
  index: true
}
```

**quantity_before (变更前数量)**
```javascript
quantity_before: {
  type: Number,
  required: [true, '变更前数量不能为空'],
  min: [0, '变更前数量不能小于0'],
  max: [999999, '变更前数量不能大于999999'],
  validate: {
    validator: Number.isInteger,
    message: '变更前数量必须是整数'
  }
}
```

**quantity_change (变更数量)**
```javascript
quantity_change: {
  type: Number,
  required: [true, '变更数量不能为空'],
  min: [-999999, '变更数量不能小于-999999'],
  max: [999999, '变更数量不能大于999999'],
  validate: {
    validator: function(value) {
      return Number.isInteger(value) && value !== 0;
    },
    message: '变更数量必须是非零整数'
  }
}
```

**quantity_after (变更后数量)**
```javascript
quantity_after: {
  type: Number,
  required: [true, '变更后数量不能为空'],
  min: [0, '变更后数量不能小于0'],
  max: [999999, '变更后数量不能大于999999'],
  validate: {
    validator: Number.isInteger,
    message: '变更后数量必须是整数'
  }
}
```

**reason (变更原因)**
```javascript
reason: {
  type: String,
  trim: true,
  maxlength: [200, '变更原因不能超过200个字符'],
  default: ''
}
```

**batch_id (批次ID)**
```javascript
batch_id: {
  type: String,
  trim: true,
  maxlength: [50, '批次ID不能超过50个字符'],
  match: [/^[a-zA-Z0-9_]*$/, '批次ID只能包含字母、数字和下划线'],
  index: true,
  sparse: true
}
```

**operator (操作人ID)**
```javascript
operator: {
  type: mongoose.Schema.Types.ObjectId,
  ref: 'User',
  required: [true, '操作人ID不能为空'],
  validate: {
    validator: mongoose.Types.ObjectId.isValid,
    message: '操作人ID格式不正确'
  },
  index: true
}
```

**operator_name (操作人姓名)**
```javascript
operator_name: {
  type: String,
  required: [true, '操作人姓名不能为空'],
  trim: true,
  maxlength: [50, '操作人姓名不能超过50个字符']
}
```

**operation_time (操作时间)**
```javascript
operation_time: {
  type: Date,
  required: [true, '操作时间不能为空'],
  default: Date.now,
  index: true
}
```

#### 1.2 索引设计

```javascript
// 复合索引
inventoryRecordSchema.index({ material_id: 1, operation_time: -1 });
inventoryRecordSchema.index({ change_type: 1, operation_time: -1 });
inventoryRecordSchema.index({ operator: 1, operation_time: -1 });
inventoryRecordSchema.index({ batch_id: 1, operation_time: -1 }, { sparse: true });

// 文本索引 (支持材料名称搜索)
inventoryRecordSchema.index({ material_name: 'text', reason: 'text' });
```

### 2. 库存预警配置集合 (stock_alerts)

```typescript
interface StockAlert {
  _id: ObjectId;                    // 预警ID
  material_id: ObjectId;            // 材料ID
  material_name: string;            // 材料名称
  alert_type: 'low_stock' | 'out_of_stock' | 'overstock';  // 预警类型
  threshold_value: number;          // 阈值
  current_stock: number;            // 当前库存
  alert_level: 'info' | 'warning' | 'danger';  // 预警级别
  is_active: boolean;               // 是否启用
  last_alert_time?: Date;           // 最后预警时间
  alert_count: number;              // 预警次数
  created_at: Date;                 // 创建时间
  updated_at: Date;                 // 更新时间
}
```

#### 2.1 字段验证规则

**alert_type (预警类型)**
```javascript
alert_type: {
  type: String,
  required: [true, '预警类型不能为空'],
  enum: {
    values: ['low_stock', 'out_of_stock', 'overstock'],
    message: '预警类型必须是 low_stock、out_of_stock 或 overstock'
  },
  index: true
}
```

**threshold_value (阈值)**
```javascript
threshold_value: {
  type: Number,
  required: [true, '阈值不能为空'],
  min: [0, '阈值不能小于0'],
  max: [999999, '阈值不能大于999999'],
  validate: {
    validator: Number.isInteger,
    message: '阈值必须是整数'
  }
}
```

**alert_level (预警级别)**
```javascript
alert_level: {
  type: String,
  required: [true, '预警级别不能为空'],
  enum: {
    values: ['info', 'warning', 'danger'],
    message: '预警级别必须是 info、warning 或 danger'
  },
  default: 'warning'
}
```

### 3. 库存盘点记录集合 (stock_checks)

```typescript
interface StockCheck {
  _id: ObjectId;                    // 盘点ID
  check_no: string;                 // 盘点单号
  check_date: Date;                 // 盘点日期
  check_type: 'full' | 'partial' | 'cycle';  // 盘点类型：全盘/部分/循环
  status: 'draft' | 'checking' | 'completed' | 'cancelled';  // 状态
  materials: StockCheckItem[];      // 盘点材料列表
  total_materials: number;          // 盘点材料总数
  discrepancy_count: number;        // 差异数量
  checker: ObjectId;                // 盘点人ID
  checker_name: string;             // 盘点人姓名
  approver?: ObjectId;              // 审核人ID
  approver_name?: string;           // 审核人姓名
  check_notes?: string;             // 盘点备注
  created_at: Date;                 // 创建时间
  updated_at: Date;                 // 更新时间
}

interface StockCheckItem {
  material_id: ObjectId;            // 材料ID
  material_name: string;            // 材料名称
  system_quantity: number;          // 系统数量
  actual_quantity: number;          // 实际数量
  difference: number;               // 差异数量
  difference_reason?: string;       // 差异原因
  is_adjusted: boolean;             // 是否已调整
}
```

#### 3.1 字段验证规则

**check_no (盘点单号)**
```javascript
check_no: {
  type: String,
  required: [true, '盘点单号不能为空'],
  unique: true,
  trim: true,
  maxlength: [50, '盘点单号不能超过50个字符'],
  match: [/^[A-Z0-9]+$/, '盘点单号只能包含大写字母和数字'],
  index: true
}
```

**check_type (盘点类型)**
```javascript
check_type: {
  type: String,
  required: [true, '盘点类型不能为空'],
  enum: {
    values: ['full', 'partial', 'cycle'],
    message: '盘点类型必须是 full、partial 或 cycle'
  }
}
```

**status (状态)**
```javascript
status: {
  type: String,
  required: [true, '状态不能为空'],
  enum: {
    values: ['draft', 'checking', 'completed', 'cancelled'],
    message: '状态必须是 draft、checking、completed 或 cancelled'
  },
  default: 'draft',
  index: true
}
```

## 数据关系设计

### 1. 外键关系
- `inventory_records.material_id` → `bead_materials._id`
- `inventory_records.operator` → `users._id`
- `stock_alerts.material_id` → `bead_materials._id`
- `stock_checks.checker` → `users._id`
- `stock_checks.approver` → `users._id`

### 2. 触发器逻辑
- 材料库存变更时，自动创建库存变更记录
- 库存变更后，检查预警条件并更新预警状态
- 盘点完成后，根据差异自动调整库存

### 3. 数据一致性保证
- 使用事务确保库存变更和记录创建的原子性
- 定期校验库存数量与变更记录的一致性
- 实现乐观锁防止并发库存操作冲突