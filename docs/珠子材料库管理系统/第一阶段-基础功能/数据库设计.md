# 第一阶段 - 数据库设计文档

## MongoDB 集合设计

### 1. 分类集合 (bead_categories)

```typescript
interface BeadCategory {
  _id: ObjectId;
  name: string;                    // 分类名称
  parent_id: ObjectId | null;      // 父级分类ID，null表示顶级分类
  description?: string;            // 分类描述
  sort_order: number;              // 排序顺序，默认0
  material_count: number;          // 该分类下的材料数量，默认0
  is_active: boolean;              // 是否启用，默认true
  created_at: Date;                // 创建时间
  updated_at: Date;                // 更新时间
  created_by: ObjectId;            // 创建人ID
  updated_by: ObjectId;            // 更新人ID
}
```

**字段验证规则：**

| 字段 | 类型 | 必填 | 验证规则 | 错误提示 |
|------|------|------|----------|----------|
| name | String | 是 | 长度1-100字符，支持中文、英文、数字、空格、连字符、下划线、括号 | 分类名称长度在1到100个字符，格式不正确 |
| parent_id | ObjectId | 否 | 有效的ObjectId或null | 父级分类ID格式不正确 |
| description | String | 否 | 最大500字符 | 描述长度不能超过500个字符 |
| sort_order | Number | 否 | 0-9999的整数 | 排序顺序必须在0-9999之间的整数 |
| material_count | Number | 否 | 非负整数，系统自动计算 | 材料数量必须是非负整数 |
| is_active | Boolean | 否 | 布尔值，默认true | 启用状态必须是布尔值 |
| created_by | ObjectId | 是 | 有效的ObjectId | 创建人ID格式不正确 |
| updated_by | ObjectId | 是 | 有效的ObjectId | 更新人ID格式不正确 |

**索引设计：**
```javascript
// 复合索引：父级分类 + 排序
db.bead_categories.createIndex({ "parent_id": 1, "sort_order": 1 })

// 单字段索引：名称（支持搜索）
db.bead_categories.createIndex({ "name": 1 })

// 单字段索引：是否启用
db.bead_categories.createIndex({ "is_active": 1 })
```

### 2. 材料集合 (bead_materials)

```typescript
interface BeadMaterial {
  _id: ObjectId;
  name: string;                    // 材料名称
  category_id: ObjectId;           // 分类ID
  image_url?: string;              // 图片URL
  size: number;                    // 默认尺寸(mm)，默认12.0
  price: number;                   // 单价，默认0
  stock_quantity: number;          // 当前库存数量，默认0
  min_stock_level: number;         // 最低库存预警值，默认10
  stock_status: 'normal' | 'low' | 'out'; // 库存状态
  description?: string;            // 材料描述
  properties: {                    // 材料属性（JSON对象）
    color?: string;                // 颜色
    hardness?: number;             // 硬度
    density?: number;              // 密度
    transparency?: string;         // 透明度
    origin?: string;               // 产地
    [key: string]: any;            // 其他自定义属性
  };
  is_active: boolean;              // 是否启用，默认true
  created_at: Date;                // 创建时间
  updated_at: Date;                // 更新时间
  created_by: ObjectId;            // 创建人ID
  updated_by: ObjectId;            // 更新人ID
}
```

**字段验证规则：**

| 字段 | 类型 | 必填 | 验证规则 | 错误提示 |
|------|------|------|----------|----------|
| name | String | 是 | 长度1-100字符，支持中文、英文、数字、空格、连字符、下划线、括号、点号 | 材料名称长度在1到100个字符，格式不正确 |
| category_id | ObjectId | 是 | 有效的ObjectId，必须存在于分类集合中 | 分类ID格式不正确或分类不存在 |
| image_url | String | 否 | 有效的URL，最大500字符，支持jpg/png/gif/webp格式 | 图片URL格式不正确或格式不支持 |
| size | Number | 否 | 0.1-1000的数字，最多2位小数 | 尺寸必须在0.1-1000mm之间 |
| price | Number | 否 | 0-999999.99的数字，最多2位小数 | 价格必须在0-999999.99之间 |
| stock_quantity | Number | 否 | 非负整数 | 库存数量必须是非负整数 |
| min_stock_level | Number | 否 | 非负整数 | 最低库存预警值必须是非负整数 |
| stock_status | String | 否 | 枚举值：normal/low/out，系统自动计算 | 库存状态值不正确 |
| description | String | 否 | 最大1000字符 | 描述长度不能超过1000个字符 |
| properties | Object | 否 | JSON对象，键值对形式 | 材料属性格式不正确 |
| properties.color | String | 否 | 最大50字符 | 颜色名称不能超过50个字符 |
| properties.hardness | Number | 否 | 1-10的数字 | 硬度必须在1-10之间 |
| properties.density | Number | 否 | 0.1-50的数字 | 密度必须在0.1-50之间 |
| properties.transparency | String | 否 | 枚举值：透明/半透明/不透明 | 透明度值不正确 |
| properties.origin | String | 否 | 最大100字符 | 产地名称不能超过100个字符 |
| is_active | Boolean | 否 | 布尔值，默认true | 启用状态必须是布尔值 |
| created_by | ObjectId | 是 | 有效的ObjectId | 创建人ID格式不正确 |
| updated_by | ObjectId | 是 | 有效的ObjectId | 更新人ID格式不正确 |

**索引设计：**
```javascript
// 复合索引：分类 + 状态 + 名称
db.bead_materials.createIndex({ 
  "category_id": 1, 
  "is_active": 1, 
  "name": 1 
})

// 文本索引：支持全文搜索
db.bead_materials.createIndex({ 
  "name": "text", 
  "description": "text" 
})

// 复合索引：库存状态 + 价格
db.bead_materials.createIndex({ 
  "stock_status": 1, 
  "price": 1 
})

// 单字段索引：库存数量
db.bead_materials.createIndex({ "stock_quantity": 1 })
```

### 3. 库存变更记录集合 (inventory_records)

```typescript
interface InventoryRecord {
  _id: ObjectId;
  material_id: ObjectId;           // 材料ID
  change_type: 'in' | 'out' | 'adjust'; // 变更类型：入库/出库/调整
  quantity: number;                // 变更数量（正数为增加，负数为减少）
  old_quantity: number;            // 变更前数量
  new_quantity: number;            // 变更后数量
  reason?: string;                 // 变更原因
  operator: ObjectId;              // 操作人ID
  created_at: Date;                // 创建时间
  batch_id?: string;               // 批次ID（用于批量操作）
}
```

**字段验证规则：**

| 字段 | 类型 | 必填 | 验证规则 | 错误提示 |
|------|------|------|----------|----------|
| material_id | ObjectId | 是 | 有效的ObjectId，必须存在于材料集合中 | 材料ID格式不正确或材料不存在 |
| change_type | String | 是 | 枚举值：in/out/adjust | 变更类型不正确 |
| quantity | Number | 是 | 非零整数，入库为正数，出库为负数 | 变更数量不能为0且必须是整数 |
| old_quantity | Number | 是 | 非负整数 | 变更前数量必须是非负整数 |
| new_quantity | Number | 是 | 非负整数 | 变更后数量必须是非负整数 |
| reason | String | 否 | 最大200字符 | 变更原因不能超过200个字符 |
| operator | ObjectId | 是 | 有效的ObjectId | 操作人ID格式不正确 |
| batch_id | String | 否 | 最大50字符，UUID格式 | 批次ID格式不正确 |

**索引设计：**
```javascript
// 复合索引：材料 + 时间
db.inventory_records.createIndex({ 
  "material_id": 1, 
  "created_at": -1 
})

// 复合索引：变更类型 + 时间
db.inventory_records.createIndex({ 
  "change_type": 1, 
  "created_at": -1 
})

// 单字段索引：操作人
db.inventory_records.createIndex({ "operator": 1 })

// 单字段索引：批次ID
db.inventory_records.createIndex({ "batch_id": 1 })
```

### 4. 保存的搜索条件集合 (saved_searches)

```typescript
interface SavedSearch {
  _id: ObjectId;
  name: string;                    // 搜索条件名称
  search_params: {                 // 搜索参数
    keyword?: string;
    category_id?: ObjectId;
    min_price?: number;
    max_price?: number;
    stock_status?: string;
    is_active?: boolean;
    [key: string]: any;
  };
  user_id: ObjectId;               // 用户ID
  usage_count: number;             // 使用次数，默认0
  last_used_at?: Date;             // 最后使用时间
  created_at: Date;                // 创建时间
  updated_at: Date;                // 更新时间
}
```

**字段验证规则：**

| 字段 | 类型 | 必填 | 验证规则 | 错误提示 |
|------|------|------|----------|----------|
| name | String | 是 | 长度1-100字符 | 搜索条件名称长度在1到100个字符 |
| search_params | Object | 是 | JSON对象 | 搜索参数格式不正确 |
| search_params.keyword | String | 否 | 最大200字符 | 关键词不能超过200个字符 |
| search_params.category_id | ObjectId | 否 | 有效的ObjectId | 分类ID格式不正确 |
| search_params.min_price | Number | 否 | 非负数字 | 最低价格必须是非负数 |
| search_params.max_price | Number | 否 | 非负数字，且大于等于min_price | 最高价格必须大于等于最低价格 |
| search_params.stock_status | String | 否 | 枚举值：normal/low/out | 库存状态值不正确 |
| search_params.is_active | Boolean | 否 | 布尔值 | 启用状态必须是布尔值 |
| user_id | ObjectId | 是 | 有效的ObjectId | 用户ID格式不正确 |
| usage_count | Number | 否 | 非负整数 | 使用次数必须是非负整数 |
| last_used_at | Date | 否 | 有效的日期 | 最后使用时间格式不正确 |

**索引设计：**
```javascript
// 复合索引：用户 + 名称
db.saved_searches.createIndex({ 
  "user_id": 1, 
  "name": 1 
})

// 复合索引：用户 + 使用次数
db.saved_searches.createIndex({ 
  "user_id": 1, 
  "usage_count": -1 
})
```

## 数据关系说明

### 1. 分类层级关系
- 支持多级分类结构
- parent_id 为 null 表示顶级分类
- 通过递归查询实现分类树结构

### 2. 材料与分类关系
- 每个材料必须属于一个分类
- 分类删除时需要处理关联材料

### 3. 库存记录关系
- 每次库存变更都会产生记录
- 通过 material_id 关联材料

## 数据初始化脚本

```javascript
// 创建默认分类
db.bead_categories.insertMany([
  {
    name: "水晶类",
    parent_id: null,
    description: "各类水晶材料",
    sort_order: 1,
    material_count: 0,
    is_active: true,
    created_at: new Date(),
    updated_at: new Date()
  },
  {
    name: "玛瑙类", 
    parent_id: null,
    description: "各类玛瑙材料",
    sort_order: 2,
    material_count: 0,
    is_active: true,
    created_at: new Date(),
    updated_at: new Date()
  },
  {
    name: "珍珠类",
    parent_id: null, 
    description: "各类珍珠材料",
    sort_order: 3,
    material_count: 0,
    is_active: true,
    created_at: new Date(),
    updated_at: new Date()
  }
]);
```

## 性能优化建议

### 1. 索引优化
- 根据查询频率创建合适的复合索引
- 定期分析慢查询并优化索引

### 2. 数据分片
- 当数据量增长时，考虑按分类或时间分片

### 3. 缓存策略
- 分类数据适合缓存（变更频率低）
- 库存统计数据可以定时缓存

### 4. 归档策略
- 库存变更记录可以按时间归档
- 保留近期数据在主集合中

## 数据完整性约束

### 1. 业务规则
- 分类名称在同一父级下不能重复
- 材料名称在同一分类下不能重复
- 库存数量不能为负数
- 价格不能为负数

### 2. 引用完整性
- 材料的 category_id 必须存在
- 库存记录的 material_id 必须存在
- 删除分类前必须处理关联材料

### 3. 数据验证
- 使用 Mongoose Schema 进行数据验证
- 在应用层实现业务规则验证