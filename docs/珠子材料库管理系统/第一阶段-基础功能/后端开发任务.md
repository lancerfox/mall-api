# 第一阶段 - 后端开发任务

## 任务概述

实现珠子材料库管理系统的基础功能，包括分类管理、材料管理的完整CRUD操作，以及基础的搜索和分页功能。

## 开发环境准备

### 1. 项目结构调整
```
mall-api/src/modules/
├── bead-material/                 # 珠子材料模块
│   ├── bead-material.module.ts    # 模块定义
│   ├── categories/                # 分类子模块
│   │   ├── categories.controller.ts
│   │   ├── categories.service.ts
│   │   ├── dto/
│   │   │   ├── create-category.dto.ts
│   │   │   ├── update-category.dto.ts
│   │   │   └── query-category.dto.ts
│   │   └── schemas/
│   │       └── category.schema.ts
│   ├── materials/                 # 材料子模块
│   │   ├── materials.controller.ts
│   │   ├── materials.service.ts
│   │   ├── dto/
│   │   │   ├── create-material.dto.ts
│   │   │   ├── update-material.dto.ts
│   │   │   ├── query-material.dto.ts
│   │   │   └── batch-operation.dto.ts
│   │   └── schemas/
│   │       └── material.schema.ts
│   └── common/                    # 公共模块
│       └── dto/
│           └── pagination.dto.ts
```

## 详细开发任务

### 任务1: 创建基础模块结构 (预估时间: 2小时)

#### 1.1 创建珠子材料主模块
**文件**: `src/modules/bead-material/bead-material.module.ts`
```typescript
@Module({
  imports: [
    MongooseModule.forFeature([
      { name: 'BeadCategory', schema: CategorySchema },
      { name: 'BeadMaterial', schema: MaterialSchema },
      { name: 'InventoryRecord', schema: InventoryRecordSchema }
    ])
  ],
  controllers: [CategoriesController, MaterialsController],
  providers: [CategoriesService, MaterialsService],
  exports: [CategoriesService, MaterialsService]
})
export class BeadMaterialModule {}
```

#### 1.2 在主应用模块中注册
**文件**: `src/app.module.ts`
```typescript
// 在imports数组中添加
BeadMaterialModule
```

### 任务2: 创建数据模型Schema (预估时间: 3小时)

#### 2.1 创建分类Schema
**文件**: `src/modules/bead-material/categories/schemas/category.schema.ts`
```typescript
@Schema({ 
  timestamps: { createdAt: 'created_at', updatedAt: 'updated_at' },
  collection: 'bead_categories'
})
export class BeadCategory {
  @Prop({ required: true, trim: true, maxlength: 100 })
  name: string;

  @Prop({ type: mongoose.Schema.Types.ObjectId, ref: 'BeadCategory', default: null })
  parent_id: mongoose.Types.ObjectId | null;

  @Prop({ trim: true, maxlength: 500 })
  description: string;

  @Prop({ default: 0, min: 0 })
  sort_order: number;

  @Prop({ default: 0, min: 0 })
  material_count: number;

  @Prop({ default: true })
  is_active: boolean;

  @Prop({ type: mongoose.Schema.Types.ObjectId, required: true })
  created_by: mongoose.Types.ObjectId;

  @Prop({ type: mongoose.Schema.Types.ObjectId, required: true })
  updated_by: mongoose.Types.ObjectId;

  created_at: Date;
  updated_at: Date;
}

export const CategorySchema = SchemaFactory.createForClass(BeadCategory);

// 创建索引
CategorySchema.index({ parent_id: 1, sort_order: 1 });
CategorySchema.index({ name: 1 });
CategorySchema.index({ is_active: 1 });

// 添加虚拟字段
CategorySchema.virtual('children', {
  ref: 'BeadCategory',
  localField: '_id',
  foreignField: 'parent_id'
});
```

#### 2.2 创建材料Schema
**文件**: `src/modules/bead-material/materials/schemas/material.schema.ts`
```typescript
@Schema({ 
  timestamps: { createdAt: 'created_at', updatedAt: 'updated_at' },
  collection: 'bead_materials'
})
export class BeadMaterial {
  @Prop({ required: true, trim: true, maxlength: 100 })
  name: string;

  @Prop({ type: mongoose.Schema.Types.ObjectId, ref: 'BeadCategory', required: true })
  category_id: mongoose.Types.ObjectId;

  @Prop({ trim: true })
  image_url: string;

  @Prop({ default: 12.0, min: 0 })
  size: number;

  @Prop({ default: 0, min: 0 })
  price: number;

  @Prop({ default: 0, min: 0 })
  stock_quantity: number;

  @Prop({ default: 10, min: 0 })
  min_stock_level: number;

  @Prop({ 
    enum: ['normal', 'low', 'out'], 
    default: function() {
      return this.stock_quantity === 0 ? 'out' : 
             this.stock_quantity <= this.min_stock_level ? 'low' : 'normal';
    }
  })
  stock_status: string;

  @Prop({ trim: true, maxlength: 1000 })
  description: string;

  @Prop({ type: mongoose.Schema.Types.Mixed, default: {} })
  properties: Record<string, any>;

  @Prop({ default: true })
  is_active: boolean;

  @Prop({ type: mongoose.Schema.Types.ObjectId, required: true })
  created_by: mongoose.Types.ObjectId;

  @Prop({ type: mongoose.Schema.Types.ObjectId, required: true })
  updated_by: mongoose.Types.ObjectId;

  created_at: Date;
  updated_at: Date;
}

export const MaterialSchema = SchemaFactory.createForClass(BeadMaterial);

// 创建索引
MaterialSchema.index({ category_id: 1, is_active: 1, name: 1 });
MaterialSchema.index({ name: 'text', description: 'text' });
MaterialSchema.index({ stock_status: 1, price: 1 });
MaterialSchema.index({ stock_quantity: 1 });

// 添加虚拟字段
MaterialSchema.virtual('category', {
  ref: 'BeadCategory',
  localField: 'category_id',
  foreignField: '_id',
  justOne: true
});

// 中间件：更新库存状态
MaterialSchema.pre('save', function() {
  if (this.stock_quantity === 0) {
    this.stock_status = 'out';
  } else if (this.stock_quantity <= this.min_stock_level) {
    this.stock_status = 'low';
  } else {
    this.stock_status = 'normal';
  }
});
```

### 任务3: 创建DTO类 (预估时间: 2小时)

#### 3.1 分类相关DTO
**文件**: `src/modules/bead-material/categories/dto/create-category.dto.ts`
```typescript
export class CreateCategoryDto {
  @IsString({ message: '分类名称必须是字符串' })
  @IsNotEmpty({ message: '分类名称不能为空' })
  @Length(1, 100, { message: '分类名称长度必须在1-100个字符之间' })
  @Matches(/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_()（）]+$/, { 
    message: '分类名称只能包含中文、英文、数字、空格、连字符、下划线和括号' 
  })
  @Transform(({ value }) => value?.trim())
  name: string;

  @IsOptional()
  @IsMongoId({ message: '父级分类ID格式不正确' })
  @ValidateIf((o) => o.parent_id !== null && o.parent_id !== '')
  parent_id?: string;

  @IsOptional()
  @IsString({ message: '分类描述必须是字符串' })
  @MaxLength(500, { message: '分类描述不能超过500个字符' })
  @Transform(({ value }) => value?.trim() || '')
  description?: string;

  @IsOptional()
  @IsNumber({}, { message: '排序顺序必须是数字' })
  @Min(0, { message: '排序顺序不能小于0' })
  @Max(9999, { message: '排序顺序不能大于9999' })
  @IsInt({ message: '排序顺序必须是整数' })
  @Type(() => Number)
  sort_order?: number;
}
```

**文件**: `src/modules/bead-material/categories/dto/update-category.dto.ts`
```typescript
export class UpdateCategoryDto extends PartialType(CreateCategoryDto) {
  @IsMongoId({ message: '分类ID格式不正确' })
  @IsNotEmpty({ message: '分类ID不能为空' })
  id: string;
}
```

**文件**: `src/modules/bead-material/categories/dto/query-category.dto.ts`
```typescript
export class QueryCategoryDto {
  @IsOptional()
  @IsMongoId({ message: '父级分类ID格式不正确' })
  parent_id?: string;

  @IsOptional()
  @IsString({ message: '关键词必须是字符串' })
  @MaxLength(200, { message: '关键词不能超过200个字符' })
  @Transform(({ value }) => value?.trim())
  keyword?: string;

  @IsOptional()
  @IsBoolean({ message: '启用状态必须是布尔值' })
  @Transform(({ value }) => {
    if (typeof value === 'string') {
      return value === 'true';
    }
    return Boolean(value);
  })
  is_active?: boolean;
}
```

#### 3.2 材料相关DTO
**文件**: `src/modules/bead-material/materials/dto/create-material.dto.ts`
```typescript
export class CreateMaterialDto {
  @IsString({ message: '材料名称必须是字符串' })
  @IsNotEmpty({ message: '材料名称不能为空' })
  @Length(1, 100, { message: '材料名称长度必须在1-100个字符之间' })
  @Matches(/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_()（）.·]+$/, { 
    message: '材料名称只能包含中文、英文、数字、空格、连字符、下划线、括号和点号' 
  })
  @Transform(({ value }) => value?.trim())
  name: string;

  @IsMongoId({ message: '分类ID格式不正确' })
  @IsNotEmpty({ message: '分类ID不能为空' })
  category_id: string;

  @IsOptional()
  @IsString({ message: '图片URL必须是字符串' })
  @IsUrl({}, { message: '图片URL格式不正确' })
  @MaxLength(500, { message: '图片URL不能超过500个字符' })
  @Matches(/\.(jpg|jpeg|png|gif|webp)$/i, { 
    message: '图片格式不支持，仅支持jpg、png、gif、webp格式' 
  })
  image_url?: string;

  @IsOptional()
  @IsNumber({}, { message: '尺寸必须是数字' })
  @Min(0.1, { message: '尺寸不能小于0.1mm' })
  @Max(1000, { message: '尺寸不能大于1000mm' })
  @Type(() => Number)
  size?: number;

  @IsOptional()
  @IsNumber({}, { message: '价格必须是数字' })
  @Min(0, { message: '价格不能小于0' })
  @Max(999999.99, { message: '价格不能大于999999.99' })
  @Type(() => Number)
  price?: number;

  @IsOptional()
  @IsNumber({}, { message: '库存数量必须是数字' })
  @Min(0, { message: '库存数量不能小于0' })
  @IsInt({ message: '库存数量必须是整数' })
  @Type(() => Number)
  stock_quantity?: number;

  @IsOptional()
  @IsNumber({}, { message: '最低库存预警值必须是数字' })
  @Min(0, { message: '最低库存预警值不能小于0' })
  @IsInt({ message: '最低库存预警值必须是整数' })
  @Type(() => Number)
  min_stock_level?: number;

  @IsOptional()
  @IsString({ message: '材料描述必须是字符串' })
  @MaxLength(1000, { message: '材料描述不能超过1000个字符' })
  @Transform(({ value }) => value?.trim())
  description?: string;

  @IsOptional()
  @IsObject({ message: '材料属性必须是对象' })
  @ValidateNested()
  @Type(() => MaterialPropertiesDto)
  properties?: MaterialPropertiesDto;
}

export class MaterialPropertiesDto {
  @IsOptional()
  @IsString({ message: '颜色必须是字符串' })
  @MaxLength(50, { message: '颜色名称不能超过50个字符' })
  color?: string;

  @IsOptional()
  @IsNumber({}, { message: '硬度必须是数字' })
  @Min(1, { message: '硬度不能小于1' })
  @Max(10, { message: '硬度不能大于10' })
  @Type(() => Number)
  hardness?: number;

  @IsOptional()
  @IsNumber({}, { message: '密度必须是数字' })
  @Min(0.1, { message: '密度不能小于0.1' })
  @Max(50, { message: '密度不能大于50' })
  @Type(() => Number)
  density?: number;

  @IsOptional()
  @IsString({ message: '透明度必须是字符串' })
  @IsIn(['透明', '半透明', '不透明'], { message: '透明度值不正确' })
  transparency?: string;

  @IsOptional()
  @IsString({ message: '产地必须是字符串' })
  @MaxLength(100, { message: '产地名称不能超过100个字符' })
  origin?: string;
}
```

**文件**: `src/modules/bead-material/materials/dto/query-material.dto.ts`
```typescript
export class QueryMaterialDto extends PaginationDto {
  @IsOptional()
  @IsString({ message: '关键词必须是字符串' })
  @MaxLength(200, { message: '关键词不能超过200个字符' })
  @Transform(({ value }) => value?.trim())
  keyword?: string;

  @IsOptional()
  @IsMongoId({ message: '分类ID格式不正确' })
  category_id?: string;

  @IsOptional()
  @IsNumber({}, { message: '最低价格必须是数字' })
  @Min(0, { message: '最低价格不能小于0' })
  @Type(() => Number)
  min_price?: number;

  @IsOptional()
  @IsNumber({}, { message: '最高价格必须是数字' })
  @Min(0, { message: '最高价格不能小于0' })
  @Type(() => Number)
  max_price?: number;

  @IsOptional()
  @IsIn(['normal', 'low', 'out'], { message: '库存状态值不正确' })
  stock_status?: string;

  @IsOptional()
  @IsBoolean({ message: '启用状态必须是布尔值' })
  @Transform(({ value }) => {
    if (typeof value === 'string') {
      return value === 'true';
    }
    return Boolean(value);
  })
  is_active?: boolean;

  @IsOptional()
  @IsIn(['name', 'price', 'stock_quantity', 'created_at'], { 
    message: '排序字段不正确' 
  })
  sort_by?: string;

  @IsOptional()
  @IsIn(['asc', 'desc'], { message: '排序方向不正确' })
  sort_order?: string;
}
```

#### 3.3 公共DTO
**文件**: `src/modules/bead-material/common/dto/pagination.dto.ts`
```typescript
export class PaginationDto {
  @IsOptional()
  @IsNumber({}, { message: '页码必须是数字' })
  @Min(1, { message: '页码不能小于1' })
  @IsInt({ message: '页码必须是整数' })
  @Type(() => Number)
  page?: number = 1;

  @IsOptional()
  @IsNumber({}, { message: '每页数量必须是数字' })
  @Min(1, { message: '每页数量不能小于1' })
  @Max(100, { message: '每页数量不能大于100' })
  @IsInt({ message: '每页数量必须是整数' })
  @Type(() => Number)
  page_size?: number = 20;
}

export class BatchOperationDto {
  @IsIn(['delete', 'enable', 'disable'], { message: '操作类型不正确' })
  @IsNotEmpty({ message: '操作类型不能为空' })
  action: 'delete' | 'enable' | 'disable';

  @IsArray({ message: 'ID列表必须是数组' })
  @ArrayNotEmpty({ message: 'ID列表不能为空' })
  @IsMongoId({ each: true, message: 'ID格式不正确' })
  ids: string[];
}
```

### 任务4: 实现分类服务 (预估时间: 4小时)

#### 4.1 分类服务实现
**文件**: `src/modules/bead-material/categories/categories.service.ts`
```typescript
@Injectable()
export class CategoriesService {
  constructor(
    @InjectModel('BeadCategory') private categoryModel: Model<BeadCategory>,
    @InjectModel('BeadMaterial') private materialModel: Model<BeadMaterial>
  ) {}

  // 获取分类列表
  async findAll(queryDto: QueryCategoryDto): Promise<BeadCategory[]> {
    const filter: any = {};
    
    if (queryDto.parent_id !== undefined) {
      filter.parent_id = queryDto.parent_id || null;
    }
    
    if (queryDto.keyword) {
      filter.name = { $regex: queryDto.keyword, $options: 'i' };
    }
    
    if (queryDto.is_active !== undefined) {
      filter.is_active = queryDto.is_active;
    }

    return this.categoryModel
      .find(filter)
      .sort({ sort_order: 1, created_at: 1 })
      .populate('children')
      .exec();
  }

  // 创建分类
  async create(createDto: CreateCategoryDto, userId: string): Promise<BeadCategory> {
    // 检查同级分类名称是否重复
    const existingCategory = await this.categoryModel.findOne({
      name: createDto.name,
      parent_id: createDto.parent_id || null
    });

    if (existingCategory) {
      throw new ConflictException('同级分类下已存在相同名称的分类');
    }

    // 验证父级分类是否存在
    if (createDto.parent_id) {
      const parentCategory = await this.categoryModel.findById(createDto.parent_id);
      if (!parentCategory) {
        throw new NotFoundException('父级分类不存在');
      }
    }

    const category = new this.categoryModel({
      ...createDto,
      created_by: userId,
      updated_by: userId
    });

    return category.save();
  }

  // 更新分类
  async update(updateDto: UpdateCategoryDto, userId: string): Promise<BeadCategory> {
    const category = await this.categoryModel.findById(updateDto.id);
    if (!category) {
      throw new NotFoundException('分类不存在');
    }

    // 检查名称重复（排除自身）
    if (updateDto.name) {
      const existingCategory = await this.categoryModel.findOne({
        _id: { $ne: updateDto.id },
        name: updateDto.name,
        parent_id: updateDto.parent_id || category.parent_id
      });

      if (existingCategory) {
        throw new ConflictException('同级分类下已存在相同名称的分类');
      }
    }

    // 验证父级分类
    if (updateDto.parent_id && updateDto.parent_id !== category.parent_id?.toString()) {
      const parentCategory = await this.categoryModel.findById(updateDto.parent_id);
      if (!parentCategory) {
        throw new NotFoundException('父级分类不存在');
      }

      // 防止循环引用
      if (await this.isCircularReference(updateDto.id, updateDto.parent_id)) {
        throw new BadRequestException('不能将分类设置为自己的子分类');
      }
    }

    Object.assign(category, updateDto, { updated_by: userId });
    return category.save();
  }

  // 删除分类
  async remove(id: string): Promise<void> {
    const category = await this.categoryModel.findById(id);
    if (!category) {
      throw new NotFoundException('分类不存在');
    }

    // 检查是否有子分类
    const childrenCount = await this.categoryModel.countDocuments({ parent_id: id });
    if (childrenCount > 0) {
      throw new BadRequestException('该分类下存在子分类，无法删除');
    }

    // 检查是否有关联材料
    const materialCount = await this.materialModel.countDocuments({ category_id: id });
    if (materialCount > 0) {
      throw new BadRequestException('该分类下存在材料，无法删除');
    }

    await this.categoryModel.findByIdAndDelete(id);
  }

  // 获取分类树
  async getTree(): Promise<BeadCategory[]> {
    const categories = await this.categoryModel
      .find({ is_active: true })
      .sort({ sort_order: 1, created_at: 1 })
      .exec();

    return this.buildTree(categories);
  }

  // 构建分类树
  private buildTree(categories: BeadCategory[], parentId: string | null = null): BeadCategory[] {
    return categories
      .filter(cat => (cat.parent_id?.toString() || null) === parentId)
      .map(cat => ({
        ...cat.toObject(),
        children: this.buildTree(categories, cat._id.toString())
      }));
  }

  // 检查循环引用
  private async isCircularReference(categoryId: string, parentId: string): Promise<boolean> {
    if (categoryId === parentId) return true;

    const parent = await this.categoryModel.findById(parentId);
    if (!parent || !parent.parent_id) return false;

    return this.isCircularReference(categoryId, parent.parent_id.toString());
  }

  // 更新材料数量
  async updateMaterialCount(categoryId: string): Promise<void> {
    const count = await this.materialModel.countDocuments({ 
      category_id: categoryId,
      is_active: true 
    });
    
    await this.categoryModel.findByIdAndUpdate(categoryId, { 
      material_count: count 
    });
  }
}
```

### 任务5: 实现分类控制器 (预估时间: 2小时)

#### 5.1 分类控制器实现
**文件**: `src/modules/bead-material/categories/categories.controller.ts`
```typescript
@Controller('categories')
@ApiTags('分类管理')
@UsePipes(new ValidationPipe({ transform: true }))
export class CategoriesController {
  constructor(private readonly categoriesService: CategoriesService) {}

  @Post('create')
  @ApiOperation({
    summary: '创建分类',
    description: '创建一个新的珠子材料分类',
  })
  @ApiBody({
    type: CreateCategoryDto,
    description: '分类创建信息',
    examples: {
      example1: {
        summary: '创建水晶珠分类',
        value: {
          name: '水晶珠',
          description: '各种水晶材质的珠子',
          status: 1,
        },
      },
    },
  })
  @ApiResponse({
    status: 201,
    description: '分类创建成功',
    type: CategoryCreateResponseDto,
  })
  @ApiResponse({ status: 400, description: '参数验证失败' })
  create(@Body() createCategoryDto: CreateCategoryDto, @Req() req: Request) {
    const userId = (req as any).user?.id;
    return this.categoriesService.create(createCategoryDto, userId);
  }

  @Get('list')
  @ApiOperation({
    summary: '获取分类列表',
    description: '获取分类列表，支持分页和搜索',
  })
  @ApiBody({
    type: QueryCategoryDto,
    description: '查询参数',
    examples: {
      example1: {
        summary: '基础查询',
        value: {
          page: 1,
          limit: 10,
        },
      },
      example2: {
        summary: '搜索查询',
        value: {
          page: 1,
          limit: 10,
          keyword: '水晶',
          status: 1,
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '分类列表获取成功',
    type: CategoryListResponseDto,
  })
  findAll(@Body() query: QueryCategoryDto) {
    return this.categoriesService.findAll(query);
  }

  @Get('detail')
  @ApiOperation({
    summary: '获取分类详情',
    description: '根据ID获取分类详细信息',
  })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '分类ID',
          example: '507f1f77bcf86cd799439011',
        },
      },
      required: ['id'],
    },
    description: '分类ID',
    examples: {
      example1: {
        summary: '获取分类详情',
        value: {
          id: '507f1f77bcf86cd799439011',
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '分类详情获取成功',
    type: CategoryDetailResponseDto,
  })
  @ApiResponse({ status: 404, description: '分类不存在' })
  findOne(@Body('id') id: string) {
    return this.categoriesService.findOne(id);
  }

  @Post('update')
  @ApiOperation({ summary: '更新分类', description: '更新分类信息' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '分类ID',
          example: '507f1f77bcf86cd799439011',
        },
        name: {
          type: 'string',
          description: '分类名称',
          example: '水晶珠',
          nullable: true,
        },
        description: {
          type: 'string',
          description: '分类描述',
          example: '各种水晶材质的珠子',
          nullable: true,
        },
        status: {
          type: 'number',
          description: '状态 1-启用 0-禁用',
          example: 1,
          nullable: true,
        },
      },
      required: ['id'],
    },
    description: '更新分类信息',
    examples: {
      example1: {
        summary: '更新分类名称',
        value: {
          id: '507f1f77bcf86cd799439011',
          name: '天然水晶珠',
        },
      },
      example2: {
        summary: '更新完整信息',
        value: {
          id: '507f1f77bcf86cd799439011',
          name: '天然水晶珠',
          description: '高品质天然水晶材质珠子',
          status: 1,
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '分类更新成功',
    type: CategoryUpdateResponseDto,
  })
  @ApiResponse({ status: 404, description: '分类不存在' })
  update(
    @Body('id') id: string,
    @Body() updateCategoryDto: UpdateCategoryDto,
    @Req() req: Request,
  ) {
    const userId = (req as any).user?.id;
    return this.categoriesService.update(id, updateCategoryDto, userId);
  }

  @Post('delete')
  @ApiOperation({ summary: '删除分类', description: '根据ID删除分类' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '分类ID',
          example: '507f1f77bcf86cd799439011',
        },
      },
      required: ['id'],
    },
    description: '删除分类',
    examples: {
      example1: {
        summary: '删除分类',
        value: {
          id: '507f1f77bcf86cd799439011',
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '分类删除成功',
    type: CategoryDeleteResponseDto,
  })
  @ApiResponse({ status: 404, description: '分类不存在' })
  remove(@Body('id') id: string) {
    return this.categoriesService.remove(id);
  }
}
```

### 任务6: 实现材料服务 (预估时间: 5小时)

#### 6.1 材料服务实现
**文件**: `src/modules/bead-material/materials/materials.service.ts`
```typescript
@Injectable()
export class MaterialsService {
  constructor(
    @InjectModel('BeadMaterial') private materialModel: Model<BeadMaterial>,
    @InjectModel('BeadCategory') private categoryModel: Model<BeadCategory>,
    private categoriesService: CategoriesService
  ) {}

  // 获取材料列表（带分页和搜索）
  async findAll(queryDto: QueryMaterialDto): Promise<{
    data: BeadMaterial[];
    pagination: {
      page: number;
      page_size: number;
      total: number;
      total_pages: number;
    };
  }> {
    const { page = 1, page_size = 20, ...filters } = queryDto;
    const skip = (page - 1) * page_size;

    // 构建查询条件
    const filter: any = {};

    if (filters.keyword) {
      filter.$or = [
        { name: { $regex: filters.keyword, $options: 'i' } },
        { description: { $regex: filters.keyword, $options: 'i' } }
      ];
    }

    if (filters.category_id) {
      filter.category_id = filters.category_id;
    }

    if (filters.min_price !== undefined || filters.max_price !== undefined) {
      filter.price = {};
      if (filters.min_price !== undefined) filter.price.$gte = filters.min_price;
      if (filters.max_price !== undefined) filter.price.$lte = filters.max_price;
    }

    if (filters.stock_status) {
      filter.stock_status = filters.stock_status;
    }

    if (filters.is_active !== undefined) {
      filter.is_active = filters.is_active;
    }

    // 构建排序条件
    const sort: any = {};
    if (filters.sort_by) {
      sort[filters.sort_by] = filters.sort_order === 'desc' ? -1 : 1;
    } else {
      sort.created_at = -1;
    }

    // 执行查询
    const [data, total] = await Promise.all([
      this.materialModel
        .find(filter)
        .populate('category_id', 'name')
        .sort(sort)
        .skip(skip)
        .limit(page_size)
        .exec(),
      this.materialModel.countDocuments(filter)
    ]);

    // 转换数据格式
    const materials = data.map(material => {
      const materialObj = material.toObject();
      return {
        ...materialObj,
        category_name: materialObj.category_id?.name || ''
      };
    });

    return {
      data: materials,
      pagination: {
        page,
        page_size,
        total,
        total_pages: Math.ceil(total / page_size)
      }
    };
  }

  // 创建材料
  async create(createDto: CreateMaterialDto, userId: string): Promise<BeadMaterial> {
    // 验证分类是否存在
    const category = await this.categoryModel.findById(createDto.category_id);
    if (!category) {
      throw new NotFoundException('分类不存在');
    }

    // 检查同分类下材料名称是否重复
    const existingMaterial = await this.materialModel.findOne({
      name: createDto.name,
      category_id: createDto.category_id
    });

    if (existingMaterial) {
      throw new ConflictException('该分类下已存在相同名称的材料');
    }

    const material = new this.materialModel({
      ...createDto,
      created_by: userId,
      updated_by: userId
    });

    const savedMaterial = await material.save();

    // 更新分类的材料数量
    await this.categoriesService.updateMaterialCount(createDto.category_id);

    return savedMaterial.populate('category_id', 'name');
  }

  // 获取材料详情
  async findOne(id: string): Promise<BeadMaterial> {
    const material = await this.materialModel
      .findById(id)
      .populate('category_id', 'name')
      .exec();

    if (!material) {
      throw new NotFoundException('材料不存在');
    }

    return material;
  }

  // 更新材料
  async update(updateDto: UpdateMaterialDto, userId: string): Promise<BeadMaterial> {
    const material = await this.materialModel.findById(updateDto.id);
    if (!material) {
      throw new NotFoundException('材料不存在');
    }

    const oldCategoryId = material.category_id.toString();

    // 验证分类是否存在
    if (updateDto.category_id && updateDto.category_id !== oldCategoryId) {
      const category = await this.categoryModel.findById(updateDto.category_id);
      if (!category) {
        throw new NotFoundException('分类不存在');
      }
    }

    // 检查名称重复（排除自身）
    if (updateDto.name || updateDto.category_id) {
      const checkName = updateDto.name || material.name;
      const checkCategoryId = updateDto.category_id || oldCategoryId;

      const existingMaterial = await this.materialModel.findOne({
        _id: { $ne: updateDto.id },
        name: checkName,
        category_id: checkCategoryId
      });

      if (existingMaterial) {
        throw new ConflictException('该分类下已存在相同名称的材料');
      }
    }

    Object.assign(material, updateDto, { updated_by: userId });
    const updatedMaterial = await material.save();

    // 如果分类发生变化，更新相关分类的材料数量
    if (updateDto.category_id && updateDto.category_id !== oldCategoryId) {
      await Promise.all([
        this.categoriesService.updateMaterialCount(oldCategoryId),
        this.categoriesService.updateMaterialCount(updateDto.category_id)
      ]);
    }

    return updatedMaterial.populate('category_id', 'name');
  }

  // 删除材料
  async remove(id: string): Promise<void> {
    const material = await this.materialModel.findById(id);
    if (!material) {
      throw new NotFoundException('材料不存在');
    }

    const categoryId = material.category_id.toString();
    await this.materialModel.findByIdAndDelete(id);

    // 更新分类的材料数量
    await this.categoriesService.updateMaterialCount(categoryId);
  }

  // 批量操作
  async batchOperation(batchDto: BatchOperationDto, userId: string): Promise<{
    success_count: number;
    failed_count: number;
    failed_ids: string[];
  }> {
    const { action, ids } = batchDto;
    let successCount = 0;
    let failedCount = 0;
    const failedIds: string[] = [];

    for (const id of ids) {
      try {
        switch (action) {
          case 'delete':
            await this.remove(id);
            break;
          case 'enable':
            await this.materialModel.findByIdAndUpdate(id, { 
              is_active: true, 
              updated_by: userId 
            });
            break;
          case 'disable':
            await this.materialModel.findByIdAndUpdate(id, { 
              is_active: false, 
              updated_by: userId 
            });
            break;
        }
        successCount++;
      } catch (error) {
        failedCount++;
        failedIds.push(id);
      }
    }

    return {
      success_count: successCount,
      failed_count: failedCount,
      failed_ids: failedIds
    };
  }

  // 搜索材料（高级搜索）
  async search(searchDto: QueryMaterialDto): Promise<{
    data: BeadMaterial[];
    pagination: any;
  }> {
    // 使用全文搜索
    const filter: any = {};

    if (searchDto.keyword) {
      filter.$text = { $search: searchDto.keyword };
    }

    // 其他筛选条件...
    if (searchDto.category_id) filter.category_id = searchDto.category_id;
    if (searchDto.stock_status) filter.stock_status = searchDto.stock_status;
    if (searchDto.is_active !== undefined) filter.is_active = searchDto.is_active;

    const { page = 1, page_size = 20 } = searchDto;
    const skip = (page - 1) * page_size;

    const [data, total] = await Promise.all([
      this.materialModel
        .find(filter, searchDto.keyword ? { score: { $meta: 'textScore' } } : {})
        .populate('category_id', 'name')
        .sort(searchDto.keyword ? { score: { $meta: 'textScore' } } : { created_at: -1 })
        .skip(skip)
        .limit(page_size)
        .exec(),
      this.materialModel.countDocuments(filter)
    ]);

    return {
      data,
      pagination: {
        page,
        page_size,
        total,
        total_pages: Math.ceil(total / page_size)
      }
    };
  }
}
```

### 任务7: 实现材料控制器 (预估时间: 3小时)

#### 7.1 材料控制器实现
**文件**: `src/modules/bead-material/materials/materials.controller.ts`
```typescript
@Controller('materials')
@ApiTags('材料管理')
@UsePipes(new ValidationPipe({ transform: true }))
export class MaterialsController {
  constructor(private readonly materialsService: MaterialsService) {}

  @Post('create')
  @ApiOperation({ summary: '创建材料', description: '创建一个新的珠子材料' })
  @ApiBody({
    type: CreateMaterialDto,
    description: '材料创建信息',
    examples: {
      example1: {
        summary: '创建红玛瑙珠',
        value: {
          name: '红玛瑙珠',
          categoryId: '507f1f77bcf86cd799439012',
          color: '红色',
          size: '8mm',
          shape: '圆形',
          material: '玛瑙',
          unit: '颗',
          price: 1.5,
          stock: 1000,
          minStock: 100,
          maxStock: 5000,
          description: '高品质红玛瑙珠，颜色鲜艳',
          status: 1,
        },
      },
    },
  })
  @ApiResponse({
    status: 201,
    description: '材料创建成功',
    type: MaterialCreateResponseDto,
  })
  @ApiResponse({ status: 400, description: '参数验证失败' })
  create(@Body() createMaterialDto: CreateMaterialDto, @Req() req: Request) {
    const userId = (req.user as { id: string })?.id;
    return this.materialsService.create(createMaterialDto, userId);
  }

  @Get('list')
  @ApiOperation({
    summary: '获取材料列表',
    description: '获取材料列表，支持分页、搜索和筛选',
  })
  @ApiBody({
    type: QueryMaterialDto,
    description: '查询参数',
    examples: {
      example1: {
        summary: '基础查询',
        value: {
          page: 1,
          limit: 10,
        },
      },
      example2: {
        summary: '搜索查询',
        value: {
          page: 1,
          limit: 10,
          keyword: '玛瑙',
          categoryId: '507f1f77bcf86cd799439012',
          color: '红色',
          status: 1,
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '材料列表获取成功',
    type: MaterialListResponseDto,
  })
  findAll(@Body() query: QueryMaterialDto) {
    return this.materialsService.findAll(query);
  }

  @Get('detail')
  @ApiOperation({
    summary: '获取材料详情',
    description: '根据ID获取材料详细信息',
  })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '材料ID',
          example: '507f1f77bcf86cd799439011',
        },
      },
      required: ['id'],
    },
    description: '材料ID',
    examples: {
      example1: {
        summary: '获取材料详情',
        value: {
          id: '507f1f77bcf86cd799439011',
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '材料详情获取成功',
    type: MaterialDetailResponseDto,
  })
  @ApiResponse({ status: 404, description: '材料不存在' })
  findOne(@Body('id') id: string) {
    return this.materialsService.findOne(id);
  }

  @Post('update')
  @ApiOperation({ summary: '更新材料', description: '更新材料信息' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '材料ID',
          example: '507f1f77bcf86cd799439011',
        },
        name: {
          type: 'string',
          description: '材料名称',
          example: '红玛瑙珠',
          nullable: true,
        },
        categoryId: {
          type: 'string',
          description: '分类ID',
          example: '507f1f77bcf86cd799439012',
          nullable: true,
        },
        color: {
          type: 'string',
          description: '颜色',
          example: '红色',
          nullable: true,
        },
        size: {
          type: 'string',
          description: '尺寸',
          example: '8mm',
          nullable: true,
        },
        shape: {
          type: 'string',
          description: '形状',
          example: '圆形',
          nullable: true,
        },
        material: {
          type: 'string',
          description: '材质',
          example: '玛瑙',
          nullable: true,
        },
        unit: {
          type: 'string',
          description: '单位',
          example: '颗',
          nullable: true,
        },
        price: {
          type: 'number',
          description: '价格',
          example: 1.5,
          nullable: true,
        },
        stock: {
          type: 'number',
          description: '库存数量',
          example: 1000,
          nullable: true,
        },
        minStock: {
          type: 'number',
          description: '最小库存',
          example: 100,
          nullable: true,
        },
        maxStock: {
          type: 'number',
          description: '最大库存',
          example: 5000,
          nullable: true,
        },
        description: {
          type: 'string',
          description: '描述',
          example: '高品质红玛瑙珠，颜色鲜艳',
          nullable: true,
        },
        status: {
          type: 'number',
          description: '状态 1-启用 0-禁用',
          example: 1,
          nullable: true,
        },
      },
      required: ['id'],
    },
    description: '更新材料信息',
    examples: {
      example1: {
        summary: '更新材料价格',
        value: {
          id: '507f1f77bcf86cd799439011',
          price: 2.0,
        },
      },
      example2: {
        summary: '更新完整信息',
        value: {
          id: '507f1f77bcf86cd799439011',
          name: '天然红玛瑙珠',
          color: '深红色',
          price: 2.0,
          stock: 1500,
          description: '天然高品质红玛瑙珠，颜色深邃鲜艳',
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '材料更新成功',
    type: MaterialUpdateResponseDto,
  })
  @ApiResponse({ status: 404, description: '材料不存在' })
  update(
    @Body('id') id: string,
    @Body() updateMaterialDto: UpdateMaterialDto,
    @Req() req: Request,
  ) {
    const userId = (req.user as { id: string })?.id;
    return this.materialsService.update(id, updateMaterialDto, userId);
  }

  @Post('update-stock')
  @ApiOperation({ summary: '更新库存', description: '更新材料库存数量' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '材料ID',
          example: '507f1f77bcf86cd799439011',
        },
        quantity: {
          type: 'number',
          description: '库存变化数量（正数为增加，负数为减少）',
          example: 100,
        },
      },
      required: ['id', 'quantity'],
    },
    description: '更新库存',
    examples: {
      example1: {
        summary: '增加库存',
        value: {
          id: '507f1f77bcf86cd799439011',
          quantity: 100,
        },
      },
      example2: {
        summary: '减少库存',
        value: {
          id: '507f1f77bcf86cd799439011',
          quantity: -50,
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '库存更新成功',
    type: MaterialStockUpdateResponseDto,
  })
  @ApiResponse({ status: 404, description: '材料不存在' })
  updateStock(
    @Body('id') id: string,
    @Body('quantity') quantity: number,
    @Req() req: Request,
  ) {
    const userId = (req.user as { id: string })?.id;
    return this.materialsService.updateStock(id, quantity, userId);
  }

  @Post('delete')
  @ApiOperation({ summary: '删除材料', description: '删除材料' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        id: {
          type: 'string',
          description: '材料ID',
          example: '507f1f77bcf86cd799439011',
        },
      },
      required: ['id'],
    },
    description: '删除材料',
    examples: {
      example1: {
        summary: '删除材料',
        value: {
          id: '507f1f77bcf86cd799439011',
        },
      },
    },
  })
  @ApiResponse({
    status: 200,
    description: '材料删除成功',
    type: MaterialDeleteResponseDto,
  })
  @ApiResponse({ status: 404, description: '材料不存在' })
  remove(@Body('id') id: string) {
    return this.materialsService.remove(id);
  }
}
```



## 测试任务

### 任务9: 单元测试 (预估时间: 4小时)

#### 9.1 分类服务测试
**文件**: `src/modules/bead-material/categories/categories.service.spec.ts`
```typescript
describe('CategoriesService', () => {
  let service: CategoriesService;
  let categoryModel: Model<BeadCategory>;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        CategoriesService,
        {
          provide: getModelToken('BeadCategory'),
          useValue: mockCategoryModel,
        },
        {
          provide: getModelToken('BeadMaterial'),
          useValue: mockMaterialModel,
        },
      ],
    }).compile();

    service = module.get<CategoriesService>(CategoriesService);
    categoryModel = module.get<Model<BeadCategory>>(getModelToken('BeadCategory'));
  });

  describe('create', () => {
    it('should create a category successfully', async () => {
      // 测试用例实现
    });

    it('should throw ConflictException when name already exists', async () => {
      // 测试用例实现
    });
  });

  // 其他测试用例...
});
```

### 任务10: 集成测试 (预估时间: 3小时)

#### 10.1 API端点测试
**文件**: `test/bead-material.e2e-spec.ts`
```typescript
describe('BeadMaterial (e2e)', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  describe('/api/bead-material/categories (POST)', () => {
    it('should create category', () => {
      return request(app.getHttpServer())
        .post('/api/bead-material/categories/create')
        .send({
          name: '测试分类',
          description: '测试描述'
        })
        .expect(201)
        .expect((res) => {
          expect(res.body.code).toBe(0);
          expect(res.body.data.name).toBe('测试分类');
        });
    });
  });

  // 其他测试用例...
});
```

## 部署和配置

### 任务11: 环境配置 (预估时间: 1小时)

#### 11.1 数据库连接配置
**文件**: `src/config/database.config.ts`
```typescript
export const databaseConfig = {
  uri: process.env.MONGODB_URI || 'mongodb://localhost:27017/bead_material_db',
  options: {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  }
};
```

#### 11.2 Swagger配置
**文件**: `src/main.ts`
```typescript
// 添加Swagger配置
const config = new DocumentBuilder()
  .setTitle('珠子材料库管理系统API')
  .setDescription('珠子材料库管理系统的API文档')
  .setVersion('1.0')
  .addBearerAuth()
  .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api/docs', app, document);
```

## 验收标准

### 功能验收
1. ✅ 分类CRUD操作正常
2. ✅ 材料CRUD操作正常
3. ✅ 分页和搜索功能正常
4. ✅ 数据验证和错误处理正常
5. ✅ API响应格式统一

### 性能验收
1. ✅ 单个API响应时间 < 500ms
2. ✅ 支持并发请求 > 100
3. ✅ 数据库查询优化

### 代码质量验收
1. ✅ 单元测试覆盖率 > 80%
2. ✅ ESLint检查通过
3. ✅ TypeScript类型检查通过
4. ✅ API文档完整

## 预估总时间

**总计：30小时**

- 基础模块结构：2小时
- 数据模型Schema：3小时
- DTO类创建：2小时
- 分类服务：4小时
- 分类控制器：2小时
- 材料服务：5小时
- 材料控制器：3小时
- 公共工具类：1小时
- 单元测试：4小时
- 集成测试：3小时
- 环境配置：1小时