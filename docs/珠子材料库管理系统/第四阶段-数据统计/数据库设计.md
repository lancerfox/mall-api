# 第四阶段 - 数据统计数据库设计

## 设计概述

第四阶段主要实现数据统计和可视化功能，需要新增统计数据表、报表管理表、数据快照表等，以及对现有数据的聚合和分析支持。

## 新增数据表设计

### 1. 数据统计快照表 (data_snapshots)

**表说明**: 定期生成的数据快照，用于历史数据对比和趋势分析

```javascript
// MongoDB Collection Schema
const dataSnapshotSchema = new mongoose.Schema({
  // 快照基础信息
  snapshot_date: {
    type: Date,
    required: true,
    index: true
  },
  snapshot_type: {
    type: String,
    enum: ['daily', 'weekly', 'monthly', 'quarterly', 'yearly'],
    required: true,
    index: true
  },
  
  // 基础统计数据
  basic_stats: {
    total_materials: {
      type: Number,
      min: 0,
      default: 0
    },
    active_materials: {
      type: Number,
      min: 0,
      default: 0
    },
    total_categories: {
      type: Number,
      min: 0,
      default: 0
    },
    active_categories: {
      type: Number,
      min: 0,
      default: 0
    },
    total_stock_value: {
      type: Number,
      min: 0,
      default: 0
    },
    total_stock_quantity: {
      type: Number,
      min: 0,
      default: 0
    }
  },
  
  // 分类统计数据
  category_stats: [{
    category_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'BeadCategory',
      required: true
    },
    category_name: {
      type: String,
      required: true
    },
    material_count: {
      type: Number,
      min: 0,
      default: 0
    },
    total_value: {
      type: Number,
      min: 0,
      default: 0
    },
    avg_price: {
      type: Number,
      min: 0,
      default: 0
    },
    stock_quantity: {
      type: Number,
      min: 0,
      default: 0
    }
  }],
  
  // 价格分布统计
  price_distribution: {
    ranges: [{
      min_price: Number,
      max_price: Number,
      material_count: Number,
      percentage: Number
    }],
    avg_price: {
      type: Number,
      min: 0,
      default: 0
    },
    median_price: {
      type: Number,
      min: 0,
      default: 0
    },
    price_std_dev: {
      type: Number,
      min: 0,
      default: 0
    }
  },
  
  // 库存分布统计
  stock_distribution: {
    in_stock_count: {
      type: Number,
      min: 0,
      default: 0
    },
    low_stock_count: {
      type: Number,
      min: 0,
      default: 0
    },
    out_of_stock_count: {
      type: Number,
      min: 0,
      default: 0
    },
    overstock_count: {
      type: Number,
      min: 0,
      default: 0
    }
  },
  
  // 库存变动统计
  inventory_movement: {
    total_in_quantity: {
      type: Number,
      min: 0,
      default: 0
    },
    total_out_quantity: {
      type: Number,
      min: 0,
      default: 0
    },
    net_change: {
      type: Number,
      default: 0
    },
    movement_count: {
      type: Number,
      min: 0,
      default: 0
    }
  },
  
  // 生成信息
  generated_by: {
    type: String,
    enum: ['system', 'manual'],
    default: 'system'
  },
  generation_duration: {
    type: Number, // 生成耗时(毫秒)
    min: 0
  }
}, {
  timestamps: true,
  collection: 'data_snapshots'
});

// 复合索引
dataSnapshotSchema.index({ snapshot_date: -1, snapshot_type: 1 });
dataSnapshotSchema.index({ snapshot_type: 1, snapshot_date: -1 });
```

### 2. 报表管理表 (reports)

**表说明**: 管理生成的报表文件和报表配置

```javascript
// MongoDB Collection Schema
const reportSchema = new mongoose.Schema({
  // 报表基础信息
  report_name: {
    type: String,
    required: true,
    maxlength: 100,
    trim: true
  },
  report_type: {
    type: String,
    enum: ['stock_value', 'inventory_detail', 'material_usage', 'stock_alert', 'comprehensive', 'custom'],
    required: true,
    index: true
  },
  description: {
    type: String,
    maxlength: 500,
    trim: true
  },
  
  // 报表参数
  report_config: {
    date_range: {
      start_date: {
        type: Date,
        required: true
      },
      end_date: {
        type: Date,
        required: true
      }
    },
    filters: {
      category_ids: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'BeadCategory'
      }],
      material_ids: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'BeadMaterial'
      }],
      price_range: {
        min: { type: Number, min: 0 },
        max: { type: Number, min: 0 }
      },
      stock_status: [{
        type: String,
        enum: ['in_stock', 'low_stock', 'out_of_stock', 'overstock']
      }]
    },
    group_by: [{
      type: String,
      enum: ['category', 'date', 'price_range', 'stock_status', 'material_type']
    }],
    metrics: [{
      type: String,
      enum: ['count', 'sum', 'avg', 'min', 'max', 'percentage']
    }],
    chart_types: [{
      type: String,
      enum: ['line', 'bar', 'pie', 'area', 'scatter', 'heatmap']
    }]
  },
  
  // 文件信息
  file_info: {
    file_name: {
      type: String,
      required: true
    },
    file_path: {
      type: String,
      required: true
    },
    file_size: {
      type: Number,
      min: 0
    },
    file_format: {
      type: String,
      enum: ['excel', 'pdf', 'csv', 'json'],
      required: true
    },
    mime_type: String,
    download_url: String
  },
  
  // 生成信息
  generated_by: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },
  generation_status: {
    type: String,
    enum: ['pending', 'generating', 'completed', 'failed', 'expired'],
    default: 'pending',
    index: true
  },
  generation_progress: {
    type: Number,
    min: 0,
    max: 100,
    default: 0
  },
  generation_duration: {
    type: Number, // 生成耗时(毫秒)
    min: 0
  },
  error_message: String,
  
  // 使用统计
  download_count: {
    type: Number,
    min: 0,
    default: 0
  },
  last_downloaded_at: Date,
  view_count: {
    type: Number,
    min: 0,
    default: 0
  },
  
  // 共享设置
  is_public: {
    type: Boolean,
    default: false
  },
  shared_with: [{
    user_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    permission: {
      type: String,
      enum: ['view', 'download'],
      default: 'view'
    },
    shared_at: {
      type: Date,
      default: Date.now
    }
  }],
  
  // 过期设置
  expires_at: {
    type: Date,
    index: true
  },
  auto_delete: {
    type: Boolean,
    default: true
  }
}, {
  timestamps: true,
  collection: 'reports'
});

// 复合索引
reportSchema.index({ generated_by: 1, createdAt: -1 });
reportSchema.index({ report_type: 1, generation_status: 1 });
reportSchema.index({ expires_at: 1, auto_delete: 1 });
```

### 3. 库存预警表 (stock_alerts)

**表说明**: 库存预警记录和处理状态

```javascript
// MongoDB Collection Schema
const stockAlertSchema = new mongoose.Schema({
  // 预警基础信息
  material_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'BeadMaterial',
    required: true,
    index: true
  },
  alert_type: {
    type: String,
    enum: ['low_stock', 'out_of_stock', 'overstock', 'expiring', 'price_change'],
    required: true,
    index: true
  },
  alert_level: {
    type: String,
    enum: ['info', 'warning', 'critical', 'urgent'],
    required: true,
    index: true
  },
  
  // 预警内容
  alert_title: {
    type: String,
    required: true,
    maxlength: 100
  },
  alert_message: {
    type: String,
    required: true,
    maxlength: 500
  },
  
  // 预警数据
  alert_data: {
    current_quantity: Number,
    threshold_quantity: Number,
    suggested_quantity: Number,
    current_price: Number,
    previous_price: Number,
    price_change_rate: Number,
    expiry_date: Date,
    days_to_expiry: Number
  },
  
  // 处理状态
  status: {
    type: String,
    enum: ['active', 'acknowledged', 'resolved', 'ignored', 'expired'],
    default: 'active',
    index: true
  },
  
  // 处理信息
  acknowledged_by: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  },
  acknowledged_at: Date,
  resolved_by: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  },
  resolved_at: Date,
  resolution_note: {
    type: String,
    maxlength: 500
  },
  
  // 自动处理
  auto_resolve: {
    type: Boolean,
    default: false
  },
  auto_resolve_condition: {
    type: String,
    enum: ['stock_replenished', 'price_stabilized', 'manual_override']
  },
  
  // 通知设置
  notification_sent: {
    type: Boolean,
    default: false
  },
  notification_channels: [{
    type: String,
    enum: ['email', 'sms', 'push', 'webhook']
  }],
  notification_recipients: [{
    user_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    channel: String,
    sent_at: Date,
    status: {
      type: String,
      enum: ['pending', 'sent', 'failed']
    }
  }],
  
  // 重复预警控制
  is_recurring: {
    type: Boolean,
    default: false
  },
  recurrence_interval: {
    type: Number, // 小时
    min: 1,
    max: 168 // 最多一周
  },
  next_alert_time: Date,
  
  // 过期时间
  expires_at: {
    type: Date,
    index: true
  }
}, {
  timestamps: true,
  collection: 'stock_alerts'
});

// 复合索引
stockAlertSchema.index({ material_id: 1, alert_type: 1, status: 1 });
stockAlertSchema.index({ alert_level: 1, status: 1, createdAt: -1 });
stockAlertSchema.index({ status: 1, expires_at: 1 });
```

### 4. 数据分析任务表 (analysis_tasks)

**表说明**: 数据分析任务的管理和执行状态

```javascript
// MongoDB Collection Schema
const analysisTaskSchema = new mongoose.Schema({
  // 任务基础信息
  task_name: {
    type: String,
    required: true,
    maxlength: 100,
    trim: true
  },
  task_type: {
    type: String,
    enum: ['trend_analysis', 'prediction', 'correlation', 'anomaly_detection', 'custom'],
    required: true,
    index: true
  },
  description: {
    type: String,
    maxlength: 500,
    trim: true
  },
  
  // 分析参数
  analysis_config: {
    data_source: {
      type: String,
      enum: ['materials', 'categories', 'inventory_records', 'snapshots', 'mixed'],
      required: true
    },
    time_range: {
      start_date: Date,
      end_date: Date,
      granularity: {
        type: String,
        enum: ['hour', 'day', 'week', 'month', 'quarter', 'year']
      }
    },
    filters: {
      category_ids: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'BeadCategory'
      }],
      material_ids: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'BeadMaterial'
      }],
      conditions: mongoose.Schema.Types.Mixed
    },
    metrics: [{
      name: String,
      type: {
        type: String,
        enum: ['count', 'sum', 'avg', 'min', 'max', 'variance', 'correlation']
      },
      field: String
    }],
    algorithms: [{
      name: String,
      parameters: mongoose.Schema.Types.Mixed
    }]
  },
  
  // 执行状态
  execution_status: {
    type: String,
    enum: ['pending', 'running', 'completed', 'failed', 'cancelled'],
    default: 'pending',
    index: true
  },
  execution_progress: {
    type: Number,
    min: 0,
    max: 100,
    default: 0
  },
  
  // 执行信息
  started_at: Date,
  completed_at: Date,
  execution_duration: Number, // 毫秒
  error_message: String,
  
  // 结果信息
  result_data: {
    summary: mongoose.Schema.Types.Mixed,
    details: mongoose.Schema.Types.Mixed,
    charts: [{
      type: String,
      config: mongoose.Schema.Types.Mixed,
      data: mongoose.Schema.Types.Mixed
    }],
    insights: [{
      type: String,
      confidence: Number,
      description: String,
      recommendation: String
    }]
  },
  
  // 调度设置
  is_scheduled: {
    type: Boolean,
    default: false
  },
  schedule_config: {
    frequency: {
      type: String,
      enum: ['once', 'daily', 'weekly', 'monthly']
    },
    cron_expression: String,
    next_run_time: Date,
    timezone: {
      type: String,
      default: 'Asia/Shanghai'
    }
  },
  
  // 创建者信息
  created_by: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },
  
  // 权限设置
  is_public: {
    type: Boolean,
    default: false
  },
  shared_with: [{
    user_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    permission: {
      type: String,
      enum: ['view', 'edit', 'execute'],
      default: 'view'
    }
  }]
}, {
  timestamps: true,
  collection: 'analysis_tasks'
});

// 复合索引
analysisTaskSchema.index({ created_by: 1, createdAt: -1 });
analysisTaskSchema.index({ task_type: 1, execution_status: 1 });
analysisTaskSchema.index({ is_scheduled: 1, 'schedule_config.next_run_time': 1 });
```

### 5. 系统性能监控表 (performance_metrics)

**表说明**: 系统性能指标监控数据

```javascript
// MongoDB Collection Schema
const performanceMetricsSchema = new mongoose.Schema({
  // 监控时间
  metric_time: {
    type: Date,
    required: true,
    index: true
  },
  metric_type: {
    type: String,
    enum: ['api_performance', 'database_performance', 'search_performance', 'export_performance'],
    required: true,
    index: true
  },
  
  // API性能指标
  api_metrics: {
    endpoint: String,
    method: String,
    response_time: Number, // 毫秒
    status_code: Number,
    request_size: Number, // 字节
    response_size: Number, // 字节
    user_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    }
  },
  
  // 数据库性能指标
  database_metrics: {
    operation_type: {
      type: String,
      enum: ['find', 'insert', 'update', 'delete', 'aggregate']
    },
    collection_name: String,
    execution_time: Number, // 毫秒
    documents_examined: Number,
    documents_returned: Number,
    index_used: Boolean,
    query_plan: mongoose.Schema.Types.Mixed
  },
  
  // 搜索性能指标
  search_metrics: {
    search_keyword: String,
    search_type: String,
    result_count: Number,
    search_time: Number, // 毫秒
    filters_used: [String],
    index_effectiveness: Number // 0-1
  },
  
  // 导出性能指标
  export_metrics: {
    export_type: String,
    file_format: String,
    record_count: Number,
    file_size: Number, // 字节
    generation_time: Number, // 毫秒
    memory_usage: Number // 字节
  },
  
  // 系统资源使用
  system_resources: {
    cpu_usage: Number, // 百分比
    memory_usage: Number, // 字节
    disk_usage: Number, // 字节
    network_io: {
      bytes_in: Number,
      bytes_out: Number
    }
  }
}, {
  timestamps: true,
  collection: 'performance_metrics'
});

// 复合索引
performanceMetricsSchema.index({ metric_time: -1, metric_type: 1 });
performanceMetricsSchema.index({ metric_type: 1, metric_time: -1 });
```

## 现有表结构扩展

### 1. 库存记录表 (inventory_records) 扩展

```javascript
// 新增统计相关字段
const inventoryRecordExtension = {
  // 批次信息
  batch_number: {
    type: String,
    maxlength: 50,
    index: true
  },
  
  // 成本信息
  unit_cost: {
    type: Number,
    min: 0
  },
  total_cost: {
    type: Number,
    min: 0
  },
  
  // 供应商信息
  supplier_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Supplier'
  },
  
  // 统计标记
  is_counted_in_stats: {
    type: Boolean,
    default: true,
    index: true
  },
  
  // 关联分析任务
  analysis_tags: [String]
};

// 新增索引
inventoryRecordSchema.index({ record_date: -1, record_type: 1, is_counted_in_stats: 1 });
inventoryRecordSchema.index({ material_id: 1, record_date: -1 });
inventoryRecordSchema.index({ batch_number: 1, record_date: -1 });
```

### 2. 材料表 (bead_materials) 统计字段扩展

```javascript
// 新增统计相关字段
const materialStatsExtension = {
  // 统计数据
  stats: {
    total_in_quantity: {
      type: Number,
      min: 0,
      default: 0
    },
    total_out_quantity: {
      type: Number,
      min: 0,
      default: 0
    },
    avg_monthly_usage: {
      type: Number,
      min: 0,
      default: 0
    },
    last_movement_date: Date,
    turnover_rate: {
      type: Number,
      min: 0,
      default: 0
    },
    popularity_score: {
      type: Number,
      min: 0,
      max: 100,
      default: 0
    }
  },
  
  // 预警设置
  alert_settings: {
    low_stock_threshold: {
      type: Number,
      min: 0
    },
    overstock_threshold: {
      type: Number,
      min: 0
    },
    enable_alerts: {
      type: Boolean,
      default: true
    },
    alert_recipients: [{
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    }]
  }
};

// 新增统计相关索引
beadMaterialSchema.index({ 'stats.popularity_score': -1, is_active: 1 });
beadMaterialSchema.index({ 'stats.turnover_rate': -1, is_active: 1 });
beadMaterialSchema.index({ 'stats.last_movement_date': -1, is_active: 1 });
```

## 数据聚合视图

### 1. 材料统计视图
```javascript
// 创建材料统计聚合管道
const materialStatsAggregation = [
  {
    $match: { is_active: true }
  },
  {
    $lookup: {
      from: 'inventory_records',
      localField: '_id',
      foreignField: 'material_id',
      as: 'inventory_records'
    }
  },
  {
    $addFields: {
      total_in: {
        $sum: {
          $map: {
            input: {
              $filter: {
                input: '$inventory_records',
                cond: { $eq: ['$$this.record_type', 'in'] }
              }
            },
            as: 'record',
            in: '$$record.quantity'
          }
        }
      },
      total_out: {
        $sum: {
          $map: {
            input: {
              $filter: {
                input: '$inventory_records',
                cond: { $eq: ['$$this.record_type', 'out'] }
              }
            },
            as: 'record',
            in: '$$record.quantity'
          }
        }
      }
    }
  },
  {
    $project: {
      name: 1,
      category_id: 1,
      price: 1,
      stock_quantity: 1,
      total_in: 1,
      total_out: 1,
      net_movement: { $subtract: ['$total_in', '$total_out'] },
      stock_value: { $multiply: ['$price', '$stock_quantity'] }
    }
  }
];
```

### 2. 分类统计视图
```javascript
// 创建分类统计聚合管道
const categoryStatsAggregation = [
  {
    $lookup: {
      from: 'bead_materials',
      localField: '_id',
      foreignField: 'category_id',
      as: 'materials'
    }
  },
  {
    $addFields: {
      material_count: { $size: '$materials' },
      total_stock_value: {
        $sum: {
          $map: {
            input: '$materials',
            as: 'material',
            in: { $multiply: ['$$material.price', '$$material.stock_quantity'] }
          }
        }
      },
      avg_price: {
        $avg: '$materials.price'
      },
      total_quantity: {
        $sum: '$materials.stock_quantity'
      }
    }
  },
  {
    $project: {
      name: 1,
      level: 1,
      parent_id: 1,
      material_count: 1,
      total_stock_value: 1,
      avg_price: 1,
      total_quantity: 1
    }
  }
];
```

## 定时任务配置

### 1. 数据快照生成任务
```javascript
// 每日快照生成
const dailySnapshotJob = {
  name: 'generate_daily_snapshot',
  schedule: '0 1 * * *', // 每天凌晨1点
  handler: async () => {
    // 生成每日数据快照
    await generateDataSnapshot('daily');
  }
};

// 每周快照生成
const weeklySnapshotJob = {
  name: 'generate_weekly_snapshot',
  schedule: '0 2 * * 1', // 每周一凌晨2点
  handler: async () => {
    // 生成每周数据快照
    await generateDataSnapshot('weekly');
  }
};

// 每月快照生成
const monthlySnapshotJob = {
  name: 'generate_monthly_snapshot',
  schedule: '0 3 1 * *', // 每月1号凌晨3点
  handler: async () => {
    // 生成每月数据快照
    await generateDataSnapshot('monthly');
  }
};
```

### 2. 库存预警检查任务
```javascript
// 库存预警检查
const stockAlertJob = {
  name: 'check_stock_alerts',
  schedule: '0 */2 * * *', // 每2小时检查一次
  handler: async () => {
    // 检查库存预警
    await checkStockAlerts();
  }
};
```

### 3. 数据清理任务
```javascript
// 过期数据清理
const dataCleanupJob = {
  name: 'cleanup_expired_data',
  schedule: '0 4 * * *', // 每天凌晨4点
  handler: async () => {
    // 清理过期报表
    await cleanupExpiredReports();
    
    // 清理过期预警
    await cleanupExpiredAlerts();
    
    // 清理过期性能指标
    await cleanupOldPerformanceMetrics();
  }
};
```

## 数据迁移脚本

### 1. 创建新集合和索引
```javascript
// 创建统计相关集合
db.createCollection("data_snapshots");
db.createCollection("reports");
db.createCollection("stock_alerts");
db.createCollection("analysis_tasks");
db.createCollection("performance_metrics");

// 创建索引
// 数据快照表索引
db.data_snapshots.createIndex({ "snapshot_date": -1, "snapshot_type": 1 });
db.data_snapshots.createIndex({ "snapshot_type": 1, "snapshot_date": -1 });

// 报表管理表索引
db.reports.createIndex({ "generated_by": 1, "createdAt": -1 });
db.reports.createIndex({ "report_type": 1, "generation_status": 1 });
db.reports.createIndex({ "expires_at": 1, "auto_delete": 1 });

// 库存预警表索引
db.stock_alerts.createIndex({ "material_id": 1, "alert_type": 1, "status": 1 });
db.stock_alerts.createIndex({ "alert_level": 1, "status": 1, "createdAt": -1 });
db.stock_alerts.createIndex({ "status": 1, "expires_at": 1 });

// 分析任务表索引
db.analysis_tasks.createIndex({ "created_by": 1, "createdAt": -1 });
db.analysis_tasks.createIndex({ "task_type": 1, "execution_status": 1 });
db.analysis_tasks.createIndex({ "is_scheduled": 1, "schedule_config.next_run_time": 1 });

// 性能监控表索引
db.performance_metrics.createIndex({ "metric_time": -1, "metric_type": 1 });
db.performance_metrics.createIndex({ "metric_type": 1, "metric_time": -1 });
```

### 2. 初始化统计数据
```javascript
// 生成初始数据快照
async function generateInitialSnapshot() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // 计算基础统计
  const totalMaterials = await db.bead_materials.countDocuments({ is_active: true });
  const totalCategories = await db.bead_categories.countDocuments({ is_active: true });
  
  // 计算库存总价值
  const stockValueResult = await db.bead_materials.aggregate([
    { $match: { is_active: true } },
    { $group: { 
      _id: null, 
      total_value: { $sum: { $multiply: ['$price', '$stock_quantity'] } },
      total_quantity: { $sum: '$stock_quantity' }
    }}
  ]).toArray();
  
  const snapshot = {
    snapshot_date: today,
    snapshot_type: 'daily',
    basic_stats: {
      total_materials: totalMaterials,
      active_materials: totalMaterials,
      total_categories: totalCategories,
      active_categories: totalCategories,
      total_stock_value: stockValueResult[0]?.total_value || 0,
      total_stock_quantity: stockValueResult[0]?.total_quantity || 0
    },
    generated_by: 'system',
    createdAt: new Date(),
    updatedAt: new Date()
  };
  
  await db.data_snapshots.insertOne(snapshot);
}

// 执行初始化
generateInitialSnapshot();
```

### 3. 扩展现有表结构
```javascript
// 为材料表添加统计字段
db.bead_materials.updateMany(
  {},
  {
    $set: {
      'stats.total_in_quantity': 0,
      'stats.total_out_quantity': 0,
      'stats.avg_monthly_usage': 0,
      'stats.turnover_rate': 0,
      'stats.popularity_score': 0,
      'alert_settings.enable_alerts': true
    }
  }
);

// 为库存记录表添加统计字段
db.inventory_records.updateMany(
  {},
  {
    $set: {
      'is_counted_in_stats': true
    }
  }
);
```

## 性能优化建议

### 1. 索引优化
- 为时间序列数据创建复合索引
- 使用部分索引减少索引大小
- 定期分析索引使用情况

### 2. 聚合优化
- 使用 `$match` 尽早过滤数据
- 合理使用 `$project` 减少数据传输
- 考虑使用预聚合数据

### 3. 存储优化
- 定期归档历史数据
- 使用数据压缩减少存储空间
- 合理设置TTL索引自动清理过期数据

### 4. 查询优化
- 使用适当的分页策略
- 实现查询结果缓存
- 优化复杂聚合查询

## 监控和维护

### 1. 数据质量监控
- 定期检查数据完整性
- 监控统计数据的准确性
- 验证聚合结果的正确性

### 2. 性能监控
- 监控查询执行时间
- 跟踪索引使用效率
- 监控存储空间增长

### 3. 定期维护
- 清理过期数据
- 重建索引优化性能
- 更新统计信息

## 注意事项

1. **数据一致性**: 确保统计数据与实际业务数据保持一致
2. **性能影响**: 统计计算可能影响系统性能，需要合理调度
3. **存储空间**: 历史数据会占用大量存储空间，需要制定清理策略
4. **并发控制**: 统计任务执行时需要考虑并发访问控制
5. **错误处理**: 统计任务失败时需要有重试和恢复机制