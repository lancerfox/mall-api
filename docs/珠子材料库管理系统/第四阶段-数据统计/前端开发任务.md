# 第四阶段 - 数据统计和可视化前端开发任务

## 任务概述

实现珠子材料库管理系统的数据统计和可视化前端功能，包括仪表盘、统计报表、数据可视化图表、报表生成和导出等功能。

## 技术栈说明

- **图表库**: ECharts 5.x
- **表格组件**: Element Plus Table
- **日期选择**: Element Plus DatePicker
- **文件下载**: 浏览器原生下载API
- **数据处理**: JavaScript原生方法 + Lodash工具库

## 项目结构规划

```
admin-mall/src/
├── views/
│   └── bead-material/
│       ├── dashboard/                    # 仪表盘模块
│       │   ├── index.vue                # 仪表盘主页面
│       │   └── components/              # 仪表盘组件
│       │       ├── StatsCards.vue       # 统计卡片
│       │       ├── TrendCharts.vue      # 趋势图表
│       │       ├── CategoryChart.vue    # 分类分布图
│       │       ├── StockAlerts.vue      # 库存预警
│       │       └── QuickActions.vue     # 快捷操作
│       ├── reports/                     # 报表模块
│       │   ├── index.vue                # 报表列表页面
│       │   ├── generator.vue            # 报表生成页面
│       │   └── components/              # 报表组件
│       │       ├── ReportForm.vue       # 报表生成表单
│       │       ├── ReportList.vue       # 报表列表
│       │       ├── ReportPreview.vue    # 报表预览
│       │       └── ExportDialog.vue     # 导出弹窗
│       └── analytics/                   # 数据分析模块
│           ├── index.vue                # 分析主页面
│           └── components/              # 分析组件
│               ├── TrendAnalysis.vue    # 趋势分析
│               ├── PredictionChart.vue  # 预测分析
│               ├── ComparisonChart.vue  # 对比分析
│               └── CustomChart.vue      # 自定义图表
├── components/
│   └── Charts/                          # 图表公共组件
│       ├── LineChart.vue                # 折线图组件
│       ├── BarChart.vue                 # 柱状图组件
│       ├── PieChart.vue                 # 饼图组件
│       ├── HeatmapChart.vue             # 热力图组件
│       └── MixedChart.vue               # 混合图表组件
└── utils/
    ├── chart-utils.ts                   # 图表工具函数
    ├── export-utils.ts                  # 导出工具函数
    └── date-utils.ts                    # 日期工具函数
```

## 详细开发任务

### 任务1: 创建图表公共组件 (预估时间: 8小时)

#### 1.1 折线图组件
**文件**: `src/components/Charts/LineChart.vue`

**组件功能**:
- 支持单线和多线显示
- 支持数据点标记和数值显示
- 支持缩放和数据筛选
- 支持自定义颜色和样式
- 支持数据为空时的占位显示

**Props接口**:
```typescript
interface LineChartProps {
  data: Array<{name: string, value: number, date?: string}>
  xAxisData?: string[]
  series?: Array<{name: string, data: number[], color?: string}>
  height?: string
  loading?: boolean
  showLegend?: boolean
  showGrid?: boolean
  smooth?: boolean
}
```

#### 1.2 柱状图组件
**文件**: `src/components/Charts/BarChart.vue`

**组件功能**:
- 支持垂直和水平柱状图
- 支持分组和堆叠显示
- 支持数据标签显示
- 支持点击事件处理
- 支持动画效果

**Props接口**:
```typescript
interface BarChartProps {
  data: Array<{name: string, value: number, category?: string}>
  direction?: 'vertical' | 'horizontal'
  stacked?: boolean
  showValues?: boolean
  height?: string
  colors?: string[]
}
```

#### 1.3 饼图组件
**文件**: `src/components/Charts/PieChart.vue`

**组件功能**:
- 支持饼图和环形图
- 支持百分比和数值显示
- 支持图例和标签配置
- 支持扇区点击事件
- 支持数据排序

**Props接口**:
```typescript
interface PieChartProps {
  data: Array<{name: string, value: number, percentage?: number}>
  radius?: [string, string]
  showPercentage?: boolean
  showLegend?: boolean
  legendPosition?: 'top' | 'bottom' | 'left' | 'right'
  height?: string
}
```

#### 1.4 混合图表组件
**文件**: `src/components/Charts/MixedChart.vue`

**组件功能**:
- 支持折线图和柱状图混合
- 支持双Y轴显示
- 支持不同数据类型组合
- 支持自定义图表配置
- 支持数据联动

**Props接口**:
```typescript
interface MixedChartProps {
  lineData?: Array<{name: string, data: number[]}>
  barData?: Array<{name: string, data: number[]}>
  xAxisData: string[]
  leftYAxis?: {name: string, unit?: string}
  rightYAxis?: {name: string, unit?: string}
  height?: string
}
```

### 任务2: 创建仪表盘页面 (预估时间: 10小时)

#### 2.1 仪表盘主页面
**文件**: `src/views/bead-material/dashboard/index.vue`

**页面功能**:
- 展示关键业务指标
- 显示实时数据统计
- 展示趋势分析图表
- 显示库存预警信息
- 提供快捷操作入口

**页面布局**:
- 顶部统计卡片区域
- 中部图表展示区域
- 右侧预警和快捷操作区域
- 底部详细数据表格

**使用的接口**:
- `POST /api/bead-material/dashboard/stats` - 获取统计数据
- `POST /api/bead-material/dashboard/alerts` - 获取预警信息
- `POST /api/bead-material/analytics/trends` - 获取趋势数据

#### 2.2 统计卡片组件
**文件**: `src/views/bead-material/dashboard/components/StatsCards.vue`

**组件功能**:
- 显示材料总数、分类总数等基础统计
- 显示库存总价值和变化趋势
- 显示今日/本月出入库统计
- 支持数据刷新和加载状态
- 支持点击跳转到详细页面

**显示字段**:
```typescript
interface StatsData {
  total_materials: number          // 材料总数
  total_categories: number         // 分类总数
  total_stock_value: number        // 库存总价值
  low_stock_materials: number      // 低库存材料数
  out_of_stock_materials: number   // 缺货材料数
  today_in_quantity: number        // 今日入库数量
  today_out_quantity: number       // 今日出库数量
  monthly_in_quantity: number      // 本月入库数量
  monthly_out_quantity: number     // 本月出库数量
}
```

#### 2.3 趋势图表组件
**文件**: `src/views/bead-material/dashboard/components/TrendCharts.vue`

**组件功能**:
- 显示库存价值变化趋势
- 显示出入库数量趋势
- 显示材料增长趋势
- 支持时间范围选择
- 支持图表类型切换

**图表配置**:
```typescript
interface TrendChartConfig {
  timeRange: '7d' | '30d' | '90d' | '1y'  // 时间范围
  chartType: 'line' | 'bar' | 'area'      // 图表类型
  metrics: string[]                        // 显示指标
  granularity: 'day' | 'week' | 'month'   // 时间粒度
}
```

#### 2.4 分类分布图组件
**文件**: `src/views/bead-material/dashboard/components/CategoryChart.vue`

**组件功能**:
- 显示各分类材料数量分布
- 显示各分类库存价值分布
- 支持饼图和柱状图切换
- 支持点击分类查看详情
- 支持数据排序和筛选

#### 2.5 库存预警组件
**文件**: `src/views/bead-material/dashboard/components/StockAlerts.vue`

**组件功能**:
- 显示低库存预警列表
- 显示缺货材料列表
- 支持预警级别筛选
- 支持快速补货操作
- 支持预警设置跳转

**预警数据字段**:
```typescript
interface AlertItem {
  material_id: string
  material_name: string
  current_quantity: number
  min_stock_level: number
  alert_level: 'warning' | 'critical'
  alert_message: string
  last_alert_time: string
}
```

### 任务3: 创建报表管理页面 (预估时间: 12小时)

#### 3.1 报表列表页面
**文件**: `src/views/bead-material/reports/index.vue`

**页面功能**:
- 显示已生成的报表列表
- 支持报表搜索和筛选
- 支持报表下载和预览
- 支持报表删除和管理
- 提供报表生成入口

**列表字段**:
```typescript
interface ReportItem {
  report_id: string
  report_name: string
  report_type: string
  file_size: string
  generated_by: string
  generated_at: string
  download_count: number
  status: 'generating' | 'completed' | 'failed'
  file_url?: string
}
```

**使用的接口**:
- `POST /api/bead-material/reports/list` - 获取报表列表
- `GET /api/bead-material/reports/download/:reportId` - 下载报表
- `POST /api/bead-material/reports/delete` - 删除报表

#### 3.2 报表生成页面
**文件**: `src/views/bead-material/reports/generator.vue`

**页面功能**:
- 提供报表类型选择
- 提供参数配置表单
- 支持报表模板选择
- 支持导出格式选择
- 显示生成进度和状态

**报表类型**:
- 库存价值报表
- 出入库明细报表
- 材料使用频率报表
- 库存预警报表
- 综合分析报表

#### 3.3 报表生成表单组件
**文件**: `src/views/bead-material/reports/components/ReportForm.vue`

**组件功能**:
- 动态表单配置
- 参数验证和提示
- 预览功能支持
- 模板选择功能
- 定时生成设置

**表单字段验证规则**:
```typescript
interface ReportFormData {
  report_type: string              // 报表类型
  report_name: string              // 报表名称
  start_date: string               // 开始日期
  end_date: string                 // 结束日期
  format: 'excel' | 'pdf' | 'csv'  // 导出格式
  template_id?: string             // 模板ID
  filters: {                       // 筛选条件
    category_ids?: string[]
    material_ids?: string[]
    price_range?: [number, number]
    stock_status?: string[]
  }
  schedule?: {                     // 定时设置
    enabled: boolean
    frequency: 'daily' | 'weekly' | 'monthly'
    time: string
  }
}

// Element Plus 表单验证规则
const reportFormRules = {
  report_type: [
    { required: true, message: '请选择报表类型', trigger: 'change' }
  ],
  report_name: [
    { required: true, message: '请输入报表名称', trigger: 'blur' },
    { min: 2, max: 50, message: '报表名称长度在 2 到 50 个字符', trigger: 'blur' },
    { pattern: /^[a-zA-Z0-9\u4e00-\u9fa5\-_\s]+$/, message: '报表名称只能包含字母、数字、中文、连字符、下划线和空格', trigger: 'blur' }
  ],
  start_date: [
    { required: true, message: '请选择开始日期', trigger: 'change' }
  ],
  end_date: [
    { required: true, message: '请选择结束日期', trigger: 'change' },
    {
      validator: (rule: any, value: string, callback: Function) => {
        const form = rule.fullField.split('.')[0];
        const startDate = new Date(form.start_date);
        const endDate = new Date(value);
        if (startDate && endDate && startDate > endDate) {
          callback(new Error('结束日期不能早于开始日期'));
        } else if (startDate && endDate) {
          const diffDays = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24);
          if (diffDays > 365) {
            callback(new Error('日期范围不能超过365天'));
          }
        }
        callback();
      },
      trigger: 'change'
    }
  ],
  format: [
    { required: true, message: '请选择导出格式', trigger: 'change' }
  ],
  'filters.category_ids': [
    {
      validator: (rule: any, value: string[], callback: Function) => {
        if (value && value.length > 50) {
          callback(new Error('最多只能选择50个分类'));
        }
        callback();
      },
      trigger: 'change'
    }
  ],
  'filters.material_ids': [
    {
      validator: (rule: any, value: string[], callback: Function) => {
        if (value && value.length > 100) {
          callback(new Error('最多只能选择100个材料'));
        }
        callback();
      },
      trigger: 'change'
    }
  ],
  'filters.price_range': [
    {
      validator: (rule: any, value: [number, number], callback: Function) => {
        if (value && value.length === 2) {
          const [min, max] = value;
          if (min < 0) {
            callback(new Error('价格不能为负数'));
          } else if (min >= max) {
            callback(new Error('最小价格不能大于等于最大价格'));
          } else if (max > 999999.99) {
            callback(new Error('价格不能超过999999.99'));
          }
        }
        callback();
      },
      trigger: 'change'
    }
  ],
  'schedule.frequency': [
    {
      validator: (rule: any, value: string, callback: Function) => {
        const form = rule.fullField.split('.')[0];
        if (form.schedule?.enabled && !value) {
          callback(new Error('启用定时生成时必须选择频率'));
        }
        callback();
      },
      trigger: 'change'
    }
  ],
  'schedule.time': [
    {
      validator: (rule: any, value: string, callback: Function) => {
        const form = rule.fullField.split('.')[0];
        if (form.schedule?.enabled && !value) {
          callback(new Error('启用定时生成时必须选择时间'));
        } else if (value && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value)) {
          callback(new Error('时间格式不正确，请使用 HH:mm 格式'));
        }
        callback();
      },
      trigger: 'blur'
    }
  ]
};
```

#### 3.4 报表预览组件
**文件**: `src/views/bead-material/reports/components/ReportPreview.vue`

**组件功能**:
- 报表数据预览
- 图表预览显示
- 分页数据展示
- 导出前确认
- 格式选择预览

### 任务4: 创建数据分析页面 (预估时间: 10小时)

#### 4.1 数据分析主页面
**文件**: `src/views/bead-material/analytics/index.vue`

**页面功能**:
- 提供多维度数据分析
- 支持自定义分析条件
- 显示趋势和预测分析
- 支持数据对比分析
- 提供分析结果导出

**分析模块**:
- 趋势分析模块
- 预测分析模块
- 对比分析模块
- 自定义分析模块

#### 4.2 趋势分析组件
**文件**: `src/views/bead-material/analytics/components/TrendAnalysis.vue`

**组件功能**:
- 库存价值趋势分析
- 出入库趋势分析
- 材料增长趋势分析
- 价格变动趋势分析
- 支持多指标对比

**分析配置**:
```typescript
interface TrendAnalysisConfig {
  metrics: string[]                        // 分析指标
  timeRange: {start: string, end: string}  // 时间范围
  granularity: 'day' | 'week' | 'month'   // 时间粒度
  categories?: string[]                    // 分类筛选
  comparison?: {                           // 对比设置
    enabled: boolean
    period: 'previous' | 'same_last_year'
  }
}
```

#### 4.3 预测分析组件
**文件**: `src/views/bead-material/analytics/components/PredictionChart.vue`

**组件功能**:
- 库存需求预测
- 价格趋势预测
- 库存周转预测
- 风险预警预测
- 预测准确度评估

#### 4.4 对比分析组件
**文件**: `src/views/bead-material/analytics/components/ComparisonChart.vue`

**组件功能**:
- 不同时期数据对比
- 不同分类数据对比
- 同比环比分析
- 多维度对比展示
- 对比结果解读

### 任务5: 创建工具函数 (预估时间: 6小时)

#### 5.1 图表工具函数
**文件**: `src/utils/chart-utils.ts`

**工具函数**:
```typescript
// 格式化图表数据
export function formatChartData(data: any[], config: ChartConfig): any

// 生成图表配置
export function generateChartOption(type: string, data: any[], config: any): any

// 图表颜色主题
export function getChartColors(theme: 'light' | 'dark'): string[]

// 数据聚合处理
export function aggregateData(data: any[], groupBy: string, aggregateBy: string): any[]

// 趋势计算
export function calculateTrend(data: number[]): {trend: 'up' | 'down' | 'stable', rate: number}
```

#### 5.2 导出工具函数
**文件**: `src/utils/export-utils.ts`

**工具函数**:
```typescript
// 下载文件
export function downloadFile(url: string, filename: string): void

// 导出Excel数据
export function exportToExcel(data: any[], filename: string): void

// 导出CSV数据
export function exportToCSV(data: any[], filename: string): void

// 生成PDF报表
export function generatePDF(element: HTMLElement, filename: string): void

// 图片导出
export function exportChartAsImage(chartInstance: any, filename: string): void
```

#### 5.3 日期工具函数
**文件**: `src/utils/date-utils.ts`

**工具函数**:
```typescript
// 格式化日期显示
export function formatDateForDisplay(date: string | Date, format?: string): string

// 获取时间范围
export function getDateRange(type: '7d' | '30d' | '90d' | '1y'): {start: string, end: string}

// 生成时间序列
export function generateDateSeries(start: string, end: string, granularity: string): string[]

// 计算时间差
export function calculateDateDiff(start: string, end: string, unit: string): number
```

### 任务6: 创建状态管理 (预估时间: 4小时)

#### 6.1 仪表盘状态管理
**文件**: `src/stores/modules/dashboard.ts`

**状态管理功能**:
```typescript
interface DashboardState {
  statsData: StatsData | null
  trendsData: TrendsData | null
  alertsData: AlertItem[]
  loading: boolean
  lastUpdateTime: string
}

// Actions
- fetchDashboardStats()     // 获取统计数据
- fetchTrendsData()         // 获取趋势数据
- fetchAlertsData()         // 获取预警数据
- refreshDashboard()        // 刷新仪表盘
```

#### 6.2 报表状态管理
**文件**: `src/stores/modules/reports.ts`

**状态管理功能**:
```typescript
interface ReportsState {
  reportsList: ReportItem[]
  currentReport: ReportItem | null
  generationProgress: number
  loading: boolean
}

// Actions
- fetchReportsList()        // 获取报表列表
- generateReport()          // 生成报表
- downloadReport()          // 下载报表
- deleteReport()            // 删除报表
```

### 任务7: 创建路由配置 (预估时间: 2小时)

#### 7.1 更新路由配置
**文件**: `src/router/modules/beadMaterial.ts`

**新增路由**:
```typescript
// 仪表盘路由
{
  path: 'dashboard',
  component: () => import('@/views/bead-material/dashboard/index.vue'),
  name: 'BeadMaterialDashboard',
  meta: { title: '数据仪表盘', icon: 'ep:data-analysis' }
}

// 报表管理路由
{
  path: 'reports',
  component: () => import('@/views/bead-material/reports/index.vue'),
  name: 'BeadMaterialReports',
  meta: { title: '报表管理', icon: 'ep:document' }
}

// 报表生成路由
{
  path: 'reports/generator',
  component: () => import('@/views/bead-material/reports/generator.vue'),
  name: 'BeadMaterialReportGenerator',
  meta: { title: '生成报表', hidden: true }
}

// 数据分析路由
{
  path: 'analytics',
  component: () => import('@/views/bead-material/analytics/index.vue'),
  name: 'BeadMaterialAnalytics',
  meta: { title: '数据分析', icon: 'ep:trend-charts' }
}
```

### 任务8: 响应式设计优化 (预估时间: 4小时)

#### 8.1 移动端适配
**适配内容**:
- 仪表盘卡片响应式布局
- 图表在小屏幕上的显示优化
- 表格在移动端的横向滚动
- 操作按钮的触摸友好设计

#### 8.2 图表响应式
**优化内容**:
- 图表尺寸自适应
- 图例位置动态调整
- 标签显示智能隐藏
- 工具提示优化

### 任务9: 性能优化 (预估时间: 4小时)

#### 9.1 数据加载优化
**优化策略**:
- 图表数据懒加载
- 大数据集分页处理
- 数据缓存机制
- 防抖和节流处理

#### 9.2 图表渲染优化
**优化策略**:
- 图表实例复用
- 数据更新而非重新渲染
- 动画效果优化
- 内存泄漏防护

### 任务10: 单元测试 (预估时间: 6小时)

#### 10.1 组件测试
**测试文件**: 
- `src/components/Charts/__tests__/LineChart.spec.ts`
- `src/views/bead-material/dashboard/__tests__/index.spec.ts`
- `src/views/bead-material/reports/__tests__/ReportForm.spec.ts`

**测试内容**:
- 组件渲染测试
- 数据处理逻辑测试
- 用户交互测试
- 异常情况处理测试

#### 10.2 工具函数测试
**测试文件**:
- `src/utils/__tests__/chart-utils.spec.ts`
- `src/utils/__tests__/export-utils.spec.ts`
- `src/utils/__tests__/date-utils.spec.ts`

**测试内容**:
- 数据格式化测试
- 计算逻辑测试
- 边界条件测试
- 错误处理测试

## 使用的Mock数据字段

### 仪表盘统计数据
```typescript
interface MockStatsData {
  total_materials: 1250
  total_categories: 45
  total_stock_value: 125000.50
  low_stock_materials: 23
  out_of_stock_materials: 5
  today_in_quantity: 150
  today_out_quantity: 89
  monthly_in_quantity: 3200
  monthly_out_quantity: 2800
  stock_value_trend: Array<{date: string, value: number}>
  category_distribution: Array<{
    category_id: string,
    category_name: string,
    material_count: number,
    percentage: number
  }>
}
```

### 趋势分析数据
```typescript
interface MockTrendsData {
  stock_value_trend: Array<{date: string, value: number}>
  inventory_movement_trend: Array<{
    date: string,
    in_quantity: number,
    out_quantity: number
  }>
  material_growth_trend: Array<{date: string, count: number}>
  price_trend: Array<{date: string, avg_price: number}>
}
```

### 报表列表数据
```typescript
interface MockReportsList {
  reports: Array<{
    report_id: string
    report_name: string
    report_type: 'stock_value' | 'inventory_detail' | 'material_usage'
    file_size: string
    generated_by: string
    generated_at: string
    download_count: number
    status: 'completed'
    file_url: string
  }>
  pagination: PaginationInfo
}
```

## 使用的接口列表

### 仪表盘相关接口
- `POST /api/bead-material/dashboard/stats` - 获取仪表盘统计数据
- `POST /api/bead-material/dashboard/alerts` - 获取库存预警数据
- `POST /api/bead-material/analytics/trends` - 获取趋势分析数据

### 报表相关接口
- `POST /api/bead-material/reports/list` - 获取报表列表
- `POST /api/bead-material/reports/generate` - 生成报表
- `GET /api/bead-material/reports/download/:reportId` - 下载报表
- `POST /api/bead-material/reports/delete` - 删除报表

### 数据分析接口
- `POST /api/bead-material/analytics/trends` - 趋势分析
- `POST /api/bead-material/analytics/predictions` - 预测分析
- `POST /api/bead-material/analytics/export` - 数据导出

## 验收标准

### 功能验收
1. ✅ 仪表盘数据展示完整准确
2. ✅ 图表交互功能正常
3. ✅ 报表生成和下载功能正常
4. ✅ 数据分析功能完整
5. ✅ 响应式布局适配良好
6. ✅ 性能表现符合要求

### 用户体验验收
1. ✅ 界面美观，操作流畅
2. ✅ 加载状态提示清晰
3. ✅ 错误处理友好
4. ✅ 移动端体验良好
5. ✅ 数据可视化效果佳

### 技术验收
1. ✅ 代码结构清晰，可维护性好
2. ✅ 组件复用性高
3. ✅ 性能优化到位
4. ✅ 测试覆盖率达标
5. ✅ 兼容性良好

## 预估总时间

**总计：66小时**

- 创建图表公共组件：8小时
- 创建仪表盘页面：10小时
- 创建报表管理页面：12小时
- 创建数据分析页面：10小时
- 创建工具函数：6小时
- 创建状态管理：4小时
- 创建路由配置：2小时
- 响应式设计优化：4小时
- 性能优化：4小时
- 单元测试：6小时