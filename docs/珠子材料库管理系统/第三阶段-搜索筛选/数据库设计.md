# 第三阶段 - 搜索筛选数据库设计

## 设计概述

第三阶段主要扩展搜索和筛选功能，需要新增搜索历史、保存的搜索条件、搜索统计等相关数据表，以及对现有表结构的索引优化。

## 新增数据表设计

### 1. 搜索历史表 (search_histories)

**表说明**: 记录用户的搜索历史，用于搜索建议和热门搜索统计

```javascript
// MongoDB Collection Schema
const searchHistorySchema = new mongoose.Schema({
  // 基础信息
  user_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },
  search_keyword: {
    type: String,
    required: true,
    maxlength: 100,
    trim: true,
    index: 'text'
  },
  search_type: {
    type: String,
    enum: ['material_name', 'category', 'description', 'comprehensive'],
    required: true,
    default: 'comprehensive'
  },
  
  // 搜索条件
  search_filters: {
    category_ids: [{
      type: mongoose.Schema.Types.ObjectId,
      ref: 'BeadCategory'
    }],
    price_range: {
      min: { type: Number, min: 0 },
      max: { type: Number, min: 0 }
    },
    stock_status: {
      type: String,
      enum: ['in_stock', 'low_stock', 'out_of_stock', 'all']
    },
    date_range: {
      start: Date,
      end: Date
    },
    sort_by: {
      type: String,
      enum: ['name', 'price', 'stock_quantity', 'created_at', 'updated_at']
    },
    sort_order: {
      type: String,
      enum: ['asc', 'desc'],
      default: 'asc'
    }
  },
  
  // 搜索结果统计
  result_count: {
    type: Number,
    min: 0,
    default: 0
  },
  search_duration: {
    type: Number, // 搜索耗时(毫秒)
    min: 0
  },
  
  // 用户行为
  clicked_results: [{
    material_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'BeadMaterial'
    },
    click_position: Number, // 点击位置
    clicked_at: {
      type: Date,
      default: Date.now
    }
  }],
  
  // 时间戳
  searched_at: {
    type: Date,
    default: Date.now,
    index: true
  }
}, {
  timestamps: true,
  collection: 'search_histories'
});

// 复合索引
searchHistorySchema.index({ user_id: 1, searched_at: -1 });
searchHistorySchema.index({ search_keyword: 1, searched_at: -1 });
searchHistorySchema.index({ search_type: 1, searched_at: -1 });
```

### 2. 保存的搜索条件表 (saved_searches)

**表说明**: 用户保存的搜索条件，支持快速重复搜索

```javascript
// MongoDB Collection Schema
const savedSearchSchema = new mongoose.Schema({
  // 基础信息
  user_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },
  search_name: {
    type: String,
    required: true,
    maxlength: 50,
    trim: true
  },
  description: {
    type: String,
    maxlength: 200,
    trim: true
  },
  
  // 搜索条件
  search_conditions: {
    keyword: {
      type: String,
      maxlength: 100,
      trim: true
    },
    search_type: {
      type: String,
      enum: ['material_name', 'category', 'description', 'comprehensive'],
      default: 'comprehensive'
    },
    filters: {
      category_ids: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'BeadCategory'
      }],
      price_range: {
        min: { type: Number, min: 0 },
        max: { type: Number, min: 0 }
      },
      stock_status: {
        type: String,
        enum: ['in_stock', 'low_stock', 'out_of_stock', 'all']
      },
      material_types: [String],
      colors: [String],
      sizes: [String],
      date_range: {
        start: Date,
        end: Date
      }
    },
    sort_config: {
      sort_by: {
        type: String,
        enum: ['name', 'price', 'stock_quantity', 'created_at', 'updated_at'],
        default: 'name'
      },
      sort_order: {
        type: String,
        enum: ['asc', 'desc'],
        default: 'asc'
      }
    }
  },
  
  // 使用统计
  usage_count: {
    type: Number,
    min: 0,
    default: 0
  },
  last_used_at: Date,
  
  // 共享设置
  is_public: {
    type: Boolean,
    default: false
  },
  shared_with: [{
    user_id: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    permission: {
      type: String,
      enum: ['view', 'edit'],
      default: 'view'
    },
    shared_at: {
      type: Date,
      default: Date.now
    }
  }],
  
  // 状态
  is_active: {
    type: Boolean,
    default: true
  }
}, {
  timestamps: true,
  collection: 'saved_searches'
});

// 复合索引
savedSearchSchema.index({ user_id: 1, is_active: 1 });
savedSearchSchema.index({ user_id: 1, usage_count: -1 });
savedSearchSchema.index({ is_public: 1, usage_count: -1 });
```

### 3. 搜索建议表 (search_suggestions)

**表说明**: 搜索建议和自动补全数据

```javascript
// MongoDB Collection Schema
const searchSuggestionSchema = new mongoose.Schema({
  // 建议内容
  suggestion_text: {
    type: String,
    required: true,
    maxlength: 100,
    trim: true,
    unique: true,
    index: 'text'
  },
  suggestion_type: {
    type: String,
    enum: ['material_name', 'category_name', 'brand', 'color', 'size', 'keyword'],
    required: true,
    index: true
  },
  
  // 关联信息
  related_material_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'BeadMaterial'
  },
  related_category_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'BeadCategory'
  },
  
  // 统计信息
  search_count: {
    type: Number,
    min: 0,
    default: 0,
    index: true
  },
  click_count: {
    type: Number,
    min: 0,
    default: 0
  },
  success_rate: {
    type: Number,
    min: 0,
    max: 1,
    default: 0
  },
  
  // 权重和排序
  weight: {
    type: Number,
    min: 0,
    max: 100,
    default: 1
  },
  priority: {
    type: Number,
    min: 0,
    max: 10,
    default: 5
  },
  
  // 状态
  is_active: {
    type: Boolean,
    default: true,
    index: true
  },
  is_auto_generated: {
    type: Boolean,
    default: true
  },
  
  // 时间信息
  last_searched_at: Date,
  expires_at: Date
}, {
  timestamps: true,
  collection: 'search_suggestions'
});

// 复合索引
searchSuggestionSchema.index({ suggestion_type: 1, is_active: 1, weight: -1 });
searchSuggestionSchema.index({ search_count: -1, is_active: 1 });
searchSuggestionSchema.index({ suggestion_text: 'text', suggestion_type: 1 });
```

### 4. 搜索统计表 (search_statistics)

**表说明**: 搜索行为统计数据，用于分析和优化

```javascript
// MongoDB Collection Schema
const searchStatisticsSchema = new mongoose.Schema({
  // 统计维度
  stat_date: {
    type: Date,
    required: true,
    index: true
  },
  stat_type: {
    type: String,
    enum: ['daily', 'weekly', 'monthly'],
    required: true,
    index: true
  },
  
  // 搜索统计
  total_searches: {
    type: Number,
    min: 0,
    default: 0
  },
  unique_users: {
    type: Number,
    min: 0,
    default: 0
  },
  avg_search_duration: {
    type: Number,
    min: 0,
    default: 0
  },
  
  // 热门搜索
  top_keywords: [{
    keyword: String,
    search_count: Number,
    result_count: Number
  }],
  
  // 搜索类型分布
  search_type_distribution: {
    material_name: { type: Number, default: 0 },
    category: { type: Number, default: 0 },
    description: { type: Number, default: 0 },
    comprehensive: { type: Number, default: 0 }
  },
  
  // 结果统计
  zero_result_searches: {
    type: Number,
    min: 0,
    default: 0
  },
  avg_result_count: {
    type: Number,
    min: 0,
    default: 0
  },
  
  // 用户行为
  click_through_rate: {
    type: Number,
    min: 0,
    max: 1,
    default: 0
  },
  bounce_rate: {
    type: Number,
    min: 0,
    max: 1,
    default: 0
  },
  
  // 筛选使用统计
  filter_usage: {
    category_filter: { type: Number, default: 0 },
    price_filter: { type: Number, default: 0 },
    stock_filter: { type: Number, default: 0 },
    date_filter: { type: Number, default: 0 }
  }
}, {
  timestamps: true,
  collection: 'search_statistics'
});

// 复合索引
searchStatisticsSchema.index({ stat_date: -1, stat_type: 1 });
searchStatisticsSchema.index({ stat_type: 1, stat_date: -1 });
```

## 现有表结构优化

### 1. 材料表 (bead_materials) 索引优化

```javascript
// 新增搜索相关索引
beadMaterialSchema.index({ 
  name: 'text', 
  description: 'text', 
  material_type: 'text',
  color: 'text',
  brand: 'text'
}, {
  weights: {
    name: 10,
    material_type: 5,
    color: 3,
    brand: 3,
    description: 1
  },
  name: 'material_search_index'
});

// 筛选相关复合索引
beadMaterialSchema.index({ category_id: 1, price: 1, stock_quantity: 1 });
beadMaterialSchema.index({ price: 1, stock_quantity: 1, is_active: 1 });
beadMaterialSchema.index({ created_at: -1, is_active: 1 });
beadMaterialSchema.index({ updated_at: -1, is_active: 1 });
beadMaterialSchema.index({ stock_quantity: 1, is_active: 1 });
```

### 2. 分类表 (bead_categories) 索引优化

```javascript
// 新增搜索相关索引
beadCategorySchema.index({ 
  name: 'text', 
  description: 'text' 
}, {
  weights: {
    name: 10,
    description: 1
  },
  name: 'category_search_index'
});

// 层级查询优化索引
beadCategorySchema.index({ parent_id: 1, sort_order: 1, is_active: 1 });
beadCategorySchema.index({ level: 1, is_active: 1 });
```

## 数据表关系图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  search_histories│    │  saved_searches │    │search_suggestions│
│                 │    │                 │    │                 │
│ - user_id       │    │ - user_id       │    │ - suggestion_text│
│ - search_keyword│    │ - search_name   │    │ - suggestion_type│
│ - search_filters│    │ - search_conditions│ │ - search_count  │
│ - result_count  │    │ - usage_count   │    │ - weight        │
│ - clicked_results│   │ - is_public     │    │ - is_active     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │search_statistics│
                    │                 │
                    │ - stat_date     │
                    │ - total_searches│
                    │ - top_keywords  │
                    │ - click_through_rate│
                    └─────────────────┘
```

## 性能优化策略

### 1. 索引策略
- **文本搜索索引**: 为材料名称、描述等字段创建全文索引
- **复合索引**: 为常用的筛选条件组合创建复合索引
- **稀疏索引**: 为可选字段创建稀疏索引节省空间

### 2. 查询优化
- **分页查询**: 使用 skip + limit 进行分页，大数据量时考虑游标分页
- **聚合管道**: 复杂统计查询使用 MongoDB 聚合管道
- **缓存策略**: 热门搜索结果和统计数据使用 Redis 缓存

### 3. 数据清理
- **历史数据清理**: 定期清理过期的搜索历史数据
- **统计数据归档**: 按时间维度归档统计数据
- **建议数据更新**: 定期更新搜索建议的权重和活跃状态

## 数据迁移脚本

### 1. 创建新集合
```javascript
// 创建搜索历史集合
db.createCollection("search_histories");

// 创建保存的搜索集合
db.createCollection("saved_searches");

// 创建搜索建议集合
db.createCollection("search_suggestions");

// 创建搜索统计集合
db.createCollection("search_statistics");
```

### 2. 初始化搜索建议数据
```javascript
// 从现有材料数据生成搜索建议
db.bead_materials.aggregate([
  { $match: { is_active: true } },
  { $group: { 
    _id: "$name", 
    count: { $sum: 1 },
    material_id: { $first: "$_id" }
  }},
  { $project: {
    suggestion_text: "$_id",
    suggestion_type: "material_name",
    related_material_id: "$material_id",
    search_count: "$count",
    weight: { $min: [{ $multiply: ["$count", 10] }, 100] },
    is_active: true,
    is_auto_generated: true,
    createdAt: new Date(),
    updatedAt: new Date()
  }},
  { $out: "temp_material_suggestions" }
]);

// 插入到搜索建议表
db.temp_material_suggestions.find().forEach(function(doc) {
  db.search_suggestions.insertOne(doc);
});

// 清理临时集合
db.temp_material_suggestions.drop();
```

### 3. 创建索引
```javascript
// 搜索历史表索引
db.search_histories.createIndex({ "user_id": 1, "searched_at": -1 });
db.search_histories.createIndex({ "search_keyword": "text" });
db.search_histories.createIndex({ "search_type": 1, "searched_at": -1 });

// 保存的搜索表索引
db.saved_searches.createIndex({ "user_id": 1, "is_active": 1 });
db.saved_searches.createIndex({ "user_id": 1, "usage_count": -1 });

// 搜索建议表索引
db.search_suggestions.createIndex({ "suggestion_text": "text", "suggestion_type": 1 });
db.search_suggestions.createIndex({ "suggestion_type": 1, "is_active": 1, "weight": -1 });

// 搜索统计表索引
db.search_statistics.createIndex({ "stat_date": -1, "stat_type": 1 });

// 材料表搜索索引
db.bead_materials.createIndex({ 
  "name": "text", 
  "description": "text", 
  "material_type": "text",
  "color": "text",
  "brand": "text"
}, {
  weights: {
    name: 10,
    material_type: 5,
    color: 3,
    brand: 3,
    description: 1
  },
  name: "material_search_index"
});
```

## 验证和测试

### 1. 数据完整性验证
```javascript
// 验证索引创建
db.search_histories.getIndexes();
db.saved_searches.getIndexes();
db.search_suggestions.getIndexes();
db.search_statistics.getIndexes();

// 验证数据插入
db.search_suggestions.countDocuments({ is_auto_generated: true });
```

### 2. 性能测试
```javascript
// 测试文本搜索性能
db.bead_materials.find({ $text: { $search: "水晶" } }).explain("executionStats");

// 测试复合查询性能
db.bead_materials.find({ 
  category_id: ObjectId("..."), 
  price: { $gte: 10, $lte: 100 },
  stock_quantity: { $gt: 0 }
}).explain("executionStats");
```

## 注意事项

1. **索引维护**: 定期监控索引使用情况，删除未使用的索引
2. **数据一致性**: 确保搜索建议数据与实际材料数据保持同步
3. **性能监控**: 监控搜索查询的执行时间和资源消耗
4. **数据隐私**: 搜索历史数据涉及用户隐私，需要合规处理
5. **存储空间**: 定期清理历史数据，控制存储空间增长