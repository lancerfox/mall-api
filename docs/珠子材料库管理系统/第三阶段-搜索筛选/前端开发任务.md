# 第三阶段 - 高级搜索筛选前端开发任务

## 任务概述

实现珠子材料库管理系统的高级搜索和筛选功能前端界面，包括多条件搜索、搜索条件保存、搜索历史管理等功能。

## 项目结构扩展

```
admin-mall/src/
├── views/bead-material/
│   └── search/                          # 搜索模块
│       ├── index.vue                    # 高级搜索主页面
│       ├── saved-searches.vue           # 保存的搜索条件页面
│       ├── search-history.vue           # 搜索历史页面
│       └── components/                  # 搜索相关组件
│           ├── AdvancedSearchForm.vue   # 高级搜索表单
│           ├── SearchFilters.vue        # 搜索过滤器组件
│           ├── SearchSuggestions.vue    # 搜索建议组件
│           ├── SavedSearchCard.vue      # 保存搜索卡片组件
│           ├── SearchHistoryItem.vue    # 搜索历史项组件
│           ├── FilterPanel.vue          # 过滤面板组件
│           ├── SearchResults.vue        # 搜索结果组件
│           └── QuickFilters.vue         # 快速过滤器组件
├── api/bead-material/
│   └── search.ts                        # 搜索相关接口
├── stores/modules/
│   └── search.ts                        # 搜索状态管理
└── components/Search/                   # 通用搜索组件
    ├── SearchInput.vue                  # 搜索输入框组件
    ├── FilterTag.vue                    # 过滤标签组件
    └── SearchResultCard.vue             # 搜索结果卡片组件
```

## 详细开发任务

### 任务1: 扩展搜索API接口层 (预估时间: 3小时)

#### 1.1 搜索接口文件
**文件**: `src/api/bead-material/search.ts`

**需要实现的接口**:
- `advancedSearchApi()` - 高级搜索
- `getSearchSuggestionsApi()` - 获取搜索建议
- `saveSearchApi()` - 保存搜索条件
- `getSavedSearchesApi()` - 获取保存的搜索条件
- `deleteSavedSearchApi()` - 删除保存的搜索条件
- `getSearchHistoryApi()` - 获取搜索历史
- `clearSearchHistoryApi()` - 清空搜索历史
- `getSearchFiltersApi()` - 获取搜索过滤器配置
- `getPopularSearchesApi()` - 获取热门搜索

**使用的后端接口**:
- `POST /api/bead-material/search/advanced`
- `POST /api/bead-material/search/suggestions`
- `POST /api/bead-material/search/save`
- `POST /api/bead-material/search/saved-list`
- `POST /api/bead-material/search/history`
- `POST /api/bead-material/search/filters`

#### 1.2 搜索类型定义扩展
**文件**: `src/api/bead-material/types.ts`

**新增类型定义**:
```typescript
// 高级搜索参数
interface AdvancedSearchParams {
  keyword?: string
  category_ids?: string[]
  price_range?: { min: number, max: number }
  stock_range?: { min: number, max: number }
  stock_status?: string
  is_active?: boolean
  properties?: Record<string, any>
  date_range?: { start: string, end: string }
  sort_fields?: Array<{ field: string, order: 'asc' | 'desc' }>
  page?: number
  page_size?: number
}

// 搜索结果
interface SearchResult {
  data: BeadMaterial[]
  pagination: PaginationResponse
  aggregations: {
    total_count: number
    category_counts: Array<{ category_id: string, count: number }>
    price_ranges: Array<{ range: string, count: number }>
    stock_status_counts: Record<string, number>
  }
}

// 搜索建议
interface SearchSuggestion {
  text: string
  type: 'material' | 'category' | 'property'
  count: number
}

// 保存的搜索条件
interface SavedSearch {
  _id: string
  name: string
  search_params: Record<string, any>
  usage_count: number
  last_used_at?: string
  is_public: boolean
  tags: string[]
  created_at: string
}

// 搜索历史
interface SearchHistory {
  search_params: Record<string, any>
  result_count: number
  search_time: number
  created_at: string
}

// 过滤器配置
interface FilterConfig {
  type: string
  label: string
  field: string
  options?: Array<{
    label: string
    value: any
    count?: number
  }>
  range?: {
    min: number
    max: number
    step: number
  }
  multiple: boolean
  required: boolean
}
```

### 任务2: 创建搜索状态管理 (预估时间: 3小时)

#### 2.1 搜索Store
**文件**: `src/stores/modules/search.ts`

**状态管理内容**:
- 当前搜索参数
- 搜索结果数据
- 搜索建议列表
- 保存的搜索条件
- 搜索历史记录
- 过滤器配置
- 搜索加载状态

**需要实现的方法**:
- `performAdvancedSearch()` - 执行高级搜索
- `getSearchSuggestions()` - 获取搜索建议
- `saveCurrentSearch()` - 保存当前搜索条件
- `loadSavedSearch()` - 加载保存的搜索条件
- `deleteSavedSearch()` - 删除保存的搜索条件
- `fetchSearchHistory()` - 获取搜索历史
- `clearSearchHistory()` - 清空搜索历史
- `fetchFilterConfigs()` - 获取过滤器配置
- `updateSearchParams()` - 更新搜索参数
- `resetSearch()` - 重置搜索条件

**计算属性**:
- `activeFilters` - 当前激活的过滤器
- `searchSummary` - 搜索条件摘要
- `hasSearchResults` - 是否有搜索结果
- `filterCounts` - 过滤器统计数量

### 任务3: 扩展路由配置 (预估时间: 1小时)

#### 3.1 新增搜索路由
**文件**: `src/router/modules/beadMaterial.ts`

**新增路由**:
- `/bead-material/search` - 高级搜索页面
- `/bead-material/search/saved` - 保存的搜索条件页面
- `/bead-material/search/history` - 搜索历史页面

### 任务4: 创建高级搜索主页面 (预估时间: 8小时)

#### 4.1 高级搜索主页面
**文件**: `src/views/bead-material/search/index.vue`

**页面功能**:
- 高级搜索表单
- 搜索结果展示
- 过滤器面板
- 搜索条件保存
- 搜索结果导出

**页面布局**:
- 顶部：搜索输入框和快速过滤器
- 左侧：详细过滤器面板
- 右侧：搜索结果列表
- 底部：分页导航

**使用的接口**:
- 高级搜索接口
- 获取过滤器配置接口
- 保存搜索条件接口

#### 4.2 高级搜索表单组件
**文件**: `src/views/bead-material/search/components/AdvancedSearchForm.vue`

**组件功能**:
- 关键词输入（支持搜索建议）
- 分类多选（树形选择器）
- 价格范围滑块
- 库存范围输入
- 库存状态选择
- 材料属性筛选
- 时间范围选择
- 排序方式选择

#### 4.3 搜索表单字段验证规则

| 字段名 | 验证规则 | 错误提示 | 备注 |
|--------|----------|----------|------|
| **keyword** | `{ max: 100, message: '关键词不能超过100个字符', trigger: 'blur' }` | 关键词不能超过100个字符 | 可选字段，支持模糊搜索 |
| **category_ids** | `{ type: 'array', max: 50, message: '最多只能选择50个分类', trigger: 'change' }` | 最多只能选择50个分类 | 多选分类，支持树形结构 |
| **price_range.min** | `{ type: 'number', min: 0, max: 999999.99, message: '最低价格必须在0-999999.99之间', trigger: 'blur' }` | 最低价格必须在0-999999.99之间 | 价格范围最小值 |
| **price_range.max** | `{ type: 'number', min: 0, max: 999999.99, message: '最高价格必须在0-999999.99之间', trigger: 'blur' }` | 最高价格必须在0-999999.99之间 | 价格范围最大值 |
| **stock_range.min** | `{ type: 'integer', min: 0, max: 999999, message: '最小库存必须在0-999999之间', trigger: 'blur' }` | 最小库存必须在0-999999之间 | 库存范围最小值 |
| **stock_range.max** | `{ type: 'integer', min: 0, max: 999999, message: '最大库存必须在0-999999之间', trigger: 'blur' }` | 最大库存必须在0-999999之间 | 库存范围最大值 |
| **stock_status** | `{ type: 'array', message: '库存状态必须是数组', trigger: 'change' }` | 请选择库存状态 | 多选枚举：normal/low/out |
| **is_active** | `{ type: 'boolean', message: '启用状态必须是布尔值', trigger: 'change' }` | 启用状态格式不正确 | 布尔值选择 |
| **date_range.start** | `{ type: 'date', message: '开始日期格式不正确', trigger: 'change' }` | 开始日期格式不正确 | 日期选择器 |
| **date_range.end** | `{ type: 'date', message: '结束日期格式不正确', trigger: 'change' }` | 结束日期格式不正确 | 日期选择器 |
| **sort_fields** | `{ type: 'array', max: 5, message: '最多只能设置5个排序字段', trigger: 'change' }` | 最多只能设置5个排序字段 | 排序配置数组 |
| **search_mode** | `{ type: 'enum', enum: ['exact', 'fuzzy', 'wildcard'], message: '搜索模式不正确', trigger: 'change' }` | 搜索模式不正确 | 搜索模式选择 |
| **tags** | `{ type: 'array', max: 20, message: '最多只能选择20个标签', trigger: 'change' }` | 最多只能选择20个标签 | 标签多选 |

#### 4.4 自定义验证函数
```typescript
// 价格范围验证
const validatePriceRange = (rule: any, value: any, callback: any) => {
  if (value && value.min !== undefined && value.max !== undefined) {
    if (value.min > value.max) {
      callback(new Error('最低价格不能大于最高价格'));
    }
  }
  callback();
};

// 库存范围验证
const validateStockRange = (rule: any, value: any, callback: any) => {
  if (value && value.min !== undefined && value.max !== undefined) {
    if (value.min > value.max) {
      callback(new Error('最小库存不能大于最大库存'));
    }
  }
  callback();
};

// 日期范围验证
const validateDateRange = (rule: any, value: any, callback: any) => {
  if (value && value.start && value.end) {
    if (new Date(value.start) > new Date(value.end)) {
      callback(new Error('开始日期不能大于结束日期'));
    }
  }
  callback();
};

// 分类ID验证
const validateCategoryIds = (rule: any, value: any, callback: any) => {
  if (value && Array.isArray(value)) {
    const invalidIds = value.filter(id => !/^[0-9a-fA-F]{24}$/.test(id));
    if (invalidIds.length > 0) {
      callback(new Error('分类ID格式不正确'));
    }
  }
  callback();
};

// 排序字段验证
const validateSortFields = (rule: any, value: any, callback: any) => {
  if (value && Array.isArray(value)) {
    const validFields = ['name', 'price', 'size', 'stock_quantity', 'created_at', 'updated_at'];
    const invalidFields = value.filter(item => !validFields.includes(item.field));
    if (invalidFields.length > 0) {
      callback(new Error('排序字段不正确'));
    }
  }
  callback();
};
```

#### 4.5 保存搜索条件表单验证规则

| 字段名 | 验证规则 | 错误提示 | 备注 |
|--------|----------|----------|------|
| **name** | `{ required: true, message: '搜索名称不能为空', trigger: 'blur' }, { min: 1, max: 50, message: '搜索名称长度必须在1-50个字符之间', trigger: 'blur' }, { pattern: /^[\u4e00-\u9fa5a-zA-Z0-9\s\-_()（）]+$/, message: '搜索名称只能包含中文、英文、数字、空格、连字符、下划线和括号', trigger: 'blur' }` | 请输入搜索名称 | 必填字段，支持中英文 |
| **description** | `{ max: 200, message: '搜索描述不能超过200个字符', trigger: 'blur' }` | 搜索描述不能超过200个字符 | 可选字段 |
| **is_public** | `{ type: 'boolean', message: '是否公开必须是布尔值', trigger: 'change' }` | 公开状态格式不正确 | 布尔值选择 |
| **tags** | `{ type: 'array', max: 10, message: '最多只能添加10个标签', trigger: 'change' }` | 最多只能添加10个标签 | 标签数组 |

**表单字段**:
- 关键词搜索框（带自动补全）
- 分类选择器（支持多选）
- 价格范围滑块（双向滑块）
- 库存数量范围输入
- 库存状态多选框
- 启用状态选择
- 创建时间范围选择器
- 排序字段和方向选择

#### 4.3 搜索过滤器组件
**文件**: `src/views/bead-material/search/components/SearchFilters.vue`

**组件功能**:
- 动态过滤器渲染
- 过滤器折叠/展开
- 过滤器重置
- 过滤器统计显示

**过滤器类型**:
- 单选过滤器
- 多选过滤器
- 范围过滤器
- 日期过滤器
- 自定义属性过滤器

#### 4.4 搜索建议组件
**文件**: `src/views/bead-material/search/components/SearchSuggestions.vue`

**组件功能**:
- 实时搜索建议
- 历史搜索记录
- 热门搜索推荐
- 搜索建议分类显示

**建议类型**:
- 材料名称建议
- 分类名称建议
- 属性值建议
- 历史搜索建议

#### 4.5 搜索结果组件
**文件**: `src/views/bead-material/search/components/SearchResults.vue`

**组件功能**:
- 搜索结果列表展示
- 结果排序功能
- 结果筛选统计
- 结果详情查看
- 批量操作功能

**结果展示模式**:
- 列表模式（详细信息）
- 卡片模式（图片展示）
- 表格模式（数据对比）

### 任务5: 创建过滤器面板 (预估时间: 5小时)

#### 5.1 过滤面板组件
**文件**: `src/views/bead-material/search/components/FilterPanel.vue`

**组件功能**:
- 过滤器分组展示
- 过滤器搜索功能
- 过滤器应用状态
- 过滤器清除功能

**过滤器分组**:
- 基础信息过滤器
- 价格和库存过滤器
- 材料属性过滤器
- 时间相关过滤器

#### 5.2 快速过滤器组件
**文件**: `src/views/bead-material/search/components/QuickFilters.vue`

**组件功能**:
- 常用过滤条件快捷按钮
- 过滤器标签显示
- 快速清除功能
- 过滤器组合保存

**快速过滤器**:
- 库存状态快速筛选
- 价格区间快速筛选
- 热门分类快速筛选
- 最近添加快速筛选

### 任务6: 创建保存搜索页面 (预估时间: 4小时)

#### 6.1 保存搜索主页面
**文件**: `src/views/bead-material/search/saved-searches.vue`

**页面功能**:
- 保存的搜索条件列表
- 搜索条件使用统计
- 搜索条件编辑
- 搜索条件分享
- 搜索条件删除

**列表字段**:
- 搜索条件名称
- 搜索参数摘要
- 使用次数
- 最后使用时间
- 是否公开
- 标签
- 操作按钮

**使用的接口**:
- 获取保存的搜索条件
- 删除保存的搜索条件
- 使用保存的搜索条件

#### 6.2 保存搜索卡片组件
**文件**: `src/views/bead-material/search/components/SavedSearchCard.vue`

**组件功能**:
- 搜索条件信息展示
- 搜索条件快速使用
- 搜索条件编辑
- 搜索条件分享

### 任务7: 创建搜索历史页面 (预估时间: 3小时)

#### 7.1 搜索历史主页面
**文件**: `src/views/bead-material/search/search-history.vue`

**页面功能**:
- 搜索历史记录列表
- 历史搜索重新执行
- 搜索历史统计
- 搜索历史清理

**历史记录字段**:
- 搜索参数摘要
- 搜索结果数量
- 搜索耗时
- 搜索时间
- 重新搜索按钮

**使用的接口**:
- 获取搜索历史
- 清空搜索历史

#### 7.2 搜索历史项组件
**文件**: `src/views/bead-material/search/components/SearchHistoryItem.vue`

**组件功能**:
- 历史搜索信息展示
- 快速重新搜索
- 历史搜索保存为条件

### 任务8: 创建通用搜索组件 (预估时间: 4小时)

#### 8.1 搜索输入框组件
**文件**: `src/components/Search/SearchInput.vue`

**组件功能**:
- 智能搜索输入
- 搜索建议下拉
- 搜索历史显示
- 搜索快捷键支持

#### 8.2 过滤标签组件
**文件**: `src/components/Search/FilterTag.vue`

**组件功能**:
- 过滤条件标签展示
- 标签删除功能
- 标签编辑功能
- 标签样式自定义

#### 8.3 搜索结果卡片组件
**文件**: `src/components/Search/SearchResultCard.vue`

**组件功能**:
- 搜索结果卡片展示
- 结果高亮显示
- 快速操作按钮
- 详情查看链接

### 任务9: 优化现有页面搜索功能 (预估时间: 3小时)

#### 9.1 材料管理页面搜索优化
**文件**: `src/views/bead-material/materials/index.vue`

**优化内容**:
- 集成高级搜索组件
- 添加搜索条件保存功能
- 优化搜索体验
- 添加搜索结果统计

#### 9.2 分类管理页面搜索优化
**文件**: `src/views/bead-material/categories/index.vue`

**优化内容**:
- 添加分类搜索功能
- 支持分类树搜索
- 添加搜索高亮

### 任务10: 搜索性能优化 (预估时间: 2小时)

#### 10.1 搜索防抖优化
- 搜索输入防抖处理
- 搜索建议请求优化
- 搜索结果缓存

#### 10.2 搜索体验优化
- 搜索加载状态优化
- 搜索结果渐进加载
- 搜索错误处理优化

## Mock数据字段

### 搜索结果Mock数据
```json
{
  "data": [
    {
      "_id": "507f1f77bcf86cd799439012",
      "name": "白水晶",
      "category_name": "水晶类",
      "price": 15.5,
      "stock_quantity": 100,
      "stock_status": "normal",
      "highlight": {
        "name": "<em>白水晶</em>",
        "description": "纯净的<em>白水晶</em>珠子"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 25,
    "total_pages": 2
  },
  "aggregations": {
    "total_count": 25,
    "category_counts": [
      {"category_id": "1", "count": 15},
      {"category_id": "2", "count": 10}
    ],
    "price_ranges": [
      {"range": "0-50", "count": 20},
      {"range": "50-100", "count": 5}
    ],
    "stock_status_counts": {
      "normal": 20,
      "low": 3,
      "out": 2
    }
  }
}
```

### 搜索建议Mock数据
```json
{
  "suggestions": [
    {
      "text": "白水晶",
      "type": "material",
      "count": 15
    },
    {
      "text": "水晶类",
      "type": "category",
      "count": 25
    }
  ],
  "popular_searches": ["水晶", "玛瑙", "珍珠"],
  "related_searches": ["透明水晶", "白色珠子", "天然水晶"]
}
```

### 保存搜索Mock数据
```json
{
  "_id": "507f1f77bcf86cd799439014",
  "name": "低库存水晶类材料",
  "search_params": {
    "category_ids": ["1"],
    "stock_status": "low",
    "is_active": true
  },
  "usage_count": 15,
  "last_used_at": "2024-01-01T11:00:00.000Z",
  "is_public": false,
  "tags": ["库存管理", "水晶"],
  "created_at": "2024-01-01T10:00:00.000Z"
}
```

### 过滤器配置Mock数据
```json
{
  "categories": {
    "type": "select",
    "label": "材料分类",
    "field": "category_id",
    "options": [
      {"label": "水晶类", "value": "1", "count": 25},
      {"label": "玛瑙类", "value": "2", "count": 20}
    ],
    "multiple": true,
    "required": false
  },
  "price_ranges": {
    "type": "range",
    "label": "价格范围",
    "field": "price",
    "range": {"min": 0, "max": 1000, "step": 10},
    "multiple": false,
    "required": false
  }
}
```

## 验收标准

### 功能验收
1. ✅ 高级搜索功能完整可用
2. ✅ 搜索建议准确及时
3. ✅ 搜索条件保存和使用正常
4. ✅ 搜索历史记录完整
5. ✅ 过滤器功能正常工作
6. ✅ 搜索结果展示清晰
7. ✅ 搜索性能良好

### 界面验收
1. ✅ 搜索界面布局合理
2. ✅ 过滤器操作便捷
3. ✅ 搜索结果展示美观
4. ✅ 搜索状态反馈及时
5. ✅ 响应式适配良好

### 用户体验验收
1. ✅ 搜索操作流畅自然
2. ✅ 搜索建议智能准确
3. ✅ 搜索结果加载快速
4. ✅ 错误提示友好明确
5. ✅ 搜索历史管理便利

## 预估总时间

**总计：36小时**

- 扩展搜索API接口层：3小时
- 创建搜索状态管理：3小时
- 扩展路由配置：1小时
- 创建高级搜索主页面：8小时
- 创建过滤器面板：5小时
- 创建保存搜索页面：4小时
- 创建搜索历史页面：3小时
- 创建通用搜索组件：4小时
- 优化现有页面搜索功能：3小时
- 搜索性能优化：2小时

## 开发注意事项

1. **搜索性能**: 实现搜索防抖，避免频繁请求
2. **用户体验**: 搜索建议要及时准确，加载状态要明确
3. **数据缓存**: 合理缓存搜索结果和过滤器配置
4. **搜索准确性**: 确保搜索结果的相关性和准确性
5. **界面响应**: 大量搜索结果要支持虚拟滚动
6. **搜索历史**: 保护用户隐私，提供历史清理功能
7. **过滤器状态**: 过滤器状态要与URL同步，支持分享和书签