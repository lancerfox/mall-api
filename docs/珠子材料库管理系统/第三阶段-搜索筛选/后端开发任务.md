# 第三阶段 - 高级搜索筛选后端开发任务

## 任务概述

实现珠子材料库管理系统的高级搜索和筛选功能，包括多条件组合搜索、搜索条件保存、全文搜索优化等功能。

## 开发任务

### 任务1: 扩展搜索数据模型 (预估时间: 2小时)

#### 1.1 保存的搜索条件Schema
**文件**: `src/modules/bead-material/search/schemas/saved-search.schema.ts`

**字段结构**:
```typescript
SavedSearch {
  _id: ObjectId
  name: string                   // 搜索条件名称
  search_params: {               // 搜索参数
    keyword?: string
    category_id?: ObjectId
    min_price?: number
    max_price?: number
    stock_status?: string
    is_active?: boolean
    properties?: Record<string, any>
    date_range?: {
      start: Date
      end: Date
    }
  }
  user_id: ObjectId              // 用户ID
  usage_count: number            // 使用次数
  last_used_at?: Date            // 最后使用时间
  is_public: boolean             // 是否公开
  tags: string[]                 // 标签
  created_at: Date               // 创建时间
  updated_at: Date               // 更新时间
}
```

**索引设计**:
- 复合索引：user_id + name
- 复合索引：user_id + usage_count
- 复合索引：is_public + usage_count
- 单字段索引：tags

#### 1.2 搜索历史Schema
**文件**: `src/modules/bead-material/search/schemas/search-history.schema.ts`

**字段结构**:
```typescript
SearchHistory {
  _id: ObjectId
  user_id: ObjectId              // 用户ID
  search_params: Record<string, any>  // 搜索参数
  result_count: number           // 搜索结果数量
  search_time: number            // 搜索耗时(ms)
  created_at: Date               // 搜索时间
}
```

### 任务2: 创建高级搜索DTO (预估时间: 2小时)

#### 2.1 高级搜索DTO验证规则
**文件**: `src/modules/bead-material/search/dto/advanced-search.dto.ts`

```typescript
export class AdvancedSearchDto extends PaginationDto {
  @IsOptional()
  @IsString({ message: '关键词必须是字符串' })
  @MaxLength(100, { message: '关键词不能超过100个字符' })
  @Transform(({ value }) => value?.trim())
  keyword?: string;

  @IsOptional()
  @IsArray({ message: '分类ID列表必须是数组' })
  @IsMongoId({ each: true, message: '分类ID格式不正确' })
  @ArrayMaxSize(50, { message: '最多只能选择50个分类' })
  category_ids?: string[];

  @IsOptional()
  @ValidateNested()
  @Type(() => PriceRangeDto)
  price_range?: PriceRangeDto;

  @IsOptional()
  @ValidateNested()
  @Type(() => StockRangeDto)
  stock_range?: StockRangeDto;

  @IsOptional()
  @IsArray({ message: '库存状态列表必须是数组' })
  @IsEnum(['normal', 'low', 'out'], { each: true, message: '库存状态不正确' })
  stock_status?: ('normal' | 'low' | 'out')[];

  @IsOptional()
  @IsBoolean({ message: '是否启用必须是布尔值' })
  @Transform(({ value }) => {
    if (typeof value === 'string') {
      return value === 'true';
    }
    return Boolean(value);
  })
  is_active?: boolean;

  @IsOptional()
  @IsObject({ message: '材料属性必须是对象' })
  properties?: Record<string, any>;

  @IsOptional()
  @ValidateNested()
  @Type(() => DateRangeDto)
  date_range?: DateRangeDto;

  @IsOptional()
  @IsArray({ message: '排序字段必须是数组' })
  @ValidateNested({ each: true })
  @Type(() => SortFieldDto)
  @ArrayMaxSize(5, { message: '最多只能设置5个排序字段' })
  sort_fields?: SortFieldDto[];

  @IsOptional()
  @IsEnum(['exact', 'fuzzy', 'wildcard'], { message: '搜索模式不正确' })
  search_mode?: 'exact' | 'fuzzy' | 'wildcard';

  @IsOptional()
  @IsArray({ message: '标签列表必须是数组' })
  @IsString({ each: true, message: '标签必须是字符串' })
  @ArrayMaxSize(20, { message: '最多只能选择20个标签' })
  tags?: string[];
}

export class PriceRangeDto {
  @IsOptional()
  @IsNumber({}, { message: '最低价格必须是数字' })
  @Min(0, { message: '最低价格不能小于0' })
  @Max(999999.99, { message: '最低价格不能大于999999.99' })
  @Type(() => Number)
  min?: number;

  @IsOptional()
  @IsNumber({}, { message: '最高价格必须是数字' })
  @Min(0, { message: '最高价格不能小于0' })
  @Max(999999.99, { message: '最高价格不能大于999999.99' })
  @Type(() => Number)
  max?: number;

  @ValidateIf((o) => o.min !== undefined && o.max !== undefined)
  @IsBoolean({ message: '价格范围验证失败' })
  @Transform(({ obj }) => {
    if (obj.min !== undefined && obj.max !== undefined) {
      return obj.min <= obj.max;
    }
    return true;
  })
  @IsTrue({ message: '最低价格不能大于最高价格' })
  _priceRangeValid?: boolean;
}

export class StockRangeDto {
  @IsOptional()
  @IsNumber({}, { message: '最小库存必须是数字' })
  @IsInt({ message: '最小库存必须是整数' })
  @Min(0, { message: '最小库存不能小于0' })
  @Max(999999, { message: '最小库存不能大于999999' })
  @Type(() => Number)
  min?: number;

  @IsOptional()
  @IsNumber({}, { message: '最大库存必须是数字' })
  @IsInt({ message: '最大库存必须是整数' })
  @Min(0, { message: '最大库存不能小于0' })
  @Max(999999, { message: '最大库存不能大于999999' })
  @Type(() => Number)
  max?: number;

  @ValidateIf((o) => o.min !== undefined && o.max !== undefined)
  @IsBoolean({ message: '库存范围验证失败' })
  @Transform(({ obj }) => {
    if (obj.min !== undefined && obj.max !== undefined) {
      return obj.min <= obj.max;
    }
    return true;
  })
  @IsTrue({ message: '最小库存不能大于最大库存' })
  _stockRangeValid?: boolean;
}

export class DateRangeDto {
  @IsOptional()
  @IsDateString({}, { message: '开始日期格式不正确' })
  start?: string;

  @IsOptional()
  @IsDateString({}, { message: '结束日期格式不正确' })
  end?: string;

  @ValidateIf((o) => o.start && o.end)
  @IsBoolean({ message: '日期范围验证失败' })
  @Transform(({ obj }) => {
    if (obj.start && obj.end) {
      return new Date(obj.start) <= new Date(obj.end);
    }
    return true;
  })
  @IsTrue({ message: '开始日期不能大于结束日期' })
  _dateRangeValid?: boolean;
}

export class SortFieldDto {
  @IsString({ message: '排序字段必须是字符串' })
  @IsEnum(['name', 'price', 'size', 'stock_quantity', 'created_at', 'updated_at'], 
    { message: '排序字段不正确' })
  field: string;

  @IsEnum(['asc', 'desc'], { message: '排序方向必须是 asc 或 desc' })
  order: 'asc' | 'desc';
}
```

#### 2.2 保存搜索DTO验证规则
```typescript
export class SaveSearchDto {
  @IsString({ message: '搜索名称必须是字符串' })
  @IsNotEmpty({ message: '搜索名称不能为空' })
  @Length(1, 50, { message: '搜索名称长度必须在1-50个字符之间' })
  @Matches(/^[\u4e00-\u9fa5a-zA-Z0-9\s\-_()（）]+$/, { 
    message: '搜索名称只能包含中文、英文、数字、空格、连字符、下划线和括号' 
  })
  @Transform(({ value }) => value?.trim())
  name: string;

  @IsOptional()
  @IsString({ message: '搜索描述必须是字符串' })
  @MaxLength(200, { message: '搜索描述不能超过200个字符' })
  @Transform(({ value }) => value?.trim() || '')
  description?: string;

  @IsObject({ message: '搜索条件必须是对象' })
  @ValidateNested()
  @Type(() => AdvancedSearchDto)
  search_params: AdvancedSearchDto;

  @IsOptional()
  @IsBoolean({ message: '是否公开必须是布尔值' })
  @Transform(({ value }) => {
    if (typeof value === 'string') {
      return value === 'true';
    }
    return Boolean(value);
  })
  is_public?: boolean;

  @IsOptional()
  @IsArray({ message: '标签列表必须是数组' })
  @IsString({ each: true, message: '标签必须是字符串' })
  @ArrayMaxSize(10, { message: '最多只能添加10个标签' })
  tags?: string[];
}
```

#### 2.3 搜索历史查询DTO验证规则
```typescript
export class SearchHistoryQueryDto extends PaginationDto {
  @IsOptional()
  @IsMongoId({ message: '用户ID格式不正确' })
  user_id?: string;

  @IsOptional()
  @IsString({ message: '关键词必须是字符串' })
  @MaxLength(100, { message: '关键词不能超过100个字符' })
  keyword?: string;

  @IsOptional()
  @ValidateNested()
  @Type(() => DateRangeDto)
  date_range?: DateRangeDto;

  @IsOptional()
  @IsEnum(['asc', 'desc'], { message: '排序方向必须是 asc 或 desc' })
  sort_order?: 'asc' | 'desc';
}
```

#### 2.4 搜索建议DTO验证规则
```typescript
export class SearchSuggestionDto {
  @IsString({ message: '关键词必须是字符串' })
  @IsNotEmpty({ message: '关键词不能为空' })
  @MaxLength(100, { message: '关键词不能超过100个字符' })
  @Transform(({ value }) => value?.trim())
  keyword: string;

  @IsOptional()
  @IsNumber({}, { message: '建议数量必须是数字' })
  @IsInt({ message: '建议数量必须是整数' })
  @Min(1, { message: '建议数量不能小于1' })
  @Max(20, { message: '建议数量不能大于20' })
  @Type(() => Number)
  limit?: number;

  @IsOptional()
  @IsArray({ message: '建议类型必须是数组' })
  @IsEnum(['material', 'category', 'property'], { each: true, message: '建议类型不正确' })
  types?: ('material' | 'category' | 'property')[];

  @IsOptional()
  @IsBoolean({ message: '包含热门搜索必须是布尔值' })
  @Transform(({ value }) => {
    if (typeof value === 'string') {
      return value === 'true';
    }
    return Boolean(value);
  })
  include_popular?: boolean;
}
```

### 任务3: 实现高级搜索服务 (预估时间: 8小时)

#### 3.1 搜索引擎服务
**文件**: `src/modules/bead-material/search/search-engine.service.ts`

**核心搜索功能**:

**多条件组合搜索**:
- `advancedSearch(searchDto)` - 高级搜索主方法
- 支持关键词全文搜索
- 支持多分类筛选
- 支持价格范围筛选
- 支持库存状态筛选
- 支持材料属性筛选
- 支持时间范围筛选

**搜索优化**:
- `buildSearchQuery(searchDto)` - 构建搜索查询
- `optimizeSearchPerformance()` - 搜索性能优化
- `handleSearchAggregation()` - 搜索聚合处理
- `calculateSearchRelevance()` - 计算搜索相关性

**全文搜索增强**:
- `fullTextSearch(keyword)` - 全文搜索
- 支持中文分词
- 支持模糊匹配
- 支持同义词搜索
- 支持搜索高亮

#### 3.2 搜索建议服务
**文件**: `src/modules/bead-material/search/search-suggestion.service.ts`

**搜索建议功能**:
- `getSearchSuggestions(keyword)` - 获取搜索建议
- `getPopularSearches()` - 获取热门搜索
- `getRelatedSearches(keyword)` - 获取相关搜索
- `updateSearchPopularity()` - 更新搜索热度

**建议算法**:
- 基于历史搜索的建议
- 基于材料名称的自动补全
- 基于分类的智能推荐
- 基于用户行为的个性化建议

#### 3.3 保存搜索服务
**文件**: `src/modules/bead-material/search/saved-search.service.ts`

**保存搜索功能**:
- `saveSearch(saveDto, userId)` - 保存搜索条件
- `getUserSavedSearches(userId)` - 获取用户保存的搜索
- `getPublicSavedSearches()` - 获取公开的搜索条件
- `updateSavedSearch(id, updateDto)` - 更新保存的搜索
- `deleteSavedSearch(id, userId)` - 删除保存的搜索
- `useSavedSearch(id, userId)` - 使用保存的搜索

**搜索条件管理**:
- 搜索条件验证
- 搜索条件优化
- 使用统计更新
- 搜索条件分享

### 任务4: 实现搜索历史服务 (预估时间: 3小时)

#### 4.1 搜索历史服务
**文件**: `src/modules/bead-material/search/search-history.service.ts`

**搜索历史功能**:
- `recordSearchHistory(searchParams, userId, resultCount, searchTime)` - 记录搜索历史
- `getUserSearchHistory(userId, queryDto)` - 获取用户搜索历史
- `getPopularSearchTerms()` - 获取热门搜索词
- `getSearchAnalytics()` - 获取搜索分析数据
- `clearSearchHistory(userId)` - 清空搜索历史

**搜索分析**:
- 搜索频率统计
- 搜索结果质量分析
- 搜索性能监控
- 用户搜索行为分析

### 任务5: 实现搜索过滤器 (预估时间: 4小时)

#### 5.1 动态过滤器服务
**文件**: `src/modules/bead-material/search/filter.service.ts`

**过滤器功能**:
- `buildDynamicFilters(searchParams)` - 构建动态过滤器
- `getAvailableFilters()` - 获取可用过滤器
- `getFilterOptions(filterType)` - 获取过滤器选项
- `validateFilterCombination()` - 验证过滤器组合

**过滤器类型**:
- 分类过滤器（支持多级分类）
- 价格范围过滤器
- 库存状态过滤器
- 材料属性过滤器
- 时间范围过滤器
- 自定义属性过滤器

#### 5.2 过滤器配置
**过滤器配置结构**:
```typescript
FilterConfig {
  type: string                   // 过滤器类型
  label: string                  // 显示标签
  field: string                  // 对应字段
  options?: Array<{              // 选项列表
    label: string
    value: any
    count?: number
  }>
  range?: {                      // 范围配置
    min: number
    max: number
    step: number
  }
  multiple: boolean              // 是否支持多选
  required: boolean              // 是否必填
}
```

### 任务6: 实现搜索控制器 (预估时间: 4小时)

#### 6.1 高级搜索控制器
**文件**: `src/modules/bead-material/search/search.controller.ts`

**API端点**:

**高级搜索接口**:
- `POST /api/bead-material/search/advanced`
- 接收高级搜索参数
- 调用搜索引擎服务
- 返回搜索结果和聚合信息

**搜索建议接口**:
- `POST /api/bead-material/search/suggestions`
- 接收关键词参数
- 返回搜索建议列表

**保存搜索接口**:
- `POST /api/bead-material/search/save`
- 保存搜索条件
- `POST /api/bead-material/search/saved-list`
- 获取保存的搜索列表

**搜索历史接口**:
- `POST /api/bead-material/search/history`
- 获取搜索历史记录

**过滤器接口**:
- `POST /api/bead-material/search/filters`
- 获取可用过滤器配置

### 任务7: 实现搜索性能优化 (预估时间: 5小时)

#### 7.1 搜索缓存服务
**文件**: `src/modules/bead-material/search/search-cache.service.ts`

**缓存功能**:
- `cacheSearchResult(searchKey, result)` - 缓存搜索结果
- `getCachedSearchResult(searchKey)` - 获取缓存的搜索结果
- `invalidateSearchCache(pattern)` - 失效搜索缓存
- `optimizeCacheStorage()` - 优化缓存存储

**缓存策略**:
- 热门搜索结果缓存
- 搜索建议缓存
- 过滤器选项缓存
- 分页结果缓存

#### 7.2 搜索索引优化
**索引优化策略**:
- 复合索引优化
- 文本索引优化
- 部分索引使用
- 索引提示优化

#### 7.3 查询优化
**查询优化方法**:
- 查询计划分析
- 聚合管道优化
- 分页查询优化
- 并行查询处理

### 任务8: 实现搜索分析服务 (预估时间: 3小时)

#### 8.1 搜索分析服务
**文件**: `src/modules/bead-material/search/search-analytics.service.ts`

**分析功能**:
- `generateSearchReport(dateRange)` - 生成搜索报告
- `getSearchTrends()` - 获取搜索趋势
- `analyzeSearchPerformance()` - 分析搜索性能
- `getSearchConversionRate()` - 获取搜索转化率

**分析指标**:
- 搜索频率统计
- 搜索结果点击率
- 搜索无结果率
- 搜索性能指标
- 用户搜索路径分析

### 任务9: 单元测试 (预估时间: 6小时)

#### 9.1 搜索引擎测试
**文件**: `src/modules/bead-material/search/search-engine.service.spec.ts`

**测试用例**:
- 基础搜索功能测试
- 多条件组合搜索测试
- 全文搜索测试
- 搜索性能测试
- 搜索结果相关性测试

#### 9.2 搜索建议测试
**文件**: `src/modules/bead-material/search/search-suggestion.service.spec.ts`

**测试用例**:
- 搜索建议生成测试
- 自动补全功能测试
- 热门搜索统计测试
- 个性化推荐测试

#### 9.3 保存搜索测试
**文件**: `src/modules/bead-material/search/saved-search.service.spec.ts`

**测试用例**:
- 搜索条件保存测试
- 搜索条件使用测试
- 搜索条件管理测试
- 权限控制测试

### 任务10: 集成测试 (预估时间: 4小时)

#### 10.1 搜索API测试
**文件**: `test/search.e2e-spec.ts`

**测试场景**:
- 完整搜索流程测试
- 搜索性能压力测试
- 搜索结果准确性测试
- 搜索缓存有效性测试

## 使用的接口规范

### 高级搜索接口
```
POST /api/bead-material/search/advanced
Body: {
  keyword?: string
  category_ids?: string[]
  price_range?: { min: number, max: number }
  stock_range?: { min: number, max: number }
  stock_status?: string
  is_active?: boolean
  properties?: Record<string, any>
  date_range?: { start: string, end: string }
  sort_fields?: Array<{ field: string, order: 'asc' | 'desc' }>
  page?: number
  page_size?: number
}
Response: {
  code: 0,
  message: "搜索成功",
  data: Array<BeadMaterial>,
  pagination: PaginationInfo,
  aggregations: {
    total_count: number,
    category_counts: Array<{ category_id: string, count: number }>,
    price_ranges: Array<{ range: string, count: number }>,
    stock_status_counts: Record<string, number>
  }
}
```

### 搜索建议接口
```
POST /api/bead-material/search/suggestions
Body: {
  keyword: string
  limit?: number
}
Response: {
  code: 0,
  message: "获取成功",
  data: {
    suggestions: Array<{
      text: string,
      type: 'material' | 'category' | 'property',
      count: number
    }>,
    popular_searches: Array<string>,
    related_searches: Array<string>
  }
}
```

### 保存搜索接口
```
POST /api/bead-material/search/save
Body: {
  name: string
  search_params: Record<string, any>
  is_public?: boolean
  tags?: string[]
}
Response: {
  code: 0,
  message: "保存成功",
  data: {
    id: string,
    name: string,
    search_params: Record<string, any>,
    usage_count: number,
    created_at: string
  }
}
```

### 获取保存的搜索接口
```
POST /api/bead-material/search/saved-list
Body: {
  page?: number
  page_size?: number
  include_public?: boolean
}
Response: {
  code: 0,
  message: "获取成功",
  data: Array<SavedSearch>,
  pagination: PaginationInfo
}
```

### 搜索历史接口
```
POST /api/bead-material/search/history
Body: {
  page?: number
  page_size?: number
  date_range?: { start: string, end: string }
}
Response: {
  code: 0,
  message: "获取成功",
  data: Array<{
    search_params: Record<string, any>,
    result_count: number,
    search_time: number,
    created_at: string
  }>,
  pagination: PaginationInfo
}
```

### 过滤器配置接口
```
POST /api/bead-material/search/filters
Body: {}
Response: {
  code: 0,
  message: "获取成功",
  data: {
    categories: Array<FilterConfig>,
    price_ranges: FilterConfig,
    stock_status: FilterConfig,
    properties: Array<FilterConfig>,
    date_ranges: FilterConfig
  }
}
```

## 验收标准

### 功能验收
1. ✅ 多条件组合搜索功能正常
2. ✅ 全文搜索结果准确
3. ✅ 搜索建议功能完整
4. ✅ 搜索条件保存和使用正常
5. ✅ 搜索历史记录完整
6. ✅ 过滤器功能正常
7. ✅ 搜索结果排序准确

### 性能验收
1. ✅ 搜索响应时间 < 500ms
2. ✅ 支持并发搜索 > 200
3. ✅ 大数据量搜索性能良好
4. ✅ 缓存命中率 > 80%
5. ✅ 索引使用效率高

### 准确性验收
1. ✅ 搜索结果相关性高
2. ✅ 过滤条件准确生效
3. ✅ 搜索统计数据准确
4. ✅ 搜索建议质量高
5. ✅ 全文搜索召回率高

## 预估总时间

**总计：41小时**

- 扩展搜索数据模型：2小时
- 创建高级搜索DTO：2小时
- 实现高级搜索服务：8小时
- 实现搜索历史服务：3小时
- 实现搜索过滤器：4小时
- 实现搜索控制器：4小时
- 实现搜索性能优化：5小时
- 实现搜索分析服务：3小时
- 单元测试：6小时
- 集成测试：4小时