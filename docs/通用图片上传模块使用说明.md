# 通用图片上传模块使用说明

## 概述

通用图片上传模块已成功解耦，现在可以为其他业务模块提供图片上传服务。该模块支持多种业务类型（材料、产品、用户、分类等），通过 `businessId` 和 `businessType` 进行图片与业务的关联。

## 模块结构

```
src/modules/upload/
├── entities/
│   └── image.entity.ts           # 通用图片实体
├── dto/
│   ├── upload-image.dto.ts       # 上传请求DTO
│   └── upload-image-response.dto.ts # 上传响应DTO
├── services/
│   └── upload-image.service.ts   # 通用图片上传服务
├── controllers/
│   └── upload-image.controller.ts # 通用图片上传控制器
├── docs/
│   └── upload-api.md             # API文档
└── upload.module.ts              # 通用图片上传模块
```

## 主要功能

### 1. 支持的业务类型
- `material` - 材料
- `product` - 产品
- `user` - 用户
- `category` - 分类

### 2. 核心功能
- 单张图片上传
- 批量图片上传（最多10张）
- 图片删除（软删除）
- 获取图片列表
- 设置主图
- 图片排序
- 图片压缩和多尺寸处理（原图、缩略图、中等尺寸）

## API 接口

### 基础路径
所有接口都在 `/api/v1/upload` 路径下

### 1. 上传单张图片
```http
POST /api/v1/upload/image
Content-Type: multipart/form-data

{
  "businessId": "64b5f8e8f123456789abcdef",
  "businessType": "material",
  "sortOrder": 1,
  "description": "图片描述",
  "alt": "Alt文本",
  "file": <binary>
}
```

### 2. 批量上传图片
```http
POST /api/v1/upload/batch-images
Content-Type: multipart/form-data

{
  "businessId": "64b5f8e8f123456789abcdef",
  "businessType": "material",
  "files": <binary[]>
}
```

### 3. 删除图片
```http
POST /api/v1/upload/delete-image

{
  "imageId": "64b5f8e8f123456789abcdef"
}
```

### 4. 获取图片列表
```http
GET /api/v1/upload/image-list?businessId=xxx&businessType=material
```

### 5. 设置主图
```http
POST /api/v1/upload/set-main-image

{
  "imageId": "64b5f8e8f123456789abcdef"
}
```

### 6. 调整图片排序
```http
POST /api/v1/upload/sort-images

{
  "businessId": "64b5f8e8f123456789abcdef",
  "businessType": "material",
  "imageIds": ["id1", "id2", "id3"]
}
```

## 如何在其他模块中使用

### 1. 导入模块
在你的业务模块中导入 `UploadModule`：

```typescript
import { UploadModule } from '../upload/upload.module';

@Module({
  imports: [
    // ... 其他导入
    UploadModule,
  ],
  // ...
})
export class YourBusinessModule {}
```

### 2. 注入服务
在你的业务服务中注入 `UploadImageService`：

```typescript
import { UploadImageService } from '../upload/services/upload-image.service';
import { BusinessType } from '../upload/dto/upload-image.dto';

@Injectable()
export class YourBusinessService {
  constructor(
    private readonly uploadImageService: UploadImageService,
  ) {}

  async getProductImages(productId: string) {
    return await this.uploadImageService.getImagesByBusiness(
      productId,
      BusinessType.PRODUCT
    );
  }

  async getProductMainImage(productId: string) {
    return await this.uploadImageService.getMainImage(
      productId,
      BusinessType.PRODUCT
    );
  }
}
```

### 3. 创建适配器服务（推荐）
为了保持接口兼容性，建议创建适配器服务：

```typescript
@Injectable()
export class ProductImageAdapterService {
  constructor(private readonly uploadImageService: UploadImageService) {}

  async uploadImage(file: Express.Multer.File, body: ProductUploadImageDto, userId: string) {
    return await this.uploadImageService.uploadImage(
      file,
      {
        businessId: body.productId,
        businessType: BusinessType.PRODUCT,
        sortOrder: body.sortOrder,
        description: body.description,
        alt: body.alt,
        file,
      },
      userId,
    );
  }
  
  // ... 其他方法
}
```

## 材料模块的兼容性

材料模块已经通过 `MaterialImageAdapterService` 适配器保持了原有接口的兼容性，现有的前端代码无需修改即可继续使用：

- `/upload/image` - 仍然可以使用 `materialId` 参数
- `/upload/batch-images` - 仍然可以使用 `materialId` 参数
- 其他接口保持不变

## 数据迁移

如果需要将现有的材料图片数据迁移到新的通用图片集合，请运行：

```bash
node scripts/migrate-material-images.js
```

该脚本会将 `material_images` 集合中的数据迁移到 `images` 集合，并设置正确的 `businessType` 为 `material`。

## 文件存储结构

图片文件按以下结构存储：
```
uploads/
├── material/          # 材料图片
│   └── 20240101/      # 按日期分组
│       └── materialId/
│           ├── IMG001.jpg       # 原图
│           ├── thumb_IMG001.jpg # 缩略图 (150x150)
│           └── medium_IMG001.jpg # 中等尺寸 (500x500)
├── product/           # 产品图片
├── user/              # 用户头像
└── category/          # 分类图片
```

## 特性

- **多业务支持**: 通过 `businessType` 支持不同业务模块
- **图片处理**: 自动生成缩略图和中等尺寸图
- **软删除**: 删除图片时不会立即删除文件，便于恢复
- **排序支持**: 支持图片自定义排序
- **主图设置**: 每个业务实体可以设置一张主图
- **批量操作**: 支持批量上传，最多10张
- **类型验证**: 仅支持 JPG、PNG、WEBP 格式
- **大小限制**: 单文件最大 5MB

## 注意事项

1. 确保安装了必要的依赖：`@nestjs/platform-express`、`multer`、`@types/multer`、`sharp`
2. 确保 `uploads` 目录有写权限
3. 在生产环境中建议配置文件存储到云服务（如阿里云OSS、AWS S3等）
4. 图片URL应该通过静态文件服务提供访问